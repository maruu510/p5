<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lector de Códigos QR - Gestión de Paquetes</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
--primary: #6c5ce7;
--primary-dark: #5b4cc7;
--primary-light: #e9e7fd;
--secondary: #2c3e50;
--accent: #e67e22;
--accent-dark: #d35400;
--accent-light: #f9e7dd;
--light: #f8f9fa;
--dark: #212529;
--gray: #6c757d;
--gray-light: #e9ecef;
--gray-50: #f8f9fa;
--gray-100: #f1f5f9;
--gray-200: #e2e8f0;
--gray-300: #cbd5e1;
--gray-700: #334155;
--danger: #c0392b;
--warning: #f39c12;
--info: #3498db;
--success: #27ae60;
--shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
--shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
--shadow-md: 0 10px 15px rgba(0, 0, 0, 0.1);
--radius-sm: 0.375rem;
--radius: 0.5rem;
--radius-md: 0.75rem;
--radius-lg: 1rem;
 }
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
 }
html, body {
height: 100%;
width: 100%;
overflow-x: hidden;
 }
body {
background-color: #f5f7fb;
color: var(--dark);
display: flex;
min-height: 100vh;
 }
/* Sidebar styles */
.sidebar {
width: 250px;
background-color: #fff;
box-shadow: var(--shadow);
transition: all 0.3s ease;
z-index: 1000;
 }
.sidebar-header {
padding: 20px;
border-bottom: 1px solid var(--gray-light);
display: flex;
align-items: center;
justify-content: center;
 }
.logo {
font-size: 1.3rem;
font-weight: bold;
color: var(--primary);
display: flex;
align-items: center;
gap: 8px;
text-decoration: none;
 }
.logo img {
height: 40px;
width: auto;
object-fit: contain;
 }
.nav-menu {
list-style: none;
padding: 20px 0;
 }
.nav-item {
padding: 12px 20px;
display: flex;
align-items: center;
gap: 10px;
color: var(--gray);
font-weight: 500;
cursor: pointer;
transition: all 0.3s ease;
margin-bottom: 5px;
 }
.nav-item:hover {
background-color: rgba(170, 110, 239, 0.1);
color: var(--primary);
 }
.nav-item.active {
background-color: rgba(109, 43, 239, 0.15);
color: var(--primary);
border-left: 3px solid var(--primary);
 }
.nav-item i {
width: 20px;
text-align: center;
 }
/* Main content styles */
.main-content {
flex: 1;
padding: 20px;
background-color: #f3eefb;
transition: all 0.3s ease;
 }
.header {
display: flex;
justify-content: space-between;
align-items: center;
padding: 15px 0;
margin-bottom: 30px;
 }
.page-title {
font-size: 1.5rem;
font-weight: 600;
color: var(--dark);
 }
.card {
background-color: #fff;
border-radius: 10px;
box-shadow: var(--shadow);
margin-bottom: 20px;
overflow: hidden;
 }
.card-header {
padding: 15px 20px;
border-bottom: 1px solid var(--gray-light);
font-weight: 600;
display: flex;
justify-content: space-between;
align-items: center;
 }
.card-body {
padding: 20px;
 }
.btn {
display: inline-flex;
align-items: center;
gap: 8px;
padding: 8px 16px;
border-radius: 6px;
font-weight: 500;
cursor: pointer;
transition: all 0.3s ease;
border: none;
font-size: 0.9rem;
text-decoration: none;
 }
.btn-primary {
background-color: var(--primary);
color: white;
 }
.btn-primary:hover {
background-color: var(--primary-dark);
transform: translateY(-2px);
box-shadow: var(--shadow-sm);
 }
.btn-accent {
background-color: var(--accent);
color: white;
 }
.btn-accent:hover {
background-color: var(--primary-dark);
transform: translateY(-2px);
box-shadow: var(--shadow-sm);
 }
.btn-gray {
background-color: var(--gray);
color: white;
 }
.btn-gray:hover {
background-color: var(--dark);
 }
.btn-outline {
background-color: transparent;
border: 1px solid var(--gray-300);
color: var(--gray-700);
 }
.btn-outline:hover {
background-color: var(--gray-50);
border-color: var(--gray-700);
 }
.btn-success {
background-color: var(--success);
color: white;
 }
.btn-success:hover {
background-color: #145a32;
 }
.btn-danger {
background-color: var(--danger);
color: white;
 }
.btn-danger:hover {
background-color: #a93226;
 }
/* QR Scanner specific styles */
.qr-container {
display: flex;
flex-direction: column;
align-items: center;
gap: 20px;
max-width: 600px;
margin: 0 auto;
 }
.scanner-container {
width: 100%;
max-width: 400px;
aspect-ratio: 1/1;
position: relative;
overflow: hidden;
border-radius: 10px;
box-shadow: var(--shadow-md);
border: 2px solid var(--primary);
margin: 0 auto;
 }
#qr-video {
width: 100%;
height: 100%;
object-fit: cover;
 }
.scanner-overlay {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
background: rgba(0, 0, 0, 0.1);
pointer-events: none;
 }
.scanner-corner {
position: absolute;
width: 20px;
height: 20px;
border-color: var(--primary);
border-width: 3px;
 }
.corner-top-left {
top: 15px;
left: 15px;
border-left-style: solid;
border-top-style: solid;
 }
.corner-top-right {
top: 15px;
right: 15px;
border-right-style: solid;
border-top-style: solid;
 }
.corner-bottom-left {
bottom: 15px;
left: 15px;
border-left-style: solid;
border-bottom-style: solid;
 }
.corner-bottom-right {
bottom: 15px;
right: 15px;
border-right-style: solid;
border-bottom-style: solid;
 }
.scanner-line {
position: absolute;
height: 2px;
width: 80%;
background: linear-gradient(90deg, transparent 0%, var(--primary) 50%, transparent 100%);
top: 50%;
animation: scan 2s linear infinite;
 }
@keyframes scan {
 0% {
transform: translateY(-80px);
 }
 50% {
transform: translateY(80px);
 }
 100% {
transform: translateY(-80px);
 }
 }
.scanner-control {
display: flex;
justify-content: center;
gap: 10px;
margin-top: 20px;
flex-wrap: wrap;
 }
.info-box {
background-color: var(--primary-light);
border-left: 4px solid var(--primary);
padding: 15px;
border-radius: 6px;
margin-bottom: 20px;
 }
.info-box h3 {
display: flex;
align-items: center;
gap: 8px;
font-size: 1rem;
margin-bottom: 8px;
color: var(--primary-dark);
font-weight: 600;
 }
.info-box p {
color: var(--dark);
font-size: 0.9rem;
line-height: 1.5;
 }
.manual-entry {
width: 100%;
margin-bottom: 20px;
 }
#manual-code {
width: 100%;
padding: 10px 15px;
border: 1px solid var(--gray-300);
border-radius: 6px;
margin-bottom: 10px;
font-size: 1rem;
 }
#manual-code:focus {
outline: none;
border-color: var(--primary);
box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
 }
.result-container {
background-color: var(--gray-50);
border: 1px solid var(--gray-200);
border-radius: 10px;
padding: 20px;
width: 100%;
max-width: 600px;
margin: 20px auto;
display: none;
 }
.result-container.active {
display: block;
 }
.result-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 15px;
padding-bottom: 10px;
border-bottom: 1px solid var(--gray-200);
 }
.result-header h3 {
font-size: 1.1rem;
font-weight: 600;
color: var(--dark);
 }
.result-content {
font-size: 0.95rem;
line-height: 1.6;
 }
.result-content p {
margin-bottom: 8px;
padding: 5px 0;
border-bottom: 1px solid var(--gray-100);
 }
.result-content p:last-child {
border-bottom: none;
margin-bottom: 0;
 }
.result-actions {
display: flex;
justify-content: space-between;
margin-top: 15px;
padding-top: 15px;
border-top: 1px solid var(--gray-200);
gap: 10px;
 }
.notification {
position: fixed;
bottom: 20px;
right: 20px;
padding: 12px 20px;
border-radius: 6px;
background-color: #e3f8e8;
color: var(--success);
display: flex;
align-items: center;
gap: 10px;
box-shadow: var(--shadow);
opacity: 0;
transform: translateY(10px);
transition: all 0.3s ease;
z-index: 1000;
max-width: 90%;
 }
.notification.show {
opacity: 1;
transform: translateY(0);
 }
.notification.error {
background-color: rgba(192, 57, 43, 0.1);
color: var(--danger);
 }
.notification.warning {
background-color: rgba(243, 156, 18, 0.1);
color: var(--warning);
 }
/* Status indicators in results */
.status-badge {
padding: 4px 8px;
border-radius: 12px;
font-size: 0.75rem;
font-weight: 600;
text-transform: uppercase;
 }
.status-pending {
background-color: rgba(243, 156, 18, 0.15);
color: var(--warning);
 }
.status-delivered {
background-color: rgba(39, 174, 96, 0.15);
color: var(--success);
 }
.package-found {
background-color: rgba(39, 174, 96, 0.1);
border-left: 4px solid var(--success);
padding: 15px;
border-radius: 6px;
margin-bottom: 15px;
 }
.package-not-found {
background-color: rgba(192, 57, 43, 0.1);
border-left: 4px solid var(--danger);
padding: 15px;
border-radius: 6px;
margin-bottom: 15px;
 }

.debug-info {
background-color: var(--info-light);
border: 1px solid var(--info);
border-radius: 6px;
padding: 10px;
margin: 10px 0;
font-family: 'Courier New', monospace;
font-size: 0.8rem;
white-space: pre-wrap;
}

/* Responsive styles */
@media (max-width: 992px) {
.qr-container {
max-width: 100%;
 }
 }
@media (max-width: 768px) {
.sidebar {
width: 70px;
 }
.sidebar .logo span,
.sidebar .nav-item span {
display: none;
 }
.sidebar .nav-item {
justify-content: center;
padding: 15px 0;
 }
.sidebar .nav-item i {
margin-right: 0;
 }
.sidebar .sidebar-header {
padding: 15px 0;
 }
.sidebar .logo {
justify-content: center;
 }
.sidebar .logo img {
height: 34px;
 }
.main-content {
padding: 15px;
 }
.header {
flex-direction: column;
align-items: flex-start;
gap: 15px;
 }
.scanner-container {
max-width: 100%;
 }
.scanner-control {
flex-direction: column;
width: 100%;
 }
.btn {
width: 100%;
 }
.result-actions {
flex-direction: column;
gap: 10px;
 }
.result-actions .btn {
width: 100%;
 }
 }
@media (max-width: 576px) {
.main-content {
padding: 10px;
 }
.card {
border-radius: 8px;
 }
.card-header, .card-body {
padding: 15px;
 }
.scanner-container {
aspect-ratio: 1/1;
 }
.scanner-corner {
width: 15px;
height: 15px;
 }
@keyframes scan {
 0% {
transform: translateY(-60px);
 }
 50% {
transform: translateY(60px);
 }
 100% {
transform: translateY(-60px);
 }
 }
 }
</style>
</head>
<body>
<!-- Sidebar / Menú Lateral -->
<div class="sidebar">
<div class="sidebar-header">
<a href="dashboard.html" class="logo">
<img src="./images/favicon1.svg" alt="Logo Encomiendas">
<span>PackTrack</span>
</a>
</div>
<ul class="nav-menu">
<li class="nav-item" onclick="window.location.href='dashboard.html'">
<i class="fas fa-th-large"></i>
<span>Dashboard</span>
</li>
<li class="nav-item" onclick="window.location.href='registerPackage.html'">
<i class="fas fa-plus-square"></i>
<span>Registrar Paquete</span>
</li>
<li class="nav-item" onclick="window.location.href='listPackages.html'">
<i class="fas fa-list"></i>
<span>Lista de Paquetes</span>
</li>
<li class="nav-item" onclick="window.location.href='departaments.html'">
<i class="fas fa-building"></i>
<span>Departamentos</span>
</li>
<li class="nav-item active" onclick="window.location.href='codigoqr.html'">
<i class="fas fa-qrcode"></i>
<span>Lector QR</span>
</li>
<li class="nav-item" onclick="window.location.href='notificaciones.html'">
<i class="fas fa-bell"></i>
<span>Notificaciones</span>
</li>
<li class="nav-item" onclick="window.location.href='configuracion.html'">
<i class="fas fa-cog"></i>
<span>Configuración</span>
</li>
<li class="nav-item" onclick="logout()" style="margin-top: 50px; color: #e74c3c;">
<i class="fas fa-sign-out-alt"></i>
<span>Cerrar Sesión</span>
</li>
</ul>
</div>
<!-- Contenido Principal -->
<div class="main-content">
<div class="header">
<h1 class="page-title">Lector de Códigos QR</h1>
</div>
<div class="card">
<div class="card-header">
 Escanear Código QR de Paquete
</div>
<div class="card-body">
<div class="info-box">
<h3><i class="fas fa-info-circle"></i> Instrucciones</h3>
<p>Apunte la cámara hacia un código QR para escanear y procesar la información del paquete. Asegúrese de que el código QR esté bien iluminado y centrado en el recuadro. Si no puede acceder a la cámara, use la opción para ingresar el código manualmente.</p>
</div>
<!-- Opción de entrada manual -->
<div class="manual-entry">
<button id="toggle-manual" class="btn btn-outline" style="margin-bottom: 15px;">
<i class="fas fa-keyboard"></i>
<span>Ingresar código manualmente</span>
</button>
<div id="manual-form" style="display: none; margin-bottom: 20px;">
<div class="card" style="margin-bottom: 0;">
<div class="card-header">Ingreso Manual de Código</div>
<div class="card-body">
<input type="text" id="manual-code" placeholder="Ingrese el código del paquete (Ej: PKG-101-20241122)">
<div style="display: flex; gap: 10px;">
<button id="process-manual" class="btn btn-primary">
<i class="fas fa-check"></i>
<span>Procesar</span>
</button>
<button id="cancel-manual" class="btn btn-outline">
<i class="fas fa-times"></i>
<span>Cancelar</span>
</button>
</div>
</div>
</div>
</div>
</div>
<div class="qr-container">
<div class="scanner-container">
<video id="qr-video" playsinline></video>
<div class="scanner-overlay">
<div class="scanner-line"></div>
<div class="scanner-corner corner-top-left"></div>
<div class="scanner-corner corner-top-right"></div>
<div class="scanner-corner corner-bottom-left"></div>
<div class="scanner-corner corner-bottom-right"></div>
</div>
</div>
<div class="scanner-control">
<button id="start-button" class="btn btn-primary">
<i class="fas fa-play"></i>
<span>Iniciar Escáner</span>
</button>
<button id="stop-button" class="btn btn-outline" style="display: none;">
<i class="fas fa-stop"></i>
<span>Detener</span>
</button>
<button id="switch-camera" class="btn btn-outline">
<i class="fas fa-sync-alt"></i>
<span>Cambiar Cámara</span>
</button>
                <button id="debug-toggle" class="btn btn-gray">
<i class="fas fa-bug"></i>
<span>Debug</span>
</button>
<button id="test-codes" class="btn btn-accent">
<i class="fas fa-vial"></i>
<span>Test</span>
</button>
</div>
<p style="text-align: center; margin-top: 10px; color: var(--gray); font-size: 0.9rem;">
 Si tiene problemas, asegúrese de permitir el acceso a la cámara y que el código QR esté bien iluminado.
</p>
</div>
<!-- Contenedor de resultados -->
<div id="result-container" class="result-container">
<div class="result-header">
<h3><i class="fas fa-check-circle"></i> Resultado del Escaneo</h3>
<button id="close-result" class="btn btn-outline" style="padding: 5px 10px;">
<i class="fas fa-times"></i>
</button>
</div>
<div id="result-content" class="result-content">
<!-- El resultado del escaneo se mostrará aquí -->
</div>
<div class="result-actions">
<button id="process-btn" class="btn btn-success" style="display: none;">
<i class="fas fa-check"></i>
<span>Marcar como Entregado</span>
</button>
<button id="scan-again" class="btn btn-outline">
<i class="fas fa-redo"></i>
<span>Escanear Otro</span>
</button>
</div>
</div>
</div>
</div>
</div>
<!-- Notificación -->
<div id="notification" class="notification">
<i class="fas fa-check-circle"></i>
<span id="notification-message">Paquete procesado correctamente</span>
</div>
<!-- Cargar jsQR con múltiples fallbacks -->
<script>
// Función para cargar jsQR con múltiples CDN como respaldo
function loadJsQR() {
return new Promise((resolve, reject) => {
// Lista de CDNs a probar en orden
const cdnUrls = [
'https://unpkg.com/jsqr@1.4.0/dist/jsQR.js',
'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js',
'https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js'
];

let currentIndex = 0;

function tryLoadScript() {
if (currentIndex >= cdnUrls.length) {
reject(new Error('No se pudo cargar jsQR desde ningún CDN'));
return;
}

const script = document.createElement('script');
script.src = cdnUrls[currentIndex];
script.onload = () => {
console.log(`jsQR cargado exitosamente desde: ${cdnUrls[currentIndex]}`);
resolve();
};
script.onerror = () => {
console.warn(`Fallo al cargar desde: ${cdnUrls[currentIndex]}`);
currentIndex++;
tryLoadScript();
};
document.head.appendChild(script);
}

tryLoadScript();
});
}

// Iniciar la aplicación después de cargar jsQR
loadJsQR().then(() => {
console.log('jsQR cargado correctamente, iniciando aplicación...');
initializeQRReader();
}).catch(error => {
console.error('Error crítico:', error);
document.body.innerHTML = `
<div style="padding: 20px; text-align: center; font-family: Arial, sans-serif;">
<h2 style="color: #e74c3c;">Error al cargar la biblioteca QR</h2>
<p>No se pudo cargar la biblioteca jsQR necesaria para escanear códigos QR.</p>
<p><strong>Posibles soluciones:</strong></p>
<ul style="text-align: left; display: inline-block;">
<li>Verifique su conexión a internet</li>
<li>Recargue la página (F5)</li>
<li>Intente más tarde</li>
<li>Contacte al administrador si el problema persiste</li>
</ul>
<button onclick="location.reload()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px;">
Reintentar
</button>
</div>
`;
});

function initializeQRReader() {
// Verificar autenticación
const authToken = localStorage.getItem('authToken');
const isLoggedIn = localStorage.getItem('isLoggedIn');
if (!authToken || !isLoggedIn) {
window.location.href = 'login.html';
return;
}

// Variables para debugging
let debugMode = false;

// Elementos del DOM
const video = document.getElementById('qr-video');
const startButton = document.getElementById('start-button');
const stopButton = document.getElementById('stop-button');
const switchCameraButton = document.getElementById('switch-camera');
const resultContainer = document.getElementById('result-container');
const resultContent = document.getElementById('result-content');
const closeResultButton = document.getElementById('close-result');
const scanAgainButton = document.getElementById('scan-again');
const processButton = document.getElementById('process-btn');
const notification = document.getElementById('notification');
const notificationMessage = document.getElementById('notification-message');
const debugToggle = document.getElementById('debug-toggle');
const testCodesBtn = document.getElementById('test-codes');

// Elementos para ingreso manual
const toggleManualButton = document.getElementById('toggle-manual');
const manualForm = document.getElementById('manual-form');
const manualCodeInput = document.getElementById('manual-code');
const processManualButton = document.getElementById('process-manual');
const cancelManualButton = document.getElementById('cancel-manual');

// Variables para gestionar el escáner
let scanner = null;
let canvasElement = document.createElement('canvas');
let canvas = canvasElement.getContext('2d');
let scanning = false;
let cameraId = null;
let cameraList = [];
let currentCameraIndex = 0;
let cameraPermissionGranted = false;
let currentPackageData = null;

// FUNCIÓN COMPLETAMENTE REESCRITA: Obtener todos los paquetes con logging detallado
function getAllPackages() {
try {
console.log("=== OBTENIENDO TODOS LOS PAQUETES PARA QR ===");
        
let allPackages = [];
        
// Verificar en múltiples ubicaciones de localStorage
const sources = ['paquetesPrueba', 'packages'];
        
sources.forEach(source => {
const data = localStorage.getItem(source);
if (data) {
try {
const packages = JSON.parse(data);
if (Array.isArray(packages)) {
console.log(`Encontrados ${packages.length} paquetes en '${source}'`);
                    
// Agregar todos los paquetes, evitando duplicados
packages.forEach(pkg => {
// Verificar múltiples formas de identificar paquetes
const packageId = pkg.id || pkg.qr_code || pkg.package_id;
const exists = allPackages.some(existing => {
const existingId = existing.id || existing.qr_code || existing.package_id;
return existingId && packageId && existingId === packageId;
});
                        
if (!exists && packageId) {
// Normalizar el formato del paquete
const normalizedPkg = {
...pkg,
id: packageId, // Asegurar que tenga ID
qr_code: pkg.qr_code || packageId, // Asegurar que tenga qr_code
search_terms: [
packageId,
pkg.qr_code,
pkg.package_id,
pkg.id
].filter(Boolean) // Términos de búsqueda múltiples
};
allPackages.push(normalizedPkg);
console.log(`Agregado paquete: ${packageId}`);
}
});
} else {
console.log(`'${source}' no contiene un array válido`);
}
} catch (e) {
console.error(`Error al parsear '${source}':`, e);
}
} else {
console.log(`No se encontraron datos en '${source}'`);
}
});
        
console.log(`Total de paquetes únicos encontrados: ${allPackages.length}`);
        
if (debugMode) {
console.log("Detalles de todos los paquetes:");
allPackages.forEach((pkg, index) => {
console.log(`${index + 1}. ID: ${pkg.id}, QR: ${pkg.qr_code}, Depto: ${pkg.apartment_number}, Estado: ${pkg.status}`);
});
}
        
return allPackages;
} catch (error) {
console.error('Error crítico al cargar paquetes:', error);
return [];
}
}

// FUNCIÓN MEJORADA: Actualizar estado del paquete con logging detallado
function updatePackageStatus(packageId, newStatus) {
try {
console.log(`=== ACTUALIZANDO ESTADO DE PAQUETE ===`);
console.log(`ID del paquete: "${packageId}"`);
console.log(`Nuevo estado: "${newStatus}"`);
        
const packages = getAllPackages();
console.log(`Total de paquetes en sistema: ${packages.length}`);
        
const packageIndex = packages.findIndex(pkg => 
(pkg.id && pkg.id === packageId) ||
(pkg.qr_code && pkg.qr_code === packageId)
);
        
if (packageIndex === -1) {
console.error('Paquete no encontrado para actualizar');
console.log('IDs disponibles:', packages.map(p => p.id || p.qr_code));
return false;
}
        
const originalPackage = packages[packageIndex];
console.log('Paquete original encontrado:', {
id: originalPackage.id,
qr_code: originalPackage.qr_code,
apartment_number: originalPackage.apartment_number,
status: originalPackage.status
});
        
// Actualizar el estado y metadatos
const updatedPackage = {
...originalPackage,
status: newStatus,
delivered_date: new Date().toISOString(),
delivery_time: new Date().toLocaleString('es-ES'),
updated_at: new Date().toISOString(),
delivered_by_qr: true // Marcar que fue entregado via QR
};
        
packages[packageIndex] = updatedPackage;
        
console.log('Paquete actualizado:', {
id: updatedPackage.id,
status: updatedPackage.status,
delivered_date: updatedPackage.delivered_date
});
        
// Guardar en múltiples ubicaciones para máxima compatibilidad
const sources = ['paquetesPrueba', 'packages'];
let saveSuccess = true;
        
sources.forEach(source => {
try {
localStorage.setItem(source, JSON.stringify(packages));
console.log(`Guardado exitoso en '${source}'`);
} catch (saveError) {
console.error(`Error al guardar en '${source}':`, saveError);
saveSuccess = false;
}
});
        
if (saveSuccess) {
console.log('Actualización completada exitosamente');
// Sincronizar datos después de la actualización
setTimeout(() => {
syncPackageData();
}, 100);
} else {
console.error('Algunos errores durante el guardado');
}
        
return saveSuccess;
} catch (error) {
console.error('Error crítico al actualizar paquete:', error);
return false;
}
}

// FUNCIÓN COMPLETAMENTE REESCRITA: Buscar paquete por código con múltiples estrategias
function findPackageByCode(code) {
console.log(`=== BÚSQUEDA INTENSIVA DE PAQUETE ===`);
console.log(`Código a buscar: "${code}"`);
console.log(`Longitud del código: ${code.length}`);
console.log(`Tipo: ${typeof code}`);
    
const packages = getAllPackages();
console.log(`Total de paquetes disponibles para búsqueda: ${packages.length}`);
    
if (packages.length === 0) {
console.log("No hay paquetes disponibles para buscar");
return null;
}
    
// Limpiar el código de búsqueda
const cleanCode = code.trim();
console.log(`Código limpio: "${cleanCode}"`);
    
// ESTRATEGIA 1: Búsqueda exacta por ID principal
console.log("ESTRATEGIA 1: Búsqueda exacta por ID...");
let foundPackage = packages.find(pkg => {
const match = pkg.id === cleanCode;
if (match) {
console.log(`ENCONTRADO por ID exacto! Paquete:`, pkg);
}
return match;
});
    
if (foundPackage) return foundPackage;
    
// ESTRATEGIA 2: Búsqueda exacta por qr_code
console.log("ESTRATEGIA 2: Búsqueda exacta por qr_code...");
foundPackage = packages.find(pkg => {
const match = pkg.qr_code === cleanCode;
if (match) {
console.log(`ENCONTRADO por qr_code exacto! Paquete:`, pkg);
}
return match;
});
    
if (foundPackage) return foundPackage;
    
// ESTRATEGIA 3: Búsqueda en términos de búsqueda múltiples
console.log("ESTRATEGIA 3: Búsqueda en términos múltiples...");
foundPackage = packages.find(pkg => {
if (pkg.search_terms && Array.isArray(pkg.search_terms)) {
const match = pkg.search_terms.some(term => term === cleanCode);
if (match) {
console.log(`ENCONTRADO en términos de búsqueda! Paquete:`, pkg);
}
return match;
}
return false;
});
    
if (foundPackage) return foundPackage;
    
// ESTRATEGIA 4: Búsqueda por formato PKG específico
if (cleanCode.startsWith('PKG-')) {
console.log("ESTRATEGIA 4: Código PKG detectado, analizando formato...");
const parts = cleanCode.split('-');
console.log(`Partes del código PKG: [${parts.join(', ')}]`);
        
if (parts.length >= 2) {
const deptNumber = parts[1];
console.log(`Número de departamento extraído: ${deptNumber}`);
            
// Buscar por departamento y estado pendiente
foundPackage = packages.find(pkg => {
const deptMatch = pkg.apartment_number === deptNumber;
const statusMatch = pkg.status === 'pendiente';
const combinedMatch = deptMatch && statusMatch;
                
if (combinedMatch) {
console.log(`ENCONTRADO por departamento y estado! Paquete:`, pkg);
} else if (deptMatch) {
console.log(`Encontrado por departamento pero estado: ${pkg.status}`);
}
                
return combinedMatch;
});
            
if (!foundPackage) {
// Intentar buscar cualquier paquete en ese departamento
foundPackage = packages.find(pkg => pkg.apartment_number === deptNumber);
if (foundPackage) {
console.log(`Encontrado paquete en departamento pero con estado: ${foundPackage.status}`);
}
}
        
// ESTRATEGIA 4.5: Buscar por coincidencia exacta del código completo
if (!foundPackage) {
console.log("ESTRATEGIA 4.5: Búsqueda por código PKG completo...");
foundPackage = packages.find(pkg => {
const match = (pkg.id && pkg.id.includes(cleanCode)) || 
                             (pkg.qr_code && pkg.qr_code.includes(cleanCode));
if (match) {
console.log(`ENCONTRADO por coincidencia de código completo! Paquete:`, pkg);
}
return match;
});
}
}
}
    
// ESTRATEGIA 5: Búsqueda parcial como último recurso
if (!foundPackage) {
console.log("ESTRATEGIA 5: Búsqueda parcial (último recurso)...");
foundPackage = packages.find(pkg => {
const idMatch = pkg.id && pkg.id.toString().includes(cleanCode);
const qrMatch = pkg.qr_code && pkg.qr_code.toString().includes(cleanCode);
const match = idMatch || qrMatch;
            
if (match) {
console.log(`Encontrado por coincidencia parcial: ${idMatch ? 'ID' : 'QR'}`);
console.log(`Paquete:`, pkg);
}
            
return match;
});
}
    
// Resultado final
if (foundPackage) {
console.log(`PAQUETE ENCONTRADO EXITOSAMENTE!`);
console.log(`ID del paquete: ${foundPackage.id}`);
console.log(`QR Code: ${foundPackage.qr_code}`);
console.log(`Departamento: ${foundPackage.apartment_number}`);
console.log(`Estado: ${foundPackage.status}`);
} else {
console.log(`PAQUETE NO ENCONTRADO`);
console.log(`Código buscado: "${cleanCode}"`);
        
if (debugMode) {
console.log("Códigos disponibles en el sistema:");
packages.forEach((pkg, index) => {
console.log(`${index + 1}. ID: "${pkg.id}" | QR: "${pkg.qr_code}" | Depto: ${pkg.apartment_number}`);
});
        
console.log("Posibles coincidencias parciales:");
packages.forEach(pkg => {
const idSimilar = pkg.id && pkg.id.toString().toLowerCase().includes(cleanCode.toLowerCase());
const qrSimilar = pkg.qr_code && pkg.qr_code.toString().toLowerCase().includes(cleanCode.toLowerCase());
if (idSimilar || qrSimilar) {
console.log(`Posible: ${pkg.id} (${idSimilar ? 'ID' : 'QR'} similar)`);
}
});
}
}
    
return foundPackage;
}

// Función para mostrar notificaciones
function showNotification(message, type = 'success') {
console.log(`Notificación [${type}]: ${message}`);
notificationMessage.textContent = message;
notification.className = 'notification show';
if (type === 'error') {
notification.classList.add('error');
} else if (type === 'warning') {
notification.classList.add('warning');
}
setTimeout(() => {
notification.classList.remove('show');
setTimeout(() => {
notification.className = 'notification';
}, 300);
}, 3000);
}

// Función para solicitar permisos de cámara
async function requestCameraPermission() {
try {
showNotification('Solicitando acceso a la cámara...');
const stream = await navigator.mediaDevices.getUserMedia({ video: true });
// Detener el stream temporal
stream.getTracks().forEach(track => track.stop());
cameraPermissionGranted = true;
console.log("Permiso de cámara concedido");
return true;
} catch (error) {
console.error('Permiso de cámara denegado:', error);
showNotification('Permiso de cámara denegado. Use la entrada manual de códigos.', 'error');
toggleManualEntry(true);
return false;
}
}

// FUNCIÓN MEJORADA: Iniciar la cámara con mejor configuración
async function startCamera() {
try {
// Verificar que jsQR esté disponible
if (typeof jsQR === 'undefined') {
console.error('jsQR no está disponible, no se puede iniciar el escáner');
showNotification('Error: Biblioteca QR no disponible. Recargue la página.', 'error');
toggleManualEntry(true);
return;
}

if (!cameraPermissionGranted) {
const permissionGranted = await requestCameraPermission();
if (!permissionGranted) return;
}

toggleManualEntry(false);
const devices = await navigator.mediaDevices.enumerateDevices();
cameraList = devices.filter(device => device.kind === 'videoinput');

if (cameraList.length === 0) {
throw new Error('No se encontraron cámaras disponibles');
}

cameraId = cameraList[currentCameraIndex].deviceId;

// Configuración mejorada para mejor lectura de QR
const constraints = {
video: {
deviceId: cameraId ? { exact: cameraId } : undefined,
facingMode: cameraList.length > 1 ? 'environment' : undefined,
width: { ideal: 1920, min: 640 },
height: { ideal: 1080, min: 480 },
frameRate: { ideal: 30, min: 15 }
}
};

console.log("Configuración de cámara:", constraints);

const stream = await navigator.mediaDevices.getUserMedia(constraints);
video.srcObject = stream;
video.setAttribute('playsinline', true);
await video.play();

scanning = true;
requestAnimationFrame(tick);

startButton.style.display = 'none';
stopButton.style.display = 'inline-flex';
switchCameraButton.disabled = cameraList.length <= 1;

showNotification('Cámara activada. Apunte al código QR');
console.log("Cámara iniciada exitosamente");
} catch (error) {
console.error('Error al acceder a la cámara:', error);
showNotification('Error al acceder a la cámara: ' + error.message, 'error');
toggleManualEntry(true);
}
}

// Función para detener la cámara
function stopCamera() {
scanning = false;
if (video.srcObject) {
const tracks = video.srcObject.getTracks();
tracks.forEach(track => track.stop());
video.srcObject = null;
}
startButton.style.display = 'inline-flex';
stopButton.style.display = 'none';
console.log("Cámara detenida");
}

// Función para cambiar de cámara
function switchCamera() {
if (cameraList.length <= 1) return;
currentCameraIndex = (currentCameraIndex + 1) % cameraList.length;
console.log(`Cambiando a cámara ${currentCameraIndex + 1} de ${cameraList.length}`);
stopCamera();
startCamera();
}

// FUNCIÓN COMPLETAMENTE OPTIMIZADA: Procesamiento de frames con máxima efectividad
function tick() {
if (!scanning) return;

// Verificar que jsQR esté disponible
if (typeof jsQR === 'undefined') {
console.error('jsQR no está disponible, deteniendo escaneo');
stopCamera();
showNotification('Error: Biblioteca QR no disponible', 'error');
return;
}

if (video.readyState === video.HAVE_ENOUGH_DATA) {
try {
// Configurar canvas con dimensiones optimizadas
const videoWidth = video.videoWidth;
const videoHeight = video.videoHeight;
            
// Usar dimensiones más manejables para mejor rendimiento
const maxDimension = 800;
let canvasWidth = videoWidth;
let canvasHeight = videoHeight;
            
if (videoWidth > maxDimension || videoHeight > maxDimension) {
const scale = Math.min(maxDimension / videoWidth, maxDimension / videoHeight);
canvasWidth = Math.floor(videoWidth * scale);
canvasHeight = Math.floor(videoHeight * scale);
}
            
canvasElement.width = canvasWidth;
canvasElement.height = canvasHeight;
            
// Limpiar canvas y dibujar frame actual
canvas.clearRect(0, 0, canvasWidth, canvasHeight);
canvas.drawImage(video, 0, 0, canvasWidth, canvasHeight);
            
// Obtener datos de imagen
const imageData = canvas.getImageData(0, 0, canvasWidth, canvasHeight);
            
// Configuración optimizada de jsQR para máxima compatibilidad
const qrOptions = {
inversionAttempts: "attemptBoth",  // Probar inversión de colores
locateFromCenter: true,            // Buscar desde el centro primero
canvasSize: Math.min(canvasWidth, canvasHeight), // Tamaño de búsqueda
greyScaleWeights: {               // Pesos personalizados para escala de grises
red: 0.299,
green: 0.587,
blue: 0.114
}
};
            
if (debugMode) {
console.log(`Escaneando frame: ${canvasWidth}x${canvasHeight}`);
}
            
// Intentar detectar código QR
const code = jsQR(imageData.data, imageData.width, imageData.height, qrOptions);
            
if (code) {
console.log("QR CODE DETECTADO!");
console.log(`Contenido: "${code.data}"`);
console.log(`Posición: x=${code.location.topLeftCorner.x}, y=${code.location.topLeftCorner.y}`);
console.log(`Tamaño estimado: ${Math.abs(code.location.topRightCorner.x - code.location.topLeftCorner.x)}px`);
                
scanning = false;
stopCamera();
                
// Agregar pequeño delay para suavizar la transición
setTimeout(() => {
processQRCode(code.data);
}, 100);
                
return; // Salir del loop de escaneo
}
            
} catch (processingError) {
console.error('Error en procesamiento de frame:', processingError);
// Continuar escaneando a pesar del error
}
}

// Continuar escaneando si no se encontró código
if (scanning) {
requestAnimationFrame(tick);
}
}

// FUNCIÓN PRINCIPAL COMPLETAMENTE REESCRITA: Procesar el código QR con máxima compatibilidad
function processQRCode(data) {
console.log('=====================================');
console.log('INICIANDO PROCESAMIENTO DE QR');
console.log('=====================================');
console.log(`Datos brutos recibidos: "${data}"`);
console.log(`Longitud de datos: ${data.length}`);
console.log(`Tipo de datos: ${typeof data}`);

try {
let packageData = null;
let isJsonData = false;
let searchCode = data.trim();

console.log(`Datos limpiados: "${searchCode}"`);

// PASO 1: Detectar si es JSON
console.log('PASO 1: Verificando si es formato JSON...');
try {
const jsonContent = JSON.parse(searchCode);
console.log('JSON detectado y parseado exitosamente:', jsonContent);
isJsonData = true;

// Extraer el código de búsqueda del JSON
if (jsonContent.id) {
searchCode = jsonContent.id;
console.log(`Usando ID del JSON para búsqueda: "${searchCode}"`);
} else if (jsonContent.qr_code) {
searchCode = jsonContent.qr_code;
console.log(`Usando qr_code del JSON para búsqueda: "${searchCode}"`);
} else {
console.log('JSON sin ID ni qr_code identificable');
searchCode = JSON.stringify(jsonContent);
}

// Buscar el paquete en la base de datos
packageData = findPackageByCode(searchCode);

if (!packageData) {
console.log('No encontrado en DB, usando datos del JSON como paquete');
packageData = {
...jsonContent,
id: jsonContent.id || jsonContent.qr_code || searchCode,
qr_code: jsonContent.qr_code || jsonContent.id || searchCode,
source: 'qr_json'
};
}
} catch (jsonError) {
console.log('No es JSON válido, tratando como código directo');
console.log(`Error JSON: ${jsonError.message}`);
isJsonData = false;
}

// PASO 2: Si no es JSON, buscar como código directo
if (!isJsonData) {
console.log('PASO 2: Procesando como código directo...');
console.log(`Buscando código: "${searchCode}"`);

packageData = findPackageByCode(searchCode);
}

// PASO 3: Validar y procesar resultado
console.log('PASO 3: Validando resultado...');

if (packageData && (packageData.id || packageData.qr_code)) {
console.log('PAQUETE ENCONTRADO!');
console.log(`ID: ${packageData.id}`);
console.log(`QR: ${packageData.qr_code}`);
console.log(`Departamento: ${packageData.apartment_number}`);
console.log(`Estado: ${packageData.status}`);

currentPackageData = packageData;
displayPackageInfo(packageData, true, data);

// Verificar estado para mostrar botón apropiado
if (packageData.status === 'pendiente') {
processButton.style.display = 'inline-flex';
showNotification('Paquete encontrado y listo para entregar', 'success');
console.log('Paquete pendiente, botón de entrega habilitado');
} else {
processButton.style.display = 'none';
const statusMsg = `Paquete ya ${packageData.status === 'entregado' ? 'entregado' : 'procesado'}`;
showNotification(statusMsg, 'warning');
console.log(`Paquete con estado: ${packageData.status}`);
}
} else {
console.log('PAQUETE NO ENCONTRADO');
console.log(`Código buscado: "${searchCode}"`);
console.log(`Datos originales: "${data}"`);

currentPackageData = null;
displayPackageInfo({ 
code: searchCode, 
originalData: data,
searchAttempted: true 
}, false, data);

processButton.style.display = 'none';
showNotification('Código QR no asociado a ningún paquete registrado', 'error');

// Información adicional para debugging
if (debugMode) {
const allPackages = getAllPackages();
console.log(`Total de paquetes en sistema: ${allPackages.length}`);
if (allPackages.length > 0) {
console.log('Algunos IDs disponibles:');
allPackages.slice(0, 5).forEach((pkg, i) => {
console.log(`  ${i+1}. "${pkg.id}" (Depto: ${pkg.apartment_number})`);
});
}
}
}

// Mostrar resultado
resultContainer.classList.add('active');
console.log('=====================================');
console.log('PROCESAMIENTO COMPLETADO');
console.log('=====================================');

} catch (error) {
console.error('ERROR CRÍTICO al procesar código QR:', error);
console.error('Stack trace:', error.stack);

currentPackageData = null;
processButton.style.display = 'none';

// Mostrar error detallado
displayPackageInfo({ 
code: data, 
error: error.message,
errorOccurred: true 
}, false, data);

showNotification('Error crítico al procesar el código QR', 'error');
resultContainer.classList.add('active');
}
}

// FUNCIÓN MEJORADA: Mostrar información del paquete con mensajes claros
function displayPackageInfo(packageData, found, rawCode = '') {
console.log('Generando display de información del paquete...');
console.log(`Encontrado: ${found}`);
console.log(`Datos del paquete:`, packageData);

let content = '';

if (found && (packageData.id || packageData.qr_code)) {
console.log('Mostrando información de paquete encontrado');

// Paquete encontrado en la base de datos
const formattedDate = packageData.delivery_date ?
new Date(packageData.delivery_date).toLocaleDateString('es-ES') :
packageData.created_at ?
new Date(packageData.created_at).toLocaleDateString('es-ES') :
'No disponible';
        
const status = packageData.status || 'pendiente';
const statusClass = status === 'pendiente' ? 'status-pending' : 'status-delivered';
const statusText = status === 'pendiente' ? 'Pendiente' : 
                   status === 'entregado' ? 'Entregado' : 
                   status === 'retirado' ? 'Retirado' : status;

const packageId = packageData.id || packageData.qr_code;
const sender = packageData.sender || 'No especificado';
const recipient = packageData.recipient || 'No especificado';
const apartment = packageData.apartment_number || 'No disponible';
const description = packageData.description || 'Sin descripción';

content = `
<div class="package-found">
<h4><i class="fas fa-check-circle"></i> Paquete Encontrado</h4>
<p>El código QR está asociado a un paquete registrado en el sistema.</p>
</div>
<p><strong>ID del Paquete:</strong> <code>${packageId}</code></p>
<p><strong>Departamento:</strong> ${apartment}</p>
<p><strong>Remitente:</strong> ${sender}</p>
<p><strong>Destinatario:</strong> ${recipient}</p>
<p><strong>Fecha de Registro:</strong> ${formattedDate}</p>
<p><strong>Estado Actual:</strong> <span class="status-badge ${statusClass}">${statusText}</span></p>
<p><strong>Descripción:</strong> ${description}</p>
`;

if (packageData.notes) {
content += `<p><strong>Notas:</strong> ${packageData.notes}</p>`;
}

if (debugMode) {
content += `
<div class="debug-info">
<strong>INFORMACIÓN DE DEBUG:</strong>
Código escaneado: ${rawCode}
Código de búsqueda: ${packageData.search_code || 'N/A'}
Datos completos del paquete:
${JSON.stringify(packageData, null, 2)}
</div>
`;
}
} else {
console.log('Mostrando información de paquete NO encontrado');

// Código no encontrado
const searchCode = packageData.code || rawCode;
const isError = packageData.errorOccurred;
const errorMsg = packageData.error;

content = `
<div class="package-not-found">
<h4><i class="fas fa-exclamation-triangle"></i> ${isError ? 'Error al Procesar' : 'Código No Asociado'}</h4>
${isError ? 
`<p>Se produjo un error al procesar el código QR: <strong>${errorMsg}</strong></p>` :
`<p><strong>El código QR escaneado no está asociado a ningún paquete registrado en el sistema.</strong></p>`
}
</div>

<div style="background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 15px; margin: 15px 0;">
<h5 style="margin: 0 0 10px 0; color: #856404;">Información del Escaneo:</h5>
<p><strong>Código Escaneado:</strong> <code style="background: #f8f9fa; padding: 2px 4px; border-radius: 3px;">${searchCode}</code></p>
<p><strong>Longitud:</strong> ${searchCode.length} caracteres</p>
<p><strong>Fecha/Hora:</strong> ${new Date().toLocaleString('es-ES')}</p>
</div>

<div style="background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 6px; padding: 15px; margin: 15px 0;">
<h5 style="margin: 0 0 10px 0; color: #0c5460;">Posibles Causas:</h5>
<ul style="margin: 0; padding-left: 20px;">
<li>El paquete no ha sido registrado en el sistema</li>
<li>El código QR no fue generado por esta aplicación</li>
<li>Puede haber un error en el formato del código</li>
<li>El paquete pudo haber sido eliminado del sistema</li>
</ul>
</div>

<div style="background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px; padding: 15px; margin: 15px 0;">
<h5 style="margin: 0 0 10px 0; color: #155724;">Pasos a Seguir:</h5>
<ol style="margin: 0; padding-left: 20px;">
<li><strong>Verificar:</strong> Que el código QR esté bien enfocado y sin daños</li>
<li><strong>Registrar:</strong> El paquete primero en "Registrar Paquete" si no existe</li>
<li><strong>Contactar:</strong> Al administrador si el problema persiste</li>
<li><strong>Intentar:</strong> Entrada manual del código si es necesario</li>
</ol>
</div>
`;

if (debugMode) {
const allPackages = getAllPackages();
const packageCount = allPackages.length;
const availableIds = allPackages.slice(0, 10).map(pkg => pkg.id || 'Sin ID');

content += `
<div class="debug-info">
<strong>INFORMACIÓN DE DEBUG:</strong>
Datos originales: ${packageData.originalData || rawCode}
Código procesado: ${searchCode}
Total paquetes en sistema: ${packageCount}
Algunos IDs disponibles: ${availableIds.join(', ')}${packageCount > 10 ? '...' : ''}

Detalles técnicos:
- Búsqueda realizada: ${packageData.searchAttempted ? 'Sí' : 'No'}
- Error de parsing: ${packageData.error || 'Ninguno'}
- Timestamp: ${new Date().toISOString()}
</div>
`;
}
}

resultContent.innerHTML = content;
console.log('Display de información generado correctamente');
}

// Función de test para probar códigos disponibles
function testAvailableCodes() {
console.log('INICIANDO TEST DE CÓDIGOS DISPONIBLES');
    
const packages = getAllPackages();
if (packages.length === 0) {
showNotification('No hay paquetes disponibles para probar', 'warning');
return;
}
    
console.log(`Paquetes disponibles para test: ${packages.length}`);
    
// Mostrar lista de códigos disponibles
let testOptions = packages.map((pkg, index) => {
const id = pkg.id || pkg.qr_code || 'Sin ID';
const dept = pkg.apartment_number || 'Sin Depto';
const status = pkg.status || 'Sin Estado';
return `${index + 1}. ${id} (Depto: ${dept}, Estado: ${status})`;
}).join('\n');
    
const userChoice = prompt(`CÓDIGOS DISPONIBLES PARA TEST:\n\n${testOptions}\n\nIngrese el número del código a probar (1-${packages.length}) o escriba un código personalizado:`);
    
if (!userChoice) {
console.log('Test cancelado por el usuario');
return;
}
    
let testCode = '';
    
// Verificar si es un número (selección de lista)
if (!isNaN(userChoice) && parseInt(userChoice) >= 1 && parseInt(userChoice) <= packages.length) {
const selectedPackage = packages[parseInt(userChoice) - 1];
testCode = selectedPackage.id || selectedPackage.qr_code;
console.log(`Código seleccionado de la lista: "${testCode}"`);
} else {
// Es un código personalizado
testCode = userChoice.trim();
console.log(`Código personalizado ingresado: "${testCode}"`);
}
    
if (testCode) {
console.log(`Ejecutando test con código: "${testCode}"`);
showNotification(`Probando código: ${testCode}`, 'info');
        
// Simular proceso de QR
setTimeout(() => {
processQRCode(testCode);
}, 500);
} else {
showNotification('Código de test vacío', 'error');
}
}

// Función para cerrar sesión
function logout() {
localStorage.removeItem('authToken');
localStorage.removeItem('userName');
localStorage.removeItem('userType');
localStorage.removeItem('isLoggedIn');
window.location.href = 'login.html';
}
window.logout = logout;

// MANEJADOR DE EVENTOS: Procesar paquete (marcar como entregado)
processButton.addEventListener('click', function() {
if (!currentPackageData || !(currentPackageData.id || currentPackageData.qr_code)) {
showNotification('No hay paquete válido para procesar', 'error');
return;
}

if (currentPackageData.status !== 'pendiente') {
showNotification('Este paquete ya fue entregado anteriormente', 'warning');
return;
}

const packageId = currentPackageData.id || currentPackageData.qr_code;
const updateSuccess = updatePackageStatus(packageId, 'entregado');

if (updateSuccess) {
currentPackageData.status = 'entregado';
displayPackageInfo(currentPackageData, true);
processButton.style.display = 'none';
showNotification('¡Paquete marcado como entregado exitosamente!', 'success');

setTimeout(() => {
resultContainer.classList.remove('active');
currentPackageData = null;
}, 3000);
} else {
showNotification('Error al actualizar el estado del paquete', 'error');
}
});

// Función para mostrar/ocultar el formulario manual de ingreso
function toggleManualEntry(show) {
if (show) {
manualForm.style.display = 'block';
if (scanning) {
stopCamera();
}
} else {
manualForm.style.display = 'none';
manualCodeInput.value = '';
}
}

// Función para procesar un código manual
function processManualCode() {
const manualCode = manualCodeInput.value.trim();
if (!manualCode) {
showNotification('Por favor ingrese un código válido', 'error');
return;
}

// Verificar que las dependencias estén disponibles
if (typeof jsQR === 'undefined') {
console.error('jsQR no está disponible para procesar código manual');
showNotification('Error: Biblioteca QR no disponible. Recargue la página.', 'error');
return;
}

console.log('Procesando código manual:', manualCode);
processQRCode(manualCode);
manualCodeInput.value = '';
toggleManualEntry(false);
}

// Event listeners básicos
startButton.addEventListener('click', startCamera);
stopButton.addEventListener('click', stopCamera);
switchCameraButton.addEventListener('click', switchCamera);

// Debug toggle
debugToggle.addEventListener('click', function() {
debugMode = !debugMode;
const text = debugMode ? 'Debug ON' : 'Debug OFF';
this.innerHTML = `<i class="fas fa-bug"></i><span>${text}</span>`;
showNotification(`Modo debug ${debugMode ? 'activado' : 'desactivado'}`);
console.log('Modo debug:', debugMode);
});

closeResultButton.addEventListener('click', function() {
resultContainer.classList.remove('active');
currentPackageData = null;
});

scanAgainButton.addEventListener('click', function() {
resultContainer.classList.remove('active');
currentPackageData = null;
startCamera();
});

// Event listeners para el ingreso manual
toggleManualButton.addEventListener('click', function() {
toggleManualEntry(manualForm.style.display === 'none');
});

processManualButton.addEventListener('click', processManualCode);

cancelManualButton.addEventListener('click', function() {
toggleManualEntry(false);
});

// Permitir enviar el formulario con Enter
manualCodeInput.addEventListener('keypress', function(e) {
if (e.key === 'Enter') {
processManualCode();
}
});

// Inicialización mejorada con sincronización de datos
console.log('Inicializando Lector QR mejorado...');
console.log('User Agent:', navigator.userAgent);

// Sincronizar datos al cargar la página
function syncPackageData() {
console.log('Sincronizando datos de paquetes...');
    
try {
// Obtener datos de ambas fuentes
const packages1 = localStorage.getItem('paquetesPrueba');
const packages2 = localStorage.getItem('packages');
        
let allPackages = [];
        
// Procesar paquetesPrueba
if (packages1) {
try {
const p1 = JSON.parse(packages1);
if (Array.isArray(p1)) {
console.log(`Cargados ${p1.length} paquetes de 'paquetesPrueba'`);
allPackages = [...p1];
}
} catch (e) {
console.error('Error al parsear paquetesPrueba:', e);
}
}
        
// Procesar packages y combinar
if (packages2) {
try {
const p2 = JSON.parse(packages2);
if (Array.isArray(p2)) {
console.log(`Encontrados ${p2.length} paquetes adicionales en 'packages'`);
                
// Combinar evitando duplicados
p2.forEach(pkg => {
const isDuplicate = allPackages.some(existing => 
(existing.id && pkg.id && existing.id === pkg.id) ||
(existing.qr_code && pkg.qr_code && existing.qr_code === pkg.qr_code)
);
if (!isDuplicate) {
allPackages.push(pkg);
}
});
}
} catch (e) {
console.error('Error al parsear packages:', e);
}
}
        
// Normalizar todos los paquetes para búsqueda óptima
const normalizedPackages = allPackages.map(pkg => ({
...pkg,
id: pkg.id || pkg.qr_code || pkg.package_id,
qr_code: pkg.qr_code || pkg.id,
search_terms: [
pkg.id,
pkg.qr_code,
pkg.package_id
].filter(Boolean)
}));
        
// Guardar datos normalizados en ambas ubicaciones
localStorage.setItem('paquetesPrueba', JSON.stringify(normalizedPackages));
localStorage.setItem('packages', JSON.stringify(normalizedPackages));
        
console.log(`Sincronización completada: ${normalizedPackages.length} paquetes disponibles`);
        
if (normalizedPackages.length > 0) {
console.log('Primeros 5 paquetes sincronizados:');
normalizedPackages.slice(0, 5).forEach((pkg, i) => {
console.log(`  ${i+1}. ID: "${pkg.id}" | Depto: ${pkg.apartment_number} | Estado: ${pkg.status}`);
});
}
        
return normalizedPackages;
} catch (error) {
console.error('Error en sincronización:', error);
return [];
}
}

// Ejecutar sincronización al cargar
const availablePackages = syncPackageData();
console.log(`Total de paquetes disponibles para escáner: ${availablePackages.length}`);

// Verificar capacidades del navegador
function checkBrowserCapabilities() {
console.log('Verificando capacidades del navegador...');
    
const capabilities = {
getUserMedia: !!navigator.mediaDevices?.getUserMedia,
canvas: !!document.createElement('canvas').getContext,
jsQR: typeof jsQR !== 'undefined',
localStorage: !!window.localStorage
};
    
console.log('Capacidades:', capabilities);
    
if (!capabilities.getUserMedia) {
console.warn('getUserMedia no disponible - solo entrada manual');
toggleManualEntry(true);
}
    
if (!capabilities.jsQR) {
console.error('Biblioteca jsQR no está disponible');
showNotification('Error: La biblioteca de QR no está disponible. Recargue la página.', 'error');
// Intentar mostrar el botón de entrada manual como alternativa
toggleManualEntry(true);
return capabilities;
}
    
console.log('jsQR version:', jsQR.version || 'Desconocida');
showNotification('Biblioteca QR cargada correctamente', 'success');
    
return capabilities;
}

const browserCaps = checkBrowserCapabilities();

// Configurar eventos con mejor manejo de errores
function setupEventListeners() {
console.log('Configurando event listeners...');
    
try {
// Botones de cámara
startButton?.addEventListener('click', async () => {
console.log('Iniciando cámara...');
await startCamera();
});
        
stopButton?.addEventListener('click', () => {
console.log('Deteniendo cámara...');
stopCamera();
});
        
switchCameraButton?.addEventListener('click', () => {
console.log('Cambiando cámara...');
switchCamera();
});
        
        // Debug toggle con estado persistente
debugToggle?.addEventListener('click', function() {
debugMode = !debugMode;
localStorage.setItem('qr_debug_mode', debugMode.toString());
const text = debugMode ? 'Debug ON' : 'Debug OFF';
this.innerHTML = `<i class="fas fa-bug"></i><span>${text}</span>`;
showNotification(`Modo debug ${debugMode ? 'activado' : 'desactivado'}`);
console.log('Modo debug:', debugMode);
});

// Botón de test de códigos
testCodesBtn?.addEventListener('click', function() {
console.log('Iniciando test de códigos...');
testAvailableCodes();
});
        
// Restaurar estado de debug
const savedDebugMode = localStorage.getItem('qr_debug_mode');
if (savedDebugMode === 'true') {
debugMode = true;
debugToggle.innerHTML = '<i class="fas fa-bug"></i><span>Debug ON</span>';
console.log('Modo debug restaurado: activado');
}
        
// Botones de resultado
closeResultButton?.addEventListener('click', () => {
console.log('Cerrando resultado...');
resultContainer.classList.remove('active');
currentPackageData = null;
});
        
scanAgainButton?.addEventListener('click', () => {
console.log('Escaneando de nuevo...');
resultContainer.classList.remove('active');
currentPackageData = null;
startCamera();
});
        
// Ingreso manual
toggleManualButton?.addEventListener('click', () => {
const isVisible = manualForm.style.display !== 'none';
console.log(`Alternando entrada manual: ${!isVisible ? 'mostrar' : 'ocultar'}`);
toggleManualEntry(!isVisible);
});
        
processManualButton?.addEventListener('click', () => {
console.log('Procesando código manual...');
processManualCode();
});
        
cancelManualButton?.addEventListener('click', () => {
console.log('Cancelando entrada manual...');
toggleManualEntry(false);
});
        
// Enter en campo manual
manualCodeInput?.addEventListener('keypress', (e) => {
if (e.key === 'Enter') {
console.log('Enter presionado en campo manual');
processManualCode();
}
});
        
console.log('Event listeners configurados correctamente');
} catch (error) {
console.error('Error configurando event listeners:', error);
}
}

// Configurar todo
setupEventListeners();

// Auto-inicio inteligente
if (browserCaps.getUserMedia && !navigator.userAgent.match(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i)) {
console.log('Dispositivo de escritorio detectado, auto-iniciando cámara...');
setTimeout(() => {
startCamera();
}, 1000);
} else {
console.log('Dispositivo móvil o sin cámara, esperando acción del usuario');
}

console.log('Lector QR completamente inicializado y listo');

// Test de conectividad con datos
setTimeout(() => {
const testPackages = getAllPackages();
console.log(`Test de conectividad: ${testPackages.length} paquetes accesibles`);
if (testPackages.length === 0) {
console.warn('Advertencia: No se encontraron paquetes para escanear');
}
}, 2000);

} // Cierre de initializeQRReader

// Agregar el event listener para DOMContentLoaded como fallback
document.addEventListener('DOMContentLoaded', function() {
// Esta función se ejecutará si jsQR ya está disponible cuando el DOM esté listo
if (typeof jsQR !== 'undefined') {
console.log('jsQR ya disponible, iniciando aplicación...');
initializeQRReader();
}
});
</script>
</body>
</html>