<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Residente - Gestión de Paquetes</title>
<style>
:root {
  --primary: #4361ee;
  --primary-dark: #3a0ca3;
  --primary-light: #e0f7fc;
  --secondary: #7209b7;
  --secondary-dark: #560bad;
  --success: #2ecc71;
  --danger: #f72585;
  --warning: #f8961e;
  --info: #90e0ef;
  --light: #f8f9fa;
  --dark: #212529;
  --gray: #6c757d;
  --gray-light: #e9ecef;
  --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  --transition: all 0.3s ease;
  --border-radius: 12px;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
  background-color: #f5f7fb;
  color: #333;
}

.container {
  display: flex;
  min-height: 100vh;
}

.sidebar {
  width: 280px;
  background: linear-gradient(180deg, var(--primary-dark) 0%, var(--secondary) 100%);
  box-shadow: var(--box-shadow);
  padding: 25px 0;
  color: white;
  position: fixed;
  height: 100vh;
  overflow-y: auto;
  z-index: 100;
}

.sidebar-header {
  padding: 0 25px 25px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.logo {
  font-size: 22px;
  font-weight: bold;
  color: white;
  display: flex;
  align-items: center;
  gap: 12px;
}

.nav-menu {
  margin-top: 35px;
  list-style: none;
}

.nav-item {
  padding: 14px 25px;
  display: flex;
  align-items: center;
  gap: 12px;
  color: rgba(255, 255, 255, 0.8);
  cursor: pointer;
  transition: var(--transition);
  border-left: 4px solid transparent;
  font-weight: 500;
}

.nav-item:hover {
  background-color: rgba(255, 255, 255, 0.12);
  color: white;
  border-left: 4px solid rgba(255, 255, 255, 0.6);
}

.nav-item.active {
  background-color: rgba(255, 255, 255, 0.18);
  color: white;
  border-left: 4px solid white;
}

.main-content {
  flex: 1;
  padding: 30px;
  margin-left: 280px;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 35px;
  background-color: white;
  padding: 20px 30px;
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
}

.page-title {
  font-size: 26px;
  font-weight: bold;
  color: var(--primary-dark);
}

.user-menu {
  display: flex;
  align-items: center;
  gap: 25px;
}

.notification-badge {
  position: relative;
  cursor: pointer;
  transition: var(--transition);
}

.notification-badge:hover {
  transform: translateY(-2px);
}

.badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background-color: var(--danger);
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 11px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

.user-profile {
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: var(--transition);
  position: relative;
}

.user-profile:hover {
  transform: translateY(-2px);
}

.avatar {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 16px;
  box-shadow: 0 4px 8px rgba(114, 9, 183, 0.2);
}

.user-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  background: white;
  border-radius: 8px;
  box-shadow: var(--box-shadow);
  padding: 10px 0;
  min-width: 200px;
  display: none;
  z-index: 1000;
}

.user-dropdown.show {
  display: block;
}

.dropdown-item {
  padding: 10px 20px;
  cursor: pointer;
  color: var(--dark);
  display: flex;
  align-items: center;
  gap: 10px;
  transition: var(--transition);
}

.dropdown-item:hover {
  background-color: var(--light);
}

.stats-container {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 25px;
  margin-bottom: 35px;
}

.stat-card {
  background-color: #fff;
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
  padding: 25px;
  display: flex;
  align-items: center;
  gap: 20px;
  transition: var(--transition);
  cursor: pointer;
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
}

.stat-icon {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  width: 65px;
  height: 65px;
  border-radius: var(--border-radius);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
  box-shadow: 0 6px 15px rgba(114, 9, 183, 0.15);
}

.stat-info h3 {
  font-size: 28px;
  margin-bottom: 5px;
  color: var(--secondary);
}

.stat-info p {
  font-size: 15px;
  color: var(--gray);
}

.card {
  background-color: #fff;
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
  margin-bottom: 30px;
  overflow: hidden;
  border: none;
}

.card-header {
  padding: 20px 30px;
  border-bottom: 1px solid var(--gray-light);
  font-weight: 600;
  font-size: 18px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background-color: white;
  color: var(--primary-dark);
}

.card-body {
  padding: 30px;
}

.table {
  width: 100%;
  border-collapse: collapse;
}

.table th, .table td {
  padding: 16px 20px;
  text-align: left;
  border-bottom: 1px solid var(--gray-light);
}

.table th {
  font-weight: 600;
  color: var(--primary-dark);
  background-color: rgba(67, 97, 238, 0.05);
}

.table tr:hover {
  background-color: rgba(67, 97, 238, 0.03);
}

.status {
  padding: 8px 14px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 5px;
}

.status-pending {
  background-color: rgba(248, 150, 30, 0.12);
  color: var(--warning);
}

.status-delivered {
  background-color: rgba(46, 204, 113, 0.12);
  color: var(--success);
}

.status-entregado {
  background-color: rgba(46, 204, 113, 0.12);
  color: var(--success);
}

.status-retirado {
  background-color: rgba(52, 152, 219, 0.12);
  color: var(--info);
}

.action-btn {
  background-color: var(--primary);
  color: white;
  border: none;
  padding: 10px 18px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  transition: var(--transition);
  margin-right: 5px;
}

.action-btn:hover {
  background-color: var(--primary-dark);
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
}

.action-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.btn-secondary {
  background-color: var(--secondary);
}

.btn-secondary:hover {
  background-color: var(--secondary-dark);
}

.btn-success {
  background-color: var(--success);
}

.btn-danger {
  background-color: var(--danger);
}

.btn-warning {
  background-color: var(--warning);
}

.btn-info {
  background-color: var(--info);
}

.form-group {
  margin-bottom: 22px;
}

.form-label {
  display: block;
  margin-bottom: 10px;
  font-weight: 500;
  color: var(--secondary);
}

.form-control {
  width: 100%;
  padding: 14px;
  border: 1px solid var(--gray-light);
  border-radius: 8px;
  font-size: 15px;
  transition: var(--transition);
}

.form-control:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
}

.notification-list {
  list-style: none;
}

.notification-item {
  padding: 15px 0;
  border-bottom: 1px solid var(--gray-light);
  display: flex;
  align-items: center;
  gap: 15px;
  cursor: pointer;
  transition: var(--transition);
}

.notification-item:hover {
  background-color: rgba(67, 97, 238, 0.03);
  padding-left: 10px;
  border-radius: 8px;
}

.notification-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: rgba(67, 97, 238, 0.1);
  color: var(--primary);
  display: flex;
  align-items: center;
  justify-content: center;
}

.notification-info {
  flex: 1;
}

.notification-title {
  font-weight: 500;
  margin-bottom: 3px;
}

.notification-time {
  font-size: 12px;
  color: var(--gray);
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.authorized-fields {
  display: none;
}

.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background-color: #2ecc71;
  color: white;
  padding: 15px 25px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  z-index: 1000;
  display: none;
  animation: slideInRight 0.3s ease;
}

.toast.error {
  background-color: var(--danger);
}

.toast.warning {
  background-color: var(--warning);
}

.toast.info {
  background-color: var(--info);
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
  }
  to {
    transform: translateX(0);
  }
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--gray);
}

.empty-state i {
  font-size: 3rem;
  margin-bottom: 15px;
  color: var(--gray-light);
}

.welcome-card {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  border-radius: var(--border-radius);
  padding: 30px;
  margin-bottom: 30px;
  box-shadow: var(--box-shadow);
}

.welcome-card h2 {
  font-size: 1.8rem;
  margin-bottom: 10px;
}

.resident-info {
  background-color: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  padding: 15px;
  margin-top: 15px;
}

.resident-info-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

/* Loading overlay */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  z-index: 9999;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

.loading-text {
  color: white;
  font-size: 16px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Modal */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.modal-content {
  background: white;
  border-radius: var(--border-radius);
  padding: 30px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid var(--gray-light);
}

.modal-title {
  font-size: 20px;
  font-weight: 600;
  color: var(--primary-dark);
}

.close-btn {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--gray);
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-btn:hover {
  color: var(--danger);
}

.filter-container {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.filter-item {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.filter-item label {
  font-size: 14px;
  color: var(--gray);
  font-weight: 500;
}

.filter-item select,
.filter-item input {
  padding: 8px 12px;
  border: 1px solid var(--gray-light);
  border-radius: 6px;
  font-size: 14px;
}

@media (max-width: 1200px) {
  .stats-container {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 992px) {
  .sidebar {
    width: 240px;
  }

  .main-content {
    margin-left: 240px;
    padding: 20px;
  }
}

@media (max-width: 768px) {
  .sidebar {
    width: 0;
    transform: translateX(-100%);
    transition: all 0.3s ease;
  }
  
  .sidebar.active {
    width: 240px;
    transform: translateX(0);
  }

  .main-content {
    margin-left: 0;
  }
  
  .stats-container {
    grid-template-columns: 1fr;
  }
  
  .mobile-menu {
    display: block;
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--primary);
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    cursor: pointer;
    border: none;
  }

  .filter-container {
    flex-direction: column;
  }
}
</style>
</head>
<body>

<!-- Loading overlay -->
<div class="loading-overlay" id="loading-overlay" style="display: none;">
  <div class="loading-spinner"></div>
  <div class="loading-text">Cargando panel de residente...</div>
</div>

<!-- Toast notifications -->
<div class="toast" id="toast">Acción completada exitosamente</div>

<!-- Modal para detalles de paquete -->
<div class="modal" id="package-modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Detalles del Paquete</h3>
      <button class="close-btn" onclick="closeModal('package-modal')">&times;</button>
    </div>
    <div id="package-modal-content">
      <!-- Contenido dinámico -->
    </div>
  </div>
</div>

<!-- Modal para confirmar retiro -->
<div class="modal" id="confirm-pickup-modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Confirmar Retiro</h3>
      <button class="close-btn" onclick="closeModal('confirm-pickup-modal')">&times;</button>
    </div>
    <div id="confirm-pickup-content">
      <p>¿Estás seguro de que deseas solicitar el retiro de este paquete?</p>
      <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
        <button class="action-btn btn-secondary" onclick="closeModal('confirm-pickup-modal')">Cancelar</button>
        <button class="action-btn" id="confirm-pickup-btn">Confirmar</button>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
        PackTrack
      </div> 
    </div>
    <ul class="nav-menu">
      <li class="nav-item active" data-tab="dashboard">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
        Dashboard
      </li>
      <li class="nav-item" data-tab="tracking">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
        Seguimiento y Tracking
      </li>
      <li class="nav-item" data-tab="notificaciones">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
        Notificaciones
      </li>
      <li class="nav-item" data-tab="solicitud">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        Solicitar Retiro
      </li>
      <li class="nav-item" data-tab="soporte">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
        Soporte y Contacto
      </li>
      <li class="nav-item" onclick="logout()" style="margin-top: 30px; color: #f72585;" id="cerrar-sesion">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
        Cerrar Sesión
      </li>
    </ul>
  </div>

  <div class="main-content">
    <div class="header">
      <h1 class="page-title">Dashboard</h1>
      <div class="user-menu">
        <div class="notification-badge" id="notification-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
          <span class="badge" id="notification-count">0</span>
        </div>
        <div class="user-profile" id="user-profile">
          <div class="avatar" id="user-avatar">R</div>
          <div>
            <div style="font-weight: 600;" id="user-name">Residente</div>
            <div style="font-size: 12px; color: var(--gray);" id="user-department">Depto. --</div>
          </div>
          <div class="user-dropdown" id="user-dropdown">
            <div class="dropdown-item" onclick="editProfile()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"></path></svg>
              Editar Perfil
            </div>
            <div class="dropdown-item" onclick="changePassword()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><circle cx="12" cy="16" r="1"></circle><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
              Cambiar Contraseña
            </div>
            <div class="dropdown-item" onclick="viewSettings()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
              Configuración
            </div>
            <hr style="margin: 5px 0; border: none; border-top: 1px solid var(--gray-light);">
            <div class="dropdown-item" onclick="logout()" style="color: var(--danger);">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
              Cerrar Sesión
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="tab-content active">
      <!-- Tarjeta de bienvenida personalizada -->
      <div class="welcome-card">
        <h2 id="welcome-title">¡Bienvenido/a!</h2>
        <p id="welcome-message">Aquí puedes ver y gestionar todos tus paquetes de forma fácil y rápida.</p>
        <div class="resident-info" id="resident-info">
          <!-- Se cargará dinámicamente -->
        </div>
      </div>

      <div class="stats-container">
        <div class="stat-card" onclick="showAllPackages()">
          <div class="stat-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg>
          </div>
          <div class="stat-info">
            <h3 id="total-packages">0</h3>
            <p>Total de Paquetes</p>
          </div>
        </div>

        <div class="stat-card" onclick="showPendingPackages()">
          <div class="stat-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
          </div>
          <div class="stat-info">
            <h3 id="pending-packages">0</h3>
            <p>Pendientes de Retiro</p>
          </div>
        </div>

        <div class="stat-card" onclick="showDeliveredPackages()">
          <div class="stat-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
          </div>
          <div class="stat-info">
            <h3 id="delivered-packages">0</h3>
            <p>Entregados</p>
          </div>
        </div>

        <div class="stat-card" onclick="showThisMonthPackages()">
          <div class="stat-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
          </div>
          <div class="stat-info">
            <h3 id="this-month-packages">0</h3>
            <p>Este Mes</p>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          Mis Paquetes Recientes
          <div>
            <button class="action-btn btn-secondary" onclick="filterPackages()">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
              Filtrar
            </button>
            <button class="action-btn" id="btn-actualizar">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
              Actualizar
            </button>
          </div>
        </div>
        <div class="card-body">
          <table class="table">
            <thead>
              <tr>
                <th>ID Paquete</th>
                <th>Remitente</th>
                <th>Fecha</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="packages-table">
              <!-- Se cargará dinámicamente -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          Acciones Rápidas
        </div>
        <div class="card-body">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <button class="action-btn btn-cambiar-tab" data-tab="solicitud" style="justify-content: center; padding: 15px; font-size: 16px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 10px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
              Solicitar Retiro
            </button>
            <button class="action-btn btn-secondary btn-cambiar-tab" data-tab="tracking" style="justify-content: center; padding: 15px; font-size: 16px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 10px;"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
              Seguimiento
            </button>
            <button class="action-btn btn-success btn-cambiar-tab" data-tab="soporte" style="justify-content: center; padding: 15px; font-size: 16px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 10px;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
              Contactar Soporte
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tracking -->
    <div id="tracking" class="tab-content">
      <div class="card">
        <div class="card-header">
          Seguimiento de Mis Paquetes
        </div>
        <div class="card-body">
          <div style="display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap;">
            <input type="text" class="form-control" id="search-package" placeholder="Buscar por ID de paquete" style="max-width: 300px;">
            <button class="action-btn" id="buscar-tracking">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="M21 21l-4.35-4.35"></path></svg>
              Buscar
            </button>
            <button class="action-btn btn-secondary" onclick="clearSearch()">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
              Limpiar
            </button>
          </div>
          
          <div id="tracking-results">
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="M21 21l-4.35-4.35"></path></svg>
              <p>Ingrese un ID de paquete para ver los detalles</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Notificaciones -->
    <div id="notificaciones" class="tab-content">
      <div class="card">
        <div class="card-header">
          Mis Notificaciones
          <button class="action-btn btn-warning" onclick="markAllAsRead()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
            Marcar todo como leído
          </button>
        </div>
        <div class="card-body">
          <ul class="notification-list" id="notifications-list">
            <!-- Se cargarán dinámicamente -->
          </ul>
        </div>
      </div>
    </div>

    <!-- Solicitar Retiro -->
    <div id="solicitud" class="tab-content">
      <div class="card">
        <div class="card-header">
          Solicitud de Retiro
        </div>
        <div class="card-body">
          <form id="pickup-form">
            <div class="form-group">
              <label class="form-label">Seleccione el paquete a retirar *</label>
              <select class="form-control" id="package-select" required>
                <option value="">Seleccione un paquete pendiente</option>
                <!-- Se cargarán dinámicamente -->
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">Fecha de retiro *</label>
              <input type="date" class="form-control" id="pickup-date" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">Hora aproximada *</label>
              <select class="form-control" id="pickup-time" required>
                <option value="">Seleccione una hora</option>
                <option value="morning">Mañana (9:00 - 13:00)</option>
                <option value="afternoon">Tarde (14:00 - 18:00)</option>
                <option value="evening">Noche (19:00 - 21:00)</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">¿Quién retirará el paquete? *</label>
              <div style="display: flex; gap: 20px; margin-top: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="radio" id="self" name="retirador" value="self" checked>
                  <span>Yo mismo</span>
                </label>
                
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="radio" id="other" name="retirador" value="other">
                  <span>Otra persona</span>
                </label>
              </div>
            </div>
            
            <div class="form-group authorized-fields" id="authorized-fields">
              <label class="form-label">Detalles de la persona autorizada</label>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <input type="text" class="form-control" id="authorized-name" placeholder="Nombre completo">
                <input type="text" class="form-control" id="authorized-id" placeholder="DNI/Pasaporte">
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Comentarios adicionales</label>
              <textarea class="form-control" rows="3" id="pickup-comments" placeholder="Instrucciones especiales, observaciones, etc."></textarea>
            </div>
            
            <div style="display: flex; gap: 10px;">
              <button type="submit" class="action-btn" id="enviar-solicitud">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"></path><path d="M22 2L15 22L11 13L2 9L22 2z"></path></svg>
                Enviar Solicitud
              </button>
              <button type="button" class="action-btn btn-secondary" onclick="clearPickupForm()">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                Limpiar Formulario
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Historial de solicitudes -->
      <div class="card">
        <div class="card-header">
          Historial de Solicitudes de Retiro
        </div>
        <div class="card-body">
          <div id="pickup-history">
            <!-- Se cargará dinámicamente -->
          </div>
        </div>
      </div>
    </div>

    <!-- Soporte -->
    <div id="soporte" class="tab-content">
      <div class="card">
        <div class="card-header">
          Soporte y Contacto
        </div>
        <div class="card-body">
          <div style="margin-bottom: 30px;">
            <h3 style="margin-bottom: 20px;">Contacte con Nosotros</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
              <div style="background-color: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; cursor: pointer;" onclick="callBuilding()">
                <div style="font-size: 24px; margin-bottom: 15px; color: var(--primary);">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                </div>
                <h4 style="margin-bottom: 10px;">Conserjería</h4>
                <p id="building-phone">+56 2 2345 6789</p>
                <p style="color: #777; font-size: 14px;">Lun-Vie: 9:00 - 18:00</p>
              </div>
              
              <div style="background-color: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; cursor: pointer;" onclick="emailBuilding()">
                <div style="font-size: 24px; margin-bottom: 15px; color: var(--primary);">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                </div>
                <h4 style="margin-bottom: 10px;">Email</h4>
                <p id="building-email">admin@edificio.cl</p>
                <p style="color: #777; font-size: 14px;">Respuesta en 24 horas</p>
              </div>
              
              <div style="background-color: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; cursor: pointer;" onclick="showBuildingLocation()">
                <div style="font-size: 24px; margin-bottom: 15px; color: var(--primary);">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                </div>
                <h4 style="margin-bottom: 10px;">Dirección</h4>
                <p id="building-address">Av. Providencia 1234</p>
                <p style="color: #777; font-size: 14px;">Santiago, Chile</p>
              </div>
            </div>
          </div>
          
          <div>
            <h3 style="margin-bottom: 20px;">Envíe un Mensaje</h3>
            <form id="support-form">
              <div class="form-group">
                <label class="form-label">Asunto *</label>
                <select class="form-control" id="support-subject" required>
                  <option value="">Seleccione un asunto</option>
                  <option value="consulta">Consulta General</option>
                  <option value="problema-paquete">Problema con un Paquete</option>
                  <option value="informacion">Solicitud de Información</option>
                  <option value="sugerencia">Sugerencia</option>
                  <option value="reclamo">Reclamo</option>
                  <option value="otro">Otro</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Mensaje *</label>
                <textarea class="form-control" rows="5" id="support-message" placeholder="Describa su consulta o problema detalladamente..." required></textarea>
              </div>
              
              <div style="display: flex; gap: 10px;">
                <button type="submit" class="action-btn" id="enviar-mensaje">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"></path><path d="M22 2L15 22L11 13L2 9L22 2z"></path></svg>
                  Enviar Mensaje
                </button>
                <button type="button" class="action-btn btn-secondary" onclick="clearSupportForm()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                  Limpiar
                </button>
              </div>
            </form>
          </div>

          <!-- Historial de mensajes -->
          <div style="margin-top: 40px;">
            <h3 style="margin-bottom: 20px;">Historial de Mensajes</h3>
            <div id="support-history">
              <!-- Se cargará dinámicamente -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<button class="mobile-menu" id="mobile-menu">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
</button>

<script>
// Variables globales
let currentResident = null;
let residentPackages = [];
let currentPackageFilter = 'all';

// Función para mostrar/ocultar loading
function showLoading(show = true) {
  const loadingOverlay = document.getElementById('loading-overlay');
  loadingOverlay.style.display = show ? 'flex' : 'none';
}

// Función para inicializar datos de prueba si no existen
function initializeTestData() {
  // Verificar si ya existen datos
  const existingPackages = localStorage.getItem('paquetesPrueba');
  const existingResidents = localStorage.getItem('residents');
  const existingConfig = localStorage.getItem('edificioConfig');
  
  // Inicializar paquetes de prueba si no existen
  if (!existingPackages) {
    const testPackages = [
      {
        id: 'PKG-2024-001',
        apartment_number: '101',
        sender: 'Amazon Chile',
        description: 'Paquete mediano',
        delivery_date: '2024-01-15',
        created_at: '2024-01-15T10:30:00',
        status: 'pendiente',
        size: 'mediano',
        weight: '2.5kg'
      },
      {
        id: 'PKG-2024-002',
        apartment_number: '101',
        sender: 'Mercado Libre',
        description: 'Sobre pequeño',
        delivery_date: '2024-01-10',
        created_at: '2024-01-10T14:20:00',
        status: 'entregado',
        size: 'pequeño',
        weight: '0.5kg'
      },
      {
        id: 'PKG-2024-003',
        apartment_number: '202',
        sender: 'Falabella',
        description: 'Caja grande',
        delivery_date: '2024-01-18',
        created_at: '2024-01-18T09:15:00',
        status: 'pendiente',
        size: 'grande',
        weight: '5.2kg'
      },
      {
        id: 'PKG-2024-004',
        apartment_number: '101',
        sender: 'DHL Express',
        description: 'Documento importante',
        delivery_date: '2024-01-20',
        created_at: '2024-01-20T16:45:00',
        status: 'pendiente',
        size: 'sobre',
        weight: '0.2kg'
      },
      {
        id: 'PKG-2024-005',
        apartment_number: '101',
        sender: 'Ripley',
        description: 'Producto electrónico',
        delivery_date: '2024-01-12',
        created_at: '2024-01-12T11:30:00',
        status: 'retirado',
        size: 'mediano',
        weight: '3.1kg'
      }
    ];
    
    localStorage.setItem('paquetesPrueba', JSON.stringify(testPackages));
  }
  
  // Inicializar configuración del edificio si no existe
  if (!existingConfig) {
    const buildingConfig = {
      nombreEdificio: 'Torres del Sol',
      direccion: 'Av. Providencia 1234, Providencia, Santiago',
      telefono: '+56 2 2345 6789',
      email: 'admin@torressol.cl',
      horarioAtencion: 'Lunes a Viernes: 9:00 - 18:00'
    };
    
    localStorage.setItem('edificioConfig', JSON.stringify(buildingConfig));
  }
  
  // Inicializar residentes de prueba si no existen
  if (!existingResidents) {
    const testResidents = [
      {
        id: 'RES-001',
        name: 'María',
        lastname: 'Álvarez',
        email: 'maria.alvarez@email.com',
        phone: '+56 9 8765 4321',
        department: '101',
        password: 'password123',
        active: true,
        created_at: '2024-01-01'
      },
      {
        id: 'RES-002',
        name: 'Carlos',
        lastname: 'González',
        email: 'carlos.gonzalez@email.com',
        phone: '+56 9 1234 5678',
        department: '202',
        password: 'password123',
        active: true,
        created_at: '2024-01-01'
      }
    ];
    
    localStorage.setItem('residents', JSON.stringify(testResidents));
  }
}

// Función para obtener el residente actual
function getCurrentResident() {
  try {
    let residentData = localStorage.getItem('currentResident');
    if (residentData) {
      return JSON.parse(residentData);
    }
    
    const currentUserId = localStorage.getItem('currentResidentId');
    const userName = localStorage.getItem('userName');
    
    if (currentUserId) {
      const residents = JSON.parse(localStorage.getItem('residents') || '[]');
      const resident = residents.find(r => r.id === currentUserId);
      if (resident) {
        localStorage.setItem('currentResident', JSON.stringify(resident));
        return resident;
      }
    }
    
    if (userName) {
      const residents = JSON.parse(localStorage.getItem('residents') || '[]');
      const resident = residents.find(r => 
        `${r.name} ${r.lastname}` === userName || 
        r.name === userName ||
        r.email === userName
      );
      if (resident) {
        localStorage.setItem('currentResident', JSON.stringify(resident));
        return resident;
      }
    }
    
    return null;
  } catch (error) {
    console.error('Error al cargar datos del residente:', error);
    return null;
  }
}

// Función para obtener todos los paquetes
function getAllPackages() {
  try {
    const packagesData = localStorage.getItem('paquetesPrueba');
    return packagesData ? JSON.parse(packagesData) : [];
  } catch (error) {
    console.error('Error al cargar paquetes:', error);
    return [];
  }
}

// Función para obtener paquetes del residente
function getResidentPackages(departmentNumber) {
  const allPackages = getAllPackages();
  return allPackages.filter(pkg => pkg.apartment_number === departmentNumber);
}

// Función para obtener configuración del edificio
function getBuildingConfig() {
  try {
    const configData = localStorage.getItem('edificioConfig');
    return configData ? JSON.parse(configData) : {
      nombreEdificio: 'Torres del Sol',
      direccion: 'Av. Providencia 1234',
      telefono: '+56 2 2345 6789',
      email: 'admin@edificio.cl'
    };
  } catch (error) {
    console.error('Error al cargar configuración:', error);
    return {};
  }
}

// Función para validar autenticación completa
function validateAuthentication() {
  const authToken = localStorage.getItem('authToken');
  const userType = localStorage.getItem('userType');
  const isLoggedIn = localStorage.getItem('isLoggedIn');
  
  if (!authToken || !isLoggedIn || userType !== 'resident') {
    console.log('Validación de autenticación fallida:', {
      authToken: !!authToken,
      isLoggedIn: isLoggedIn,
      userType: userType
    });
    return false;
  }
  
  return true;
}

// Función para cargar información del residente
function loadResidentInfo() {
  currentResident = getCurrentResident();
  
  if (!currentResident) {
    console.error('No se pudo cargar la información del residente');
    showToast('Error: No se pudo cargar la información del usuario', 'error');
    
    setTimeout(() => {
      logout();
    }, 2000);
    return false;
  }

  try {
    document.getElementById('user-name').textContent = `${currentResident.name} ${currentResident.lastname}`;
    document.getElementById('user-department').textContent = `Depto. ${currentResident.department}`;
    
    const initials = `${currentResident.name.charAt(0)}${currentResident.lastname.charAt(0)}`;
    document.getElementById('user-avatar').textContent = initials.toUpperCase();

    document.getElementById('welcome-title').textContent = `¡Bienvenido/a, ${currentResident.name}!`;
    document.getElementById('welcome-message').textContent = `Departamento ${currentResident.department} - Aquí puedes ver y gestionar todos tus paquetes de forma fácil y rápida.`;
    
    const residentInfo = document.getElementById('resident-info');
    residentInfo.innerHTML = `
      <div class="resident-info-item">
        <span>Departamento:</span>
        <span>${currentResident.department}</span>
      </div>
      <div class="resident-info-item">
        <span>Email:</span>
        <span>${currentResident.email}</span>
      </div>
      ${currentResident.phone ? `
      <div class="resident-info-item">
        <span>Teléfono:</span>
        <span>${currentResident.phone}</span>
      </div>
      ` : ''}
    `;

    loadBuildingInfo();
    return true;
  } catch (error) {
    console.error('Error al cargar información del residente:', error);
    showToast('Error al cargar información del usuario', 'error');
    return false;
  }
}

// Función para cargar información del edificio
function loadBuildingInfo() {
  const config = getBuildingConfig();
  
  try {
    if (config.telefono) {
      document.getElementById('building-phone').textContent = config.telefono;
    }
    if (config.email) {
      document.getElementById('building-email').textContent = config.email;
    }
    if (config.direccion) {
      document.getElementById('building-address').textContent = config.direccion;
    }
  } catch (error) {
    console.error('Error al actualizar información del edificio:', error);
  }
}

// Función para cargar paquetes del residente
function loadResidentPackages() {
  if (!currentResident) {
    console.error('No hay residente actual para cargar paquetes');
    return;
  }
  
  try {
    residentPackages = getResidentPackages(currentResident.department);
    
    updateStats();
    updatePackagesTable();
    updatePackageSelector();
    updateNotifications();
    loadPickupHistory();
    loadSupportHistory();
  } catch (error) {
    console.error('Error al cargar paquetes del residente:', error);
    showToast('Error al cargar paquetes', 'error');
  }
}

// Función para actualizar estadísticas
function updateStats() {
  try {
    const totalPackages = residentPackages.length;
    const pendingPackages = residentPackages.filter(pkg => pkg.status === 'pendiente').length;
    const deliveredPackages = residentPackages.filter(pkg => pkg.status === 'entregado' || pkg.status === 'retirado').length;
    
    const thisMonth = new Date().getMonth();
    const thisYear = new Date().getFullYear();
    const thisMonthPackages = residentPackages.filter(pkg => {
      const pkgDate = new Date(pkg.created_at || pkg.delivery_date);
      return pkgDate.getMonth() === thisMonth && pkgDate.getFullYear() === thisYear;
    }).length;

    document.getElementById('total-packages').textContent = totalPackages;
    document.getElementById('pending-packages').textContent = pendingPackages;
    document.getElementById('delivered-packages').textContent = deliveredPackages;
    document.getElementById('this-month-packages').textContent = thisMonthPackages;
    document.getElementById('notification-count').textContent = pendingPackages;
  } catch (error) {
    console.error('Error al actualizar estadísticas:', error);
  }
}

// Función para actualizar tabla de paquetes
function updatePackagesTable(filter = 'all') {
  const tableBody = document.getElementById('packages-table');
  
  try {
    let packagesToShow = [...residentPackages];
    
    // Aplicar filtro
    switch (filter) {
      case 'pending':
        packagesToShow = packagesToShow.filter(pkg => pkg.status === 'pendiente');
        break;
      case 'delivered':
        packagesToShow = packagesToShow.filter(pkg => pkg.status === 'entregado' || pkg.status === 'retirado');
        break;
      case 'this-month':
        const thisMonth = new Date().getMonth();
        const thisYear = new Date().getFullYear();
        packagesToShow = packagesToShow.filter(pkg => {
          const pkgDate = new Date(pkg.created_at || pkg.delivery_date);
          return pkgDate.getMonth() === thisMonth && pkgDate.getFullYear() === thisYear;
        });
        break;
    }
    
    if (packagesToShow.length === 0) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="5">
            <div class="empty-state">
              <p>No se encontraron paquetes${filter !== 'all' ? ' con el filtro aplicado' : ''}</p>
            </div>
          </td>
        </tr>
      `;
      return;
    }

    // Ordenar por fecha más reciente
    const sortedPackages = packagesToShow.sort((a, b) => {
      const dateA = new Date(a.created_at || a.delivery_date || 0);
      const dateB = new Date(b.created_at || b.delivery_date || 0);
      return dateB - dateA;
    });

    // Mostrar solo los 10 más recientes para el dashboard
    const recentPackages = filter === 'all' ? sortedPackages.slice(0, 10) : sortedPackages;
    
    let tableContent = '';
    recentPackages.forEach(pkg => {
      const status = pkg.status || 'pendiente';
      const statusClass = status === 'pendiente' ? 'status-pending' : 'status-delivered';
      const statusText = status.charAt(0).toUpperCase() + status.slice(1);
      
      let formattedDate = 'No disponible';
      if (pkg.delivery_date) {
        try {
          const date = new Date(pkg.delivery_date);
          formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
        } catch (e) {
          formattedDate = pkg.delivery_date;
        }
      }

      const displayId = pkg.id && pkg.id.length > 15 ? 
        pkg.id.substring(0, 15) + '...' : 
        (pkg.id || 'Sin ID');

      tableContent += `
        <tr>
          <td title="${pkg.id || 'Sin ID'}">${displayId}</td>
          <td>${pkg.sender || 'No especificado'}</td>
          <td>${formattedDate}</td>
          <td><span class="status ${statusClass}">${statusText}</span></td>
          <td>
            <button class="action-btn btn-info" onclick="viewPackageDetails('${pkg.id}')">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
              Ver
            </button>
            ${status === 'pendiente' ? 
              `<button class="action-btn btn-success" onclick="requestPickup('${pkg.id}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11H1l6-6v4.5c2.5 0 5 2.5 5 6z"></path><path d="M22 12c0 3.5-2.5 6-5 6-1.4 0-2.7-.6-3.7-1.6"></path></svg>
                Retirar
              </button>` : ''
            }
          </td>
        </tr>
      `;
    });
    
    tableBody.innerHTML = tableContent;
  } catch (error) {
    console.error('Error al actualizar tabla de paquetes:', error);
    tableBody.innerHTML = `
      <tr>
        <td colspan="5">
          <div class="empty-state">
            <p>Error al cargar paquetes</p>
          </div>
        </td>
      </tr>
    `;
  }
}

// Función para actualizar selector de paquetes
function updatePackageSelector() {
  const packageSelect = document.getElementById('package-select');
  
  try {
    const pendingPackages = residentPackages.filter(pkg => pkg.status === 'pendiente');
    
    packageSelect.innerHTML = '<option value="">Seleccione un paquete pendiente</option>';
    
    pendingPackages.forEach(pkg => {
      const option = document.createElement('option');
      option.value = pkg.id;
      option.textContent = `${pkg.id} - ${pkg.sender || 'Sin remitente'} (${pkg.delivery_date ? new Date(pkg.delivery_date).toLocaleDateString() : 'Sin fecha'})`;
      packageSelect.appendChild(option);
    });
  } catch (error) {
    console.error('Error al actualizar selector de paquetes:', error);
  }
}

// Función para actualizar notificaciones
function updateNotifications() {
  const notificationsList = document.getElementById('notifications-list');
  
  try {
    const pendingPackages = residentPackages.filter(pkg => pkg.status === 'pendiente');
    
    if (pendingPackages.length === 0) {
      notificationsList.innerHTML = `
        <li class="notification-item">
          <div class="notification-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
          </div>
          <div class="notification-info">
            <h4 class="notification-title">¡Todo al día!</h4>
            <p>No tienes paquetes pendientes de retirar.</p>
            <span class="notification-time">Ahora</span>
          </div>
        </li>
      `;
      return;
    }

    let notificationsHTML = '';
    pendingPackages.forEach(pkg => {
      const daysSince = Math.floor((Date.now() - new Date(pkg.created_at || pkg.delivery_date)) / (1000 * 60 * 60 * 24));
      
      notificationsHTML += `
        <li class="notification-item" onclick="viewPackageDetails('${pkg.id}')">
          <div class="notification-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg>
          </div>
          <div class="notification-info">
            <h4 class="notification-title">Paquete pendiente de retiro</h4>
            <p>Tienes un paquete de ${pkg.sender || 'remitente desconocido'} esperando por ti (${pkg.id}).</p>
            <span class="notification-time">${daysSince === 0 ? 'Hoy' : `Hace ${daysSince} día${daysSince !== 1 ? 's' : ''}`}</span>
          </div>
        </li>
      `;
    });
    
    notificationsList.innerHTML = notificationsHTML;
  } catch (error) {
    console.error('Error al actualizar notificaciones:', error);
  }
}

// Funciones para mostrar paquetes filtrados
function showAllPackages() {
  updatePackagesTable('all');
  currentPackageFilter = 'all';
  showToast('Mostrando todos los paquetes', 'info');
}

function showPendingPackages() {
  updatePackagesTable('pending');
  currentPackageFilter = 'pending';
  showToast('Mostrando paquetes pendientes', 'info');
}

function showDeliveredPackages() {
  updatePackagesTable('delivered');
  currentPackageFilter = 'delivered';
  showToast('Mostrando paquetes entregados', 'info');
}

function showThisMonthPackages() {
  updatePackagesTable('this-month');
  currentPackageFilter = 'this-month';
  showToast('Mostrando paquetes de este mes', 'info');
}

// Función para filtrar paquetes
function filterPackages() {
  showToast('Función de filtro avanzado en desarrollo', 'warning');
}

// Función para ver detalles de paquete
function viewPackageDetails(packageId) {
  const pkg = residentPackages.find(p => p.id === packageId);
  if (!pkg) {
    showToast('Paquete no encontrado', 'error');
    return;
  }
  
  const modal = document.getElementById('package-modal');
  const modalContent = document.getElementById('package-modal-content');
  
  const status = pkg.status || 'pendiente';
  const statusClass = status === 'pendiente' ? 'status-pending' : 'status-delivered';
  const statusText = status.charAt(0).toUpperCase() + status.slice(1);
  
  let formattedDate = 'No disponible';
  if (pkg.delivery_date) {
    try {
      const date = new Date(pkg.delivery_date);
      formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
    } catch (e) {
      formattedDate = pkg.delivery_date;
    }
  }

  modalContent.innerHTML = `
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
      <div>
        <table style="width: 100%;">
          <tr>
            <td style="padding: 10px 0; font-weight: 600;">ID:</td>
            <td>${pkg.id}</td>
          </tr>
          <tr>
            <td style="padding: 10px 0; font-weight: 600;">Remitente:</td>
            <td>${pkg.sender || 'No especificado'}</td>
          </tr>
          <tr>
            <td style="padding: 10px 0; font-weight: 600;">Descripción:</td>
            <td>${pkg.description || 'Sin descripción'}</td>
          </tr>
          <tr>
            <td style="padding: 10px 0; font-weight: 600;">Tamaño:</td>
            <td>${pkg.size || 'No especificado'}</td>
          </tr>
          <tr>
            <td style="padding: 10px 0; font-weight: 600;">Peso:</td>
            <td>${pkg.weight || 'No especificado'}</td>
          </tr>
          <tr>
            <td style="padding: 10px 0; font-weight: 600;">Fecha de llegada:</td>
            <td>${formattedDate}</td>
          </tr>
          <tr>
            <td style="padding: 10px 0; font-weight: 600;">Estado:</td>
            <td><span class="status ${statusClass}">${statusText}</span></td>
          </tr>
        </table>
      </div>
      <div>
        <h4 style="margin-bottom: 15px;">Histórico del paquete</h4>
        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
          <div style="color: green; font-size: 18px;">✓</div>
          <div>
            <div>Paquete recibido</div>
            <div style="font-size: 12px; color: #777;">${formattedDate}</div>
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
          <div style="color: green; font-size: 18px;">✓</div>
          <div>
            <div>Notificación enviada</div>
            <div style="font-size: 12px; color: #777;">${formattedDate}</div>
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
          <div style="color: ${status === 'pendiente' ? 'orange' : 'green'}; font-size: 18px;">${status === 'pendiente' ? '⟳' : '✓'}</div>
          <div>
            <div>${status === 'pendiente' ? 'En espera de retiro' : 'Paquete entregado'}</div>
            <div style="font-size: 12px; color: #777;">${status === 'pendiente' ? 'Actual' : formattedDate}</div>
          </div>
        </div>
      </div>
    </div>
    
    ${status === 'pendiente' ? `
    <div style="display: flex; gap: 15px; justify-content: center; padding-top: 20px; border-top: 1px solid var(--gray-light);">
      <button class="action-btn" onclick="requestPickup('${pkg.id}'); closeModal('package-modal');">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11H1l6-6v4.5c2.5 0 5 2.5 5 6z"></path><path d="M22 12c0 3.5-2.5 6-5 6-1.4 0-2.7-.6-3.7-1.6"></path></svg>
        Solicitar Retiro
      </button>
      <button class="action-btn btn-secondary" onclick="reportProblem('${pkg.id}'); closeModal('package-modal');">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        Reportar Problema
      </button>
    </div>
    ` : ''}
  `;
  
  modal.style.display = 'flex';
}

// Función para solicitar retiro rápido
function requestPickup(packageId) {
  switchTab('solicitud');
  
  const packageSelect = document.getElementById('package-select');
  packageSelect.value = packageId;
  
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  document.getElementById('pickup-date').value = tomorrow.toISOString().split('T')[0];
  
  showToast('Formulario de retiro preparado', 'info');
}

// Función para reportar problema
function reportProblem(packageId) {
  switchTab('soporte');
  document.getElementById('support-subject').value = 'problema-paquete';
  document.getElementById('support-message').value = `Tengo un problema con el paquete ${packageId}. Descripción del problema: `;
  document.getElementById('support-message').focus();
  showToast('Formulario de soporte preparado', 'info');
}

// Función para buscar paquete
function searchPackage(packageId = null) {
  const searchId = packageId || document.getElementById('search-package').value.trim();
  const resultsDiv = document.getElementById('tracking-results');
  
  if (!searchId) {
    resultsDiv.innerHTML = `
      <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="M21 21l-4.35-4.35"></path></svg>
        <p>Ingrese un ID de paquete para ver los detalles</p>
      </div>
    `;
    return;
  }

  const pkg = residentPackages.find(p => p.id === searchId || p.id.includes(searchId));
  
  if (!pkg) {
    resultsDiv.innerHTML = `
      <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        <p>No se encontró el paquete con ID: ${searchId}</p>
        <p style="font-size: 0.9rem; color: var(--gray);">Verifica que el ID sea correcto y que el paquete sea tuyo.</p>
      </div>
    `;
    return;
  }

  // Mostrar detalles del paquete
  const status = pkg.status || 'pendiente';
  const statusClass = status === 'pendiente' ? 'status-pending' : 'status-delivered';
  const statusText = status.charAt(0).toUpperCase() + status.slice(1);
  
  let formattedDate = 'No disponible';
  if (pkg.delivery_date) {
    try {
      const date = new Date(pkg.delivery_date);
      formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
    } catch (e) {
      formattedDate = pkg.delivery_date;
    }
  }

  resultsDiv.innerHTML = `
    <h3 style="margin-bottom: 20px;">Detalle del Paquete: ${pkg.id}</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
      <div>
        <table style="width: 100%;">
          <tr>
            <td style="padding: 10px 0; font-weight: 600;">ID:</td>
            <td>${pkg.id}</td>
          </tr>
          <tr>
            <td style="padding: 10px 0; font-weight: 600;">Remitente:</td>
            <td>${pkg.sender || 'No especificado'}</td>
          </tr>
          <tr>
            <td style="padding: 10px 0; font-weight: 600;">Descripción:</td>
            <td>${pkg.description || 'Sin descripción'}</td>
          </tr>
          <tr>
            <td style="padding: 10px 0; font-weight: 600;">Fecha de llegada:</td>
            <td>${formattedDate}</td>
          </tr>
          <tr>
            <td style="padding: 10px 0; font-weight: 600;">Estado:</td>
            <td><span class="status ${statusClass}">${statusText}</span></td>
          </tr>
        </table>
      </div>
      <div>
        <h4 style="margin-bottom: 15px;">Histórico del paquete</h4>
        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
          <div style="color: green; font-size: 18px;">✓</div>
          <div>
            <div>Paquete recibido</div>
            <div style="font-size: 12px; color: #777;">${formattedDate}</div>
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
          <div style="color: green; font-size: 18px;">✓</div>
          <div>
            <div>Notificación enviada</div>
            <div style="font-size: 12px; color: #777;">${formattedDate}</div>
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
          <div style="color: ${status === 'pendiente' ? 'orange' : 'green'}; font-size: 18px;">${status === 'pendiente' ? '⟳' : '✓'}</div>
          <div>
            <div>${status === 'pendiente' ? 'En espera de retiro' : 'Paquete entregado'}</div>
            <div style="font-size: 12px; color: #777;">${status === 'pendiente' ? 'Actual' : formattedDate}</div>
          </div>
        </div>
      </div>
    </div>
    
    ${status === 'pendiente' ? `
    <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center;">
      <button class="action-btn" onclick="requestPickup('${pkg.id}')">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11H1l6-6v4.5c2.5 0 5 2.5 5 6z"></path><path d="M22 12c0 3.5-2.5 6-5 6-1.4 0-2.7-.6-3.7-1.6"></path></svg>
        Solicitar Retiro
      </button>
      <button class="action-btn btn-secondary" onclick="reportProblem('${pkg.id}')">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        Reportar Problema
      </button>
    </div>
    ` : ''}
  `;
}

// Función para limpiar búsqueda
function clearSearch() {
  document.getElementById('search-package').value = '';
  const resultsDiv = document.getElementById('tracking-results');
  resultsDiv.innerHTML = `
    <div class="empty-state">
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="M21 21l-4.35-4.35"></path></svg>
      <p>Ingrese un ID de paquete para ver los detalles</p>
    </div>
  `;
}

// Función para cambiar pestañas
function switchTab(tabId) {
  // Ocultar todas las pestañas
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Actualizar menú
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
  });
  
  // Mostrar la pestaña seleccionada
  document.getElementById(tabId).classList.add('active');
  
  // Actualizar clase active en el menú
  const menuItem = document.querySelector(`.nav-item[data-tab="${tabId}"]`);
  if (menuItem) {
    menuItem.classList.add('active');
  }
  
  // Actualizar título
  const tabTitles = {
    dashboard: 'Dashboard',
    tracking: 'Seguimiento y Tracking',
    notificaciones: 'Notificaciones',
    solicitud: 'Solicitar Retiro',
    soporte: 'Soporte y Contacto'
  };
  
  document.querySelector('.page-title').textContent = tabTitles[tabId] || 'Dashboard';
}

// Función para mostrar notificación toast
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = `toast ${type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : ''}`;
  toast.style.display = 'block';
  
  setTimeout(() => {
    toast.style.display = 'none';
  }, 3000);
}

// Función para cerrar modal
function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
}

// Función para cerrar sesión
function logout() {
  const keysToRemove = [
    'authToken', 'userName', 'userType', 'isLoggedIn', 
    'currentResidentId', 'currentResident', 'currentUser',
    'loginTime', 'sessionData'
  ];
  
  keysToRemove.forEach(key => {
    localStorage.removeItem(key);
  });
  
  window.location.href = 'login.html';
}

// Función para procesar solicitud de retiro
function processPickupRequest(event) {
  event.preventDefault();
  
  const packageId = document.getElementById('package-select').value;
  const pickupDate = document.getElementById('pickup-date').value;
  const pickupTime = document.getElementById('pickup-time').value;
  const comments = document.getElementById('pickup-comments').value;
  const retirador = document.querySelector('input[name="retirador"]:checked').value;
  
  if (!packageId) {
    showToast('Por favor selecciona un paquete', 'error');
    return;
  }
  
  if (!pickupDate) {
    showToast('Por favor selecciona una fecha de retiro', 'error');
    return;
  }
  
  if (!pickupTime) {
    showToast('Por favor selecciona una hora', 'error');
    return;
  }
  
  // Validar campos de persona autorizada si se seleccionó "otra persona"
  if (retirador === 'other') {
    const authorizedName = document.getElementById('authorized-name').value.trim();
    const authorizedId = document.getElementById('authorized-id').value.trim();
    
    if (!authorizedName || !authorizedId) {
      showToast('Por favor completa los datos de la persona autorizada', 'error');
      return;
    }
  }
  
  const pickupRequest = {
    id: 'REQ-' + Date.now(),
    packageId: packageId,
    residentId: currentResident.id,
    residentName: `${currentResident.name} ${currentResident.lastname}`,
    department: currentResident.department,
    pickupDate: pickupDate,
    pickupTime: pickupTime,
    retirador: retirador,
    authorizedName: retirador === 'other' ? document.getElementById('authorized-name').value : null,
    authorizedId: retirador === 'other' ? document.getElementById('authorized-id').value : null,
    comments: comments,
    status: 'pendiente',
    createdAt: new Date().toISOString()
  };
  
  const existingRequests = JSON.parse(localStorage.getItem('pickupRequests') || '[]');
  existingRequests.push(pickupRequest);
  localStorage.setItem('pickupRequests', JSON.stringify(existingRequests));
  
  showToast('Solicitud de retiro enviada correctamente');
  clearPickupForm();
  loadPickupHistory();
}

// Función para limpiar formulario de retiro
function clearPickupForm() {
  document.getElementById('pickup-form').reset();
  document.getElementById('authorized-fields').style.display = 'none';
}

// Función para cargar historial de solicitudes de retiro
function loadPickupHistory() {
  const historyDiv = document.getElementById('pickup-history');
  
  try {
    const allRequests = JSON.parse(localStorage.getItem('pickupRequests') || '[]');
    const userRequests = allRequests.filter(req => req.residentId === currentResident.id);
    
    if (userRequests.length === 0) {
      historyDiv.innerHTML = `
        <div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
          <p>No tienes solicitudes de retiro registradas</p>
        </div>
      `;
      return;
    }
    
    // Ordenar por fecha más reciente
    const sortedRequests = userRequests.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    let historyHTML = '<div style="display: grid; gap: 15px;">';
    
    sortedRequests.slice(0, 5).forEach(req => {
      const date = new Date(req.createdAt);
      const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
      const statusClass = req.status === 'pendiente' ? 'status-pending' : req.status === 'aprobada' ? 'status-delivered' : 'status-warning';
      
      historyHTML += `
        <div style="background: white; border: 1px solid var(--gray-light); border-radius: 8px; padding: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h4>Solicitud ${req.id}</h4>
            <span class="status ${statusClass}">${req.status.charAt(0).toUpperCase() + req.status.slice(1)}</span>
          </div>
          <p><strong>Paquete:</strong> ${req.packageId}</p>
          <p><strong>Fecha solicitada:</strong> ${new Date(req.pickupDate).toLocaleDateString()}</p>
          <p><strong>Hora:</strong> ${req.pickupTime === 'morning' ? 'Mañana (9:00-13:00)' : req.pickupTime === 'afternoon' ? 'Tarde (14:00-18:00)' : 'Noche (19:00-21:00)'}</p>
          <p><strong>Retira:</strong> ${req.retirador === 'self' ? 'Residente' : `${req.authorizedName} (${req.authorizedId})`}</p>
          <p><strong>Fecha de solicitud:</strong> ${formattedDate}</p>
          ${req.comments ? `<p><strong>Comentarios:</strong> ${req.comments}</p>` : ''}
        </div>
      `;
    });
    
    historyHTML += '</div>';
    historyDiv.innerHTML = historyHTML;
    
  } catch (error) {
    console.error('Error al cargar historial de solicitudes:', error);
    historyDiv.innerHTML = `
      <div class="empty-state">
        <p>Error al cargar el historial</p>
      </div>
    `;
  }
}

// Función para procesar mensaje de soporte
function processSupportMessage(event) {
  event.preventDefault();
  
  const subject = document.getElementById('support-subject').value;
  const message = document.getElementById('support-message').value.trim();
  
  if (!subject) {
    showToast('Por favor selecciona un asunto', 'error');
    return;
  }
  
  if (!message) {
    showToast('Por favor ingresa un mensaje', 'error');
    return;
  }
  
  const supportMessage = {
    id: 'MSG-' + Date.now(),
    residentId: currentResident.id,
    residentName: `${currentResident.name} ${currentResident.lastname}`,
    department: currentResident.department,
    email: currentResident.email,
    subject: subject,
    message: message,
    status: 'nuevo',
    createdAt: new Date().toISOString()
  };
  
  const existingMessages = JSON.parse(localStorage.getItem('supportMessages') || '[]');
  existingMessages.push(supportMessage);
  localStorage.setItem('supportMessages', JSON.stringify(existingMessages));
  
  showToast('Mensaje enviado correctamente al soporte');
  clearSupportForm();
  loadSupportHistory();
}

// Función para limpiar formulario de soporte
function clearSupportForm() {
  document.getElementById('support-form').reset();
}

// Función para cargar historial de mensajes de soporte
function loadSupportHistory() {
  const historyDiv = document.getElementById('support-history');
  
  try {
    const allMessages = JSON.parse(localStorage.getItem('supportMessages') || '[]');
    const userMessages = allMessages.filter(msg => msg.residentId === currentResident.id);
    
    if (userMessages.length === 0) {
      historyDiv.innerHTML = `
        <div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
          <p>No has enviado mensajes de soporte</p>
        </div>
      `;
      return;
    }
    
    // Ordenar por fecha más reciente
    const sortedMessages = userMessages.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    let historyHTML = '<div style="display: grid; gap: 15px;">';
    
    sortedMessages.slice(0, 5).forEach(msg => {
      const date = new Date(msg.createdAt);
      const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
      const statusClass = msg.status === 'nuevo' ? 'status-pending' : msg.status === 'respondido' ? 'status-delivered' : 'status-warning';
      
      historyHTML += `
        <div style="background: white; border: 1px solid var(--gray-light); border-radius: 8px; padding: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h4>${msg.subject}</h4>
            <span class="status ${statusClass}">${msg.status.charAt(0).toUpperCase() + msg.status.slice(1)}</span>
          </div>
          <p style="margin-bottom: 10px; color: var(--gray);">${msg.message}</p>
          <small style="color: var(--gray);">Enviado el ${formattedDate}</small>
        </div>
      `;
    });
    
    historyHTML += '</div>';
    historyDiv.innerHTML = historyHTML;
    
  } catch (error) {
    console.error('Error al cargar historial de soporte:', error);
    historyDiv.innerHTML = `
      <div class="empty-state">
        <p>Error al cargar el historial</p>
      </div>
    `;
  }
}

// Funciones de perfil de usuario
function editProfile() {
  showToast('Función de editar perfil en desarrollo', 'info');
  // Aquí se podría abrir un modal con formulario de edición
}

function changePassword() {
  showToast('Función de cambiar contraseña en desarrollo', 'info');
  // Aquí se podría abrir un modal para cambiar contraseña
}

function viewSettings() {
  showToast('Función de configuración en desarrollo', 'info');
  // Aquí se podrían mostrar configuraciones del usuario
}

// Funciones de contacto
function callBuilding() {
  const phone = document.getElementById('building-phone').textContent;
  if (confirm(`¿Deseas llamar a ${phone}?`)) {
    window.open(`tel:${phone}`);
  }
}

function emailBuilding() {
  const email = document.getElementById('building-email').textContent;
  const subject = encodeURIComponent('Consulta desde Panel de Residente');
  const body = encodeURIComponent(`Hola,\n\nSoy ${currentResident.name} ${currentResident.lastname} del departamento ${currentResident.department}.\n\nConsulta:\n\n`);
  window.open(`mailto:${email}?subject=${subject}&body=${body}`);
}

function showBuildingLocation() {
  const address = document.getElementById('building-address').textContent;
  const encodedAddress = encodeURIComponent(address);
  window.open(`https://www.google.com/maps/search/?api=1&query=${encodedAddress}`, '_blank');
}

// Función para marcar todas las notificaciones como leídas
function markAllAsRead() {
  showToast('Todas las notificaciones marcadas como leídas');
  document.getElementById('notification-count').textContent = '0';
}

// Función para mostrar/ocultar dropdown de usuario
function toggleUserDropdown() {
  const dropdown = document.getElementById('user-dropdown');
  dropdown.classList.toggle('show');
}

// Cerrar dropdown si se hace click fuera
document.addEventListener('click', function(event) {
  const userProfile = document.getElementById('user-profile');
  const dropdown = document.getElementById('user-dropdown');
  
  if (!userProfile.contains(event.target)) {
    dropdown.classList.remove('show');
  }
});

// Inicializar aplicación cuando el documento está listo
document.addEventListener('DOMContentLoaded', function() {
  showLoading(true);
  
  try {
    // Inicializar datos de prueba
    initializeTestData();
    
    // Verificar autenticación
    if (!validateAuthentication()) {
      showLoading(false);
      logout();
      return;
    }

    // Cargar información del residente
    if (!loadResidentInfo()) {
      showLoading(false);
      return;
    }
    
    // Cargar paquetes del residente
    loadResidentPackages();
    
    // Configurar event listeners
    setupEventListeners();
    
    showLoading(false);
    showToast('¡Bienvenido al panel de residente!');
    
  } catch (error) {
    console.error('Error al inicializar la aplicación:', error);
    showLoading(false);
    showToast('Error al cargar la aplicación', 'error');
    setTimeout(logout, 3000);
  }
});

// Función para configurar event listeners
function setupEventListeners() {
  // Manejar cambio de pestañas desde menú
  document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', function() {
      const tabId = this.getAttribute('data-tab');
      if (tabId) {
        switchTab(tabId);
      }
    });
  });
  
  // Manejar botones de cambio de pestaña
  document.querySelectorAll('.btn-cambiar-tab').forEach(btn => {
    btn.addEventListener('click', function() {
      const tabId = this.getAttribute('data-tab');
      switchTab(tabId);
    });
  });
  
  // Manejar cambio de radio buttons para persona autorizada
  document.querySelectorAll('input[name="retirador"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const authorizedFields = document.getElementById('authorized-fields');
      if (document.getElementById('other').checked) {
        authorizedFields.style.display = 'block';
      } else {
        authorizedFields.style.display = 'none';
      }
    });
  });
  
  // Manejar dropdown de usuario
  document.getElementById('user-profile').addEventListener('click', function(e) {
    e.stopPropagation();
    toggleUserDropdown();
  });
  
  // Manejar click en icono de notificaciones
  document.getElementById('notification-icon').addEventListener('click', function() {
    switchTab('notificaciones');
  });
  
  // Manejar envío de formularios
  document.getElementById('pickup-form').addEventListener('submit', processPickupRequest);
  document.getElementById('support-form').addEventListener('submit', processSupportMessage);
  
  // Manejar actualización de paquetes
  document.getElementById('btn-actualizar').addEventListener('click', function() {
    showLoading(true);
    setTimeout(() => {
      loadResidentPackages();
      showLoading(false);
      showToast('Información actualizada');
    }, 1000);
  });
  
  // Manejar búsqueda de tracking
  document.getElementById('buscar-tracking').addEventListener('click', function() {
    searchPackage();
  });
  
  // Permitir búsqueda con Enter
  document.getElementById('search-package').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      searchPackage();
    }
  });
  
  // Menú móvil
  document.getElementById('mobile-menu')?.addEventListener('click', function() {
    document.getElementById('sidebar').classList.toggle('active');
  });
  
  // Cerrar modales con click fuera
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
  });
  
  // Establecer fecha mínima para solicitud de retiro (mañana)
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  document.getElementById('pickup-date').min = tomorrow.toISOString().split('T')[0];
}

// Hacer funciones globales para botones inline
window.viewPackageDetails = viewPackageDetails;
window.requestPickup = requestPickup;
window.reportProblem = reportProblem;
window.switchTab = switchTab;
window.logout = logout;
window.closeModal = closeModal;
window.clearSearch = clearSearch;
window.clearPickupForm = clearPickupForm;
window.clearSupportForm = clearSupportForm;
window.showAllPackages = showAllPackages;
window.showPendingPackages = showPendingPackages;
window.showDeliveredPackages = showDeliveredPackages;
window.showThisMonthPackages = showThisMonthPackages;
window.filterPackages = filterPackages;
window.markAllAsRead = markAllAsRead;
window.editProfile = editProfile;
window.changePassword = changePassword;
window.viewSettings = viewSettings;
window.callBuilding = callBuilding;
window.emailBuilding = emailBuilding;
window.showBuildingLocation = showBuildingLocation;
</script>
</body>
</html>