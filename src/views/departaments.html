<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Administración de Departamentos - Gestión de Paquetes</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
--primary: #f39c12;
--primary-dark: #e67e22;
--primary-light: #fef9c3;
--secondary: #2c3e50;
--accent: #e74c3c;
--accent-dark: #c0392b;
--accent-light: #fadbd8;
--success: #27ae60;
--success-light: #e8f5e9;
--danger: #e74c3c;
--danger-dark: #c0392b;
--danger-light: #ffebee;
--warning: #f39c12;
--warning-dark: #e67e22;
--warning-light: #fff8e1;
--info: #3498db;
--info-light: #e3f2fd;
--light: #f8f9fa;
--dark: #212529;
--gray: #6c757d;
--gray-light: #e9ecef;
--gray-50: #f8f9fa;
--gray-100: #f1f5f9;
--gray-200: #e2e8f0;
--gray-300: #cbd5e1;
--gray-700: #334155;
--shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
--shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
--shadow-md: 0 10px 15px rgba(0, 0, 0, 0.1);
--radius-sm: 0.375rem;
--radius: 0.5rem;
--radius-md: 0.75rem;
--radius-lg: 1rem;
 }
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
 }
html, body {
height: 100%;
width: 100%;
overflow-x: hidden;
 }
body {
background-color: #f1cc90;
color: var(--dark);
display: flex;
min-height: 100vh;
 }
/* Sidebar styles */
.sidebar {
width: 250px;
background-color: #fff;
box-shadow: var(--shadow);
transition: all 0.3s ease;
z-index: 1000;
 }
.sidebar-header {
padding: 20px;
border-bottom: 1px solid var(--gray-light);
display: flex;
align-items: center;
justify-content: center;
 }
.logo {
font-size: 1.3rem;
font-weight: bold;
color: var(--primary);
display: flex;
align-items: center;
gap: 8px;
text-decoration: none;
 }
.logo img {
height: 40px;
width: auto;
object-fit: contain;
 }
.nav-menu {
list-style: none;
padding: 20px 0;
 }
.nav-item {
padding: 12px 20px;
display: flex;
align-items: center;
gap: 10px;
color: var(--gray);
font-weight: 500;
cursor: pointer;
transition: all 0.3s ease;
margin-bottom: 5px;
 }
.nav-item:hover {
background-color: rgba(243, 156, 18, 0.1);
color: var(--primary);
 }
.nav-item.active {
background-color: rgba(243, 156, 18, 0.15);
color: var(--primary);
border-left: 3px solid var(--primary);
 }
.nav-item i {
width: 20px;
text-align: center;
 }
/* Main content styles */
.main-content {
flex: 1;
padding: 20px;
background-color: #fbf5ee;
transition: all 0.3s ease;
 }
.header {
display: flex;
justify-content: space-between;
align-items: center;
padding: 15px 0;
margin-bottom: 30px;
 }
.page-title {
font-size: 1.5rem;
font-weight: 600;
color: var(--dark);
 }
.card {
background-color: #fff;
border-radius: 10px;
box-shadow: var(--shadow);
margin-bottom: 20px;
overflow: hidden;
 }
.card-header {
padding: 15px 20px;
border-bottom: 1px solid var(--gray-light);
font-weight: 600;
display: flex;
justify-content: space-between;
align-items: center;
 }
.card-body {
padding: 20px;
 }
.btn {
display: inline-flex;
align-items: center;
gap: 8px;
padding: 8px 16px;
border-radius: 6px;
font-weight: 500;
cursor: pointer;
transition: all 0.3s ease;
border: none;
font-size: 0.9rem;
text-decoration: none;
 }
.btn-primary {
background-color: var(--primary);
color: white;
 }
.btn-primary:hover {
background-color: var(--primary-dark);
transform: translateY(-2px);
box-shadow: var(--shadow-sm);
 }
.btn-accent {
background-color: var(--accent);
color: white;
 }
.btn-accent:hover {
background-color: var(--accent-dark);
transform: translateY(-2px);
box-shadow: var(--shadow-sm);
 }
.btn-success {
background-color: var(--success);
color: white;
 }
.btn-success:hover {
background-color: #145a32;
 }
.btn-danger {
background-color: var(--danger);
color: white;
 }
.btn-danger:hover {
background-color: var(--danger-dark);
 }
.btn-view {
background-color: var(--secondary);
color: white;
 }
.btn-view:hover {
background-color: #1a252f;
 }
.btn-outline {
background-color: transparent;
border: 1px solid var(--gray-300);
color: var(--gray-700);
 }
.btn-outline:hover {
background-color: var(--gray-50);
border-color: var(--gray-700);
 }
.table-container {
overflow-x: auto;
border-radius: var(--radius);
border: 1px solid var(--gray-200);
 }
table {
width: 100%;
border-collapse: collapse;
font-size: 0.9375rem;
 }
th, td {
padding: 1rem;
text-align: left;
border-bottom: 1px solid var(--gray-200);
 }
thead {
background-color: var(--gray-50);
 }
th {
font-weight: 600;
color: var(--gray-700);
text-transform: uppercase;
font-size: 0.75rem;
letter-spacing: 0.05em;
 }
tbody tr:hover {
background-color: var(--gray-50);
 }
tbody tr:last-child td {
border-bottom: none;
 }
.badge {
display: inline-block;
padding: 0.25rem 0.75rem;
border-radius: 9999px;
font-size: 0.75rem;
font-weight: 500;
display: inline-flex;
align-items: center;
gap: 5px;
 }
.badge-pending {
background-color: var(--warning-light);
color: var(--warning-dark);
 }
.badge-success {
background-color: var(--success-light);
color: var(--success);
 }

.badge-delivered {
background-color: var(--success-light);
color: var(--success);
 }

.badge-retired {
background-color: var(--info-light);
color: var(--info);
 }

.badge-info {
background-color: #e3f2fd;
color: #1976d2;
 }
.actions-cell {
display: flex;
gap: 0.5rem;
justify-content: flex-start;
flex-wrap: wrap;
 }
.error-message {
background-color: var(--danger-light);
color: var(--danger);
padding: 15px;
border-radius: var(--radius);
margin-bottom: 20px;
display: flex;
align-items: center;
gap: 10px;
 }
.loading-spinner {
border: 3px solid var(--gray-200);
border-top: 3px solid var(--primary);
border-radius: 50%;
width: 30px;
height: 30px;
animation: spin 1s linear infinite;
 }
@keyframes spin {
 0% { transform: rotate(0deg); }
 100% { transform: rotate(360deg); }
 }
.empty-state {
text-align: center;
padding: 40px 20px;
color: var(--gray);
 }
.empty-state i {
font-size: 3rem;
margin-bottom: 15px;
color: var(--gray-300);
 }
.empty-state p {
margin-bottom: 20px;
 }
.notification {
position: fixed;
bottom: 20px;
right: 20px;
padding: 12px 20px;
border-radius: 6px;
background-color: var(--success-light);
color: var(--success);
display: flex;
align-items: center;
gap: 10px;
box-shadow: var(--shadow);
opacity: 0;
transform: translateY(10px);
transition: all 0.3s ease;
z-index: 1000;
max-width: 90%;
 }
.notification.show {
opacity: 1;
transform: translateY(0);
 }
.notification.error {
background-color: var(--danger-light);
color: var(--danger);
 }
/* Responsive styles */
@media (max-width: 768px) {
.sidebar {
width: 70px;
 }
.sidebar .logo span,
.sidebar .nav-item span {
display: none;
 }
.sidebar .nav-item {
justify-content: center;
padding: 15px 0;
 }
.sidebar .nav-item i {
margin-right: 0;
 }
.sidebar .sidebar-header {
padding: 15px 0;
 }
.sidebar .logo {
justify-content: center;
 }
.sidebar .logo img {
height: 34px;
 }
.main-content {
padding: 15px;
 }
.header {
flex-direction: column;
align-items: flex-start;
gap: 15px;
 }
.actions-cell {
flex-direction: column;
width: 100%;
 }
.actions-cell .btn {
width: 100%;
 }
.card-header {
flex-direction: column;
gap: 10px;
 }
.card-header button {
width: 100%;
 }
 }
@media (max-width: 576px) {
.main-content {
padding: 10px;
 }
.card {
border-radius: 8px;
 }
.card-header, .card-body {
padding: 15px;
 }
th, td {
padding: 10px 8px;
 }
 }
</style>
</head>
<body>
<!-- Sidebar / Menú Lateral -->
<div class="sidebar">
<div class="sidebar-header">
<a href="dashboard.html" class="logo">
<img src="./images/favicon1.svg" alt="Logo Encomiendas">
<span>PackTrack</span>
</a>
</div>
<ul class="nav-menu">
<li class="nav-item" onclick="window.location.href='dashboard.html'">
<i class="fas fa-th-large"></i>
<span>Dashboard</span>
</li>
<li class="nav-item" onclick="window.location.href='registerPackage.html'">
<i class="fas fa-plus-square"></i>
<span>Registrar Paquete</span>
</li>
<li class="nav-item" onclick="window.location.href='listPackages.html'">
<i class="fas fa-list"></i>
<span>Lista de Paquetes</span>
</li>
<li class="nav-item active" onclick="window.location.href='departaments.html'">
<i class="fas fa-building"></i>
<span>Departamentos</span>
</li>
<li class="nav-item" onclick="window.location.href='codigoqr.html'">
<i class="fas fa-qrcode"></i>
<span>Lector QR</span>
</li>
<li class="nav-item " onclick="window.location.href='notificaciones.html'">
    <i class="fas fa-bell"></i>
    <span>Notificaciones</span>
</li>
<li class="nav-item" onclick="window.location.href='configuracion.html'">
<i class="fas fa-cog"></i>
<span>Configuración</span>
</li>
<li class="nav-item" onclick="logout()" style="margin-top: 50px; color: #e74c3c;">
<i class="fas fa-sign-out-alt"></i>
<span>Cerrar Sesión</span>
</li>
</ul>
</div>
<!-- Contenido Principal -->
<div class="main-content">
<div class="header">
<h1 class="page-title">Administración de Departamentos</h1>
</div>

<!-- Vista Principal de Departamentos -->
<div class="card" id="departmentsView">
<div class="card-header">
<h2 style="font-size: 1.2rem; font-weight: 600;">Departamentos Registrados</h2>
<div>
<button class="btn btn-danger" id="cleanDeptBtn" aria-label="Limpiar departamentos inválidos" style="margin-right: 10px;">
<i class="fas fa-trash-alt"></i>
<span>Limpiar</span>
</button>
<button class="btn btn-primary" id="addDeptBtn" aria-label="Agregar nuevo departamento">
<i class="fas fa-plus"></i>
<span>Agregar Departamento</span>
</button>
</div>
</div>
<div class="card-body">
<div id="errorMessage" class="error-message" style="display: none;">
<i class="fas fa-exclamation-circle"></i>
<span>Ha ocurrido un error al cargar los departamentos.</span>
</div>
<div class="table-container">
<table id="departmentsTable" aria-label="Lista de departamentos registrados">
<thead>
<tr>
<th scope="col">Número</th>
<th scope="col">Paquetes Pendientes</th>
<th scope="col">Paquetes Retirados</th>
<th scope="col">Acciones</th>
</tr>
</thead>
<tbody>
<tr>
<td colspan="4" style="text-align: center;">
<div class="loading-spinner" role="status"></div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<!-- Vista de Paquetes por Departamento -->
<div class="card" id="packagesView" style="display: none;">
<div class="card-header">
<h2 style="font-size: 1.2rem; font-weight: 600;" id="packageViewTitle">Paquetes del Departamento</h2>
<div>
<button class="btn btn-secondary" id="backToDeptBtn" aria-label="Volver a departamentos">
<i class="fas fa-arrow-left"></i>
<span>Volver a Departamentos</span>
</button>
<button class="btn btn-primary" id="addPackageBtn" aria-label="Agregar nuevo paquete" style="margin-left: 10px;">
<i class="fas fa-plus"></i>
<span>Agregar Paquete</span>
</button>
</div>
</div>
<div class="card-body">
<div id="packageErrorMessage" class="error-message" style="display: none;">
<i class="fas fa-exclamation-circle"></i>
<span>Ha ocurrido un error al cargar los paquetes.</span>
</div>
<div class="table-container">
<table id="packagesTable" aria-label="Lista de paquetes del departamento">
<thead>
<tr>
<th scope="col">ID</th>
<th scope="col">Remitente</th>
<th scope="col">Destinatario</th>
<th scope="col">Fecha</th>
<th scope="col">Estado</th>
<th scope="col">Descripción</th>
<th scope="col">Acciones</th>
</tr>
</thead>
<tbody>
<tr>
<td colspan="7" style="text-align: center;">
<div class="loading-spinner" role="status"></div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<!-- Notificación -->
<div id="notification" class="notification">
<i class="fas fa-check-circle"></i>
<span id="notification-message">Operación completada con éxito</span>
</div>

<script>
// Función para mostrar notificaciones
function showNotification(message, isError = false) {
    const notification = document.getElementById('notification');
    const notificationMessage = document.getElementById('notification-message');
    
    if (!notification || !notificationMessage) return;
    
    notificationMessage.textContent = message;
    notification.classList.toggle('error', isError);
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

// Función para cerrar sesión
function logout() {
    try {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userName');
        localStorage.removeItem('userType');
        localStorage.removeItem('isLoggedIn');
        window.location.href = 'login.html';
    } catch (error) {
        console.error('Error al cerrar sesión:', error);
        window.location.href = 'login.html';
    }
}

// Función mejorada para validar si un valor es un número de departamento válido
function isValidDepartmentNumber(value) {
    if (value === null || value === undefined || value === '') {
        return false;
    }
    
    const cleanValue = String(value).trim();
    
    // Debe ser un número positivo
    if (!cleanValue || isNaN(cleanValue)) {
        return false;
    }
    
    const numValue = parseInt(cleanValue);
    return numValue > 0 && numValue <= 9999; // Rango razonable para números de departamento
}

// Función para extraer número válido de departamento - MEJORADA
function extractDepartmentNumber(dept) {
    console.log('Extrayendo número de departamento de:', dept);
    
    // Si es null o undefined, devolver null
    if (dept === null || dept === undefined) {
        console.log('Departamento es null o undefined');
        return null;
    }
    
    // Si es un objeto
    if (typeof dept === 'object' && dept !== null) {
        console.log('Departamento es objeto:', dept);
        
        // Buscar propiedades que contengan el número del departamento
        const possibleProperties = [
            'number', 'id', 'deptNumber', 'numero', 
            'departmentNumber', 'apartment_number', 'dept_number'
        ];
        
        for (let prop of possibleProperties) {
            const value = dept[prop];
            console.log(`Verificando propiedad ${prop}:`, value);
            
            if (isValidDepartmentNumber(value)) {
                const validNumber = String(value).trim();
                console.log(`Número válido encontrado en ${prop}:`, validNumber);
                return validNumber;
            }
        }
        
        console.log('No se encontró número válido en el objeto');
        return null;
    }
    
    // Si es un string o número primitivo
    console.log('Departamento es primitivo:', dept);
    if (isValidDepartmentNumber(dept)) {
        const validNumber = String(dept).trim();
        console.log('Número primitivo válido:', validNumber);
        return validNumber;
    }
    
    console.log('Número primitivo inválido');
    return null;
}

// Función para limpiar departamentos inválidos del localStorage
function cleanInvalidDepartments() {
    try {
        console.log('=== INICIANDO LIMPIEZA DE DEPARTAMENTOS ===');
        
        const deptsFromStorage = localStorage.getItem('departments');
        if (!deptsFromStorage) {
            console.log('No hay departamentos en localStorage');
            return [];
        }
        
        let departments;
        try {
            departments = JSON.parse(deptsFromStorage);
            console.log('Departamentos originales:', departments);
        } catch (parseError) {
            console.error('Error al parsear departamentos:', parseError);
            // Si hay error de parseo, eliminar y crear nuevo
            localStorage.removeItem('departments');
            return [];
        }
        
        let validDepartments = [];
        let removedCount = 0;
        
        if (Array.isArray(departments)) {
            departments.forEach((dept, index) => {
                console.log(`Procesando departamento ${index}:`, dept);
                const deptNumber = extractDepartmentNumber(dept);
                
                if (deptNumber) {
                    // Verificar que no esté duplicado
                    const isDuplicate = validDepartments.some(validDept => validDept.number === deptNumber);
                    if (!isDuplicate) {
                        validDepartments.push({ number: deptNumber });
                        console.log(`Departamento ${deptNumber} agregado como válido`);
                    } else {
                        console.log(`Departamento ${deptNumber} duplicado, omitido`);
                        removedCount++;
                    }
                } else {
                    console.log(`Departamento inválido removido:`, dept);
                    removedCount++;
                }
            });
        } else if (departments) {
            // Si es un solo objeto
            const deptNumber = extractDepartmentNumber(departments);
            if (deptNumber) {
                validDepartments.push({ number: deptNumber });
            } else {
                removedCount++;
            }
        }
        
        console.log(`Departamentos válidos: ${validDepartments.length}, Removidos: ${removedCount}`);
        
        // Actualizar localStorage con departamentos limpios
        localStorage.setItem('departments', JSON.stringify(validDepartments));
        
        if (removedCount > 0) {
            showNotification(`Se eliminaron ${removedCount} departamentos inválidos`, false);
        }
        
        console.log('=== LIMPIEZA COMPLETADA ===');
        console.log('Departamentos finales:', validDepartments);
        
        return validDepartments;
    } catch (error) {
        console.error('Error durante la limpieza:', error);
        return [];
    }
}

// Función para obtener todos los departamentos - COMPLETAMENTE REESCRITA
function getAllDepartments() {
    try {
        console.log("=== OBTENIENDO DEPARTAMENTOS ===");
        
        // Primero, limpiar departamentos inválidos
        let departments = cleanInvalidDepartments();
        
        // Si después de la limpieza no hay departamentos válidos, crear algunos por defecto
        if (departments.length === 0) {
            console.log("No hay departamentos válidos, creando por defecto");
            
            departments = [
                { number: '101' },
                { number: '102' },
                { number: '103' },
                { number: '201' }
            ];
            
            localStorage.setItem('departments', JSON.stringify(departments));
            console.log("Departamentos por defecto creados:", departments);
            showNotification('Se crearon departamentos por defecto', false);
        }
        
        console.log("Departamentos finales a retornar:", departments);
        return departments;
        
    } catch (error) {
        console.error("Error crítico al obtener departamentos:", error);
        showNotification('Error crítico al cargar departamentos', true);
        return [];
    }
}

// Función para obtener todos los paquetes
function getAllPackages() {
    try {
        const packagesData = localStorage.getItem('packages');
        if (packagesData) {
            return JSON.parse(packagesData);
        }
        
        const oldPackagesData = localStorage.getItem('paquetesPrueba');
        if (oldPackagesData) {
            return JSON.parse(oldPackagesData);
        }
        
        return [];
    } catch (error) {
        console.error('Error al cargar paquetes:', error);
        return [];
    }
}

// Función para obtener paquetes por departamento
function getPackagesByDepartment(deptId) {
    try {
        const packages = getAllPackages();
        return packages.filter(pkg => pkg.apartment_number === deptId.toString());
    } catch (error) {
        console.error(`Error al obtener paquetes del departamento ${deptId}:`, error);
        return [];
    }
}

// Función para obtener el resumen de un departamento
function getDepartmentSummary(deptId) {
    try {
        const packages = getPackagesByDepartment(deptId);
        return {
            departmentId: deptId,
            totalPackages: packages.length,
            pendingPackages: packages.filter(pkg => pkg.status === 'pendiente').length,
            deliveredPackages: packages.filter(pkg => pkg.status === 'retirado' || pkg.status === 'entregado').length
        };
    } catch (error) {
        console.error(`Error al obtener resumen del departamento ${deptId}:`, error);
        return {
            departmentId: deptId,
            totalPackages: 0,
            pendingPackages: 0,
            deliveredPackages: 0
        };
    }
}

// Función para eliminar un departamento
function deleteDepartment(deptId) {
    if (confirm(`¿Está seguro que desea eliminar el Departamento ${deptId}?`)) {
        try {
            const departments = getAllDepartments();
            
            const filteredDepts = departments.filter(dept => dept.number !== deptId.toString());
            
            localStorage.setItem('departments', JSON.stringify(filteredDepts));
            
            // También eliminar paquetes asociados al departamento
            const packages = getAllPackages();
            const filteredPackages = packages.filter(pkg => pkg.apartment_number !== deptId.toString());
            
            localStorage.setItem('packages', JSON.stringify(filteredPackages));
            localStorage.setItem('paquetesPrueba', JSON.stringify(filteredPackages));
            
            showNotification(`Departamento ${deptId} eliminado correctamente`);
            
            loadDepartments();
        } catch (error) {
            console.error('Error al eliminar departamento:', error);
            showNotification(`Error al eliminar departamento: ${error.message}`, true);
        }
    }
}

// Función para ver paquetes de un departamento
function viewDepartment(deptId) {
    console.log(`Viendo paquetes del departamento: ${deptId}`);
    
    // Cambiar a la vista de paquetes
    document.getElementById('departmentsView').style.display = 'none';
    document.getElementById('packagesView').style.display = 'block';
    
    // Actualizar título
    document.getElementById('packageViewTitle').textContent = `Paquetes del Departamento ${deptId}`;
    
    // Cargar paquetes del departamento
    loadPackagesByDepartment(deptId);
}

// Función para volver a la vista de departamentos
function backToDepartments() {
    document.getElementById('packagesView').style.display = 'none';
    document.getElementById('departmentsView').style.display = 'block';
}

// Función para formatear fecha de manera legible
function formatDateForDisplay(dateString) {
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('es-ES', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    } catch (error) {
        return dateString;
    }
}

// Función para obtener badge de estado
function getStatusBadge(status) {
    switch (status?.toLowerCase()) {
        case 'pendiente':
            return '<span class="badge badge-pending"><i class="fas fa-clock"></i> Pendiente</span>';
        case 'entregado':
            return '<span class="badge badge-delivered"><i class="fas fa-check"></i> Entregado</span>';
        case 'retirado':
            return '<span class="badge badge-retired"><i class="fas fa-hand-holding"></i> Retirado</span>';
        default:
            return '<span class="badge badge-info"><i class="fas fa-question"></i> ' + (status || 'Desconocido') + '</span>';
    }
}

// Función para cargar paquetes por departamento
function loadPackagesByDepartment(deptId) {
    const tbody = document.querySelector('#packagesTable tbody');
    const errorMessage = document.getElementById('packageErrorMessage');
    
    if (!tbody || !errorMessage) {
        console.error('No se encontraron elementos del DOM para paquetes');
        return;
    }
    
    errorMessage.style.display = 'none';
    
    tbody.innerHTML = `
        <tr>
            <td colspan="7" style="text-align: center;">
                <div class="loading-spinner" role="status"></div>
            </td>
        </tr>
    `;
    
    try {
        console.log(`Cargando paquetes para departamento: ${deptId}`);
        const packages = getPackagesByDepartment(deptId);
        console.log(`Paquetes encontrados:`, packages);
        
        if (!packages || packages.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px;">
                        <div style="color: var(--gray);">
                            <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 15px; color: var(--gray-300);"></i>
                            <p style="margin-bottom: 20px;">No hay paquetes registrados para este departamento</p>
                            <button class="btn btn-primary" onclick="redirectToRegisterPackage('${deptId}')">
                                <i class="fas fa-plus"></i>
                                <span>Registrar Primer Paquete</span>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = '';
        
        packages.forEach((pkg, index) => {
            try {
                console.log(`Procesando paquete ${index}:`, pkg);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <code style="background-color: var(--gray-100); padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">
                            ${pkg.id || pkg.qr_code || 'Sin ID'}
                        </code>
                    </td>
                    <td>
                        <strong>${pkg.sender || 'Sin remitente'}</strong>
                    </td>
                    <td>
                        ${pkg.recipient || '<span style="color: var(--gray);">No especificado</span>'}
                    </td>
                    <td>
                        ${formatDateForDisplay(pkg.delivery_date || pkg.created_at)}
                    </td>
                    <td>
                        ${getStatusBadge(pkg.status)}
                    </td>
                    <td>
                        ${pkg.description || '<span style="color: var(--gray);">Sin descripción</span>'}
                    </td>
                    <td class="actions-cell">
                        <button class="btn btn-outline" onclick="viewPackageDetails('${pkg.id || pkg.qr_code}')" aria-label="Ver detalles del paquete">
                            <i class="fas fa-eye"></i>
                            <span>Ver</span>
                        </button>
                        <button class="btn btn-success" onclick="markAsDelivered('${pkg.id || pkg.qr_code}')" aria-label="Marcar como entregado" ${pkg.status === 'entregado' || pkg.status === 'retirado' ? 'disabled' : ''}>
                            <i class="fas fa-check"></i>
                            <span>Entregar</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            } catch (packageError) {
                console.error('Error al procesar paquete:', pkg, packageError);
            }
        });
        
        console.log(`Tabla de paquetes cargada exitosamente con ${packages.length} paquetes`);
    } catch (error) {
        console.error('Error al cargar paquetes:', error);
        
        errorMessage.innerHTML = `
            <i class="fas fa-exclamation-circle"></i>
            <span>Error al cargar paquetes: ${error.message}</span>
        `;
        errorMessage.style.display = 'flex';
        
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: var(--danger);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                    <p>Error al cargar los paquetes</p>
                </td>
            </tr>
        `;
    }
}

// Función para redirigir al registro de paquetes con departamento pre-seleccionado
function redirectToRegisterPackage(deptId) {
    // Guardar el departamento seleccionado en localStorage para pre-llenarlo
    localStorage.setItem('preselectedDepartment', deptId);
    window.location.href = 'registerPackage.html';
}

// Función para ver detalles de un paquete específico
function viewPackageDetails(packageId) {
    try {
        const packages = getAllPackages();
        const pkg = packages.find(p => p.id === packageId || p.qr_code === packageId);
        
        if (!pkg) {
            showNotification('Paquete no encontrado', true);
            return;
        }
        
        const details = `
DETALLES DEL PAQUETE

ID: ${pkg.id || pkg.qr_code || 'Sin ID'}
Departamento: ${pkg.apartment_number || 'No especificado'}
Remitente: ${pkg.sender || 'Sin remitente'}
Destinatario: ${pkg.recipient || 'No especificado'}
Fecha de entrega: ${formatDateForDisplay(pkg.delivery_date)}
Estado: ${pkg.status || 'Sin estado'}
Descripción: ${pkg.description || 'Sin descripción'}
Notas: ${pkg.notes || 'Sin notas'}
Fecha de registro: ${formatDateForDisplay(pkg.created_at)}
        `;
        
        alert(details);
    } catch (error) {
        console.error('Error al ver detalles del paquete:', error);
        showNotification('Error al cargar detalles del paquete', true);
    }
}

// Función para marcar un paquete como entregado
function markAsDelivered(packageId) {
    if (!confirm('¿Está seguro que desea marcar este paquete como entregado?')) {
        return;
    }
    
    try {
        const packages = getAllPackages();
        const packageIndex = packages.findIndex(p => p.id === packageId || p.qr_code === packageId);
        
        if (packageIndex === -1) {
            showNotification('Paquete no encontrado', true);
            return;
        }
        
        // Actualizar estado
        packages[packageIndex].status = 'entregado';
        packages[packageIndex].delivered_at = new Date().toISOString();
        
        // Guardar cambios
        localStorage.setItem('paquetesPrueba', JSON.stringify(packages));
        localStorage.setItem('packages', JSON.stringify(packages));
        
        showNotification('Paquete marcado como entregado exitosamente');
        
        // Recargar la vista de paquetes
        const currentDept = packages[packageIndex].apartment_number;
        loadPackagesByDepartment(currentDept);
        
        // También recargar la vista de departamentos para actualizar contadores
        loadDepartments();
    } catch (error) {
        console.error('Error al marcar paquete como entregado:', error);
        showNotification('Error al actualizar el estado del paquete', true);
    }
}

// Función para cargar departamentos en la tabla - MEJORADA
function loadDepartments() {
    const tbody = document.querySelector('#departmentsTable tbody');
    const errorMessage = document.getElementById('errorMessage');
    
    if (!tbody || !errorMessage) {
        console.error('No se encontraron elementos del DOM necesarios');
        return;
    }
    
    errorMessage.style.display = 'none';
    
    tbody.innerHTML = `
        <tr>
            <td colspan="4" style="text-align: center;">
                <div class="loading-spinner" role="status"></div>
            </td>
        </tr>
    `;
    
    try {
        console.log("=== CARGANDO DEPARTAMENTOS EN TABLA ===");
        const departments = getAllDepartments();
        console.log("Departamentos obtenidos para tabla:", departments);
        
        if (!departments || departments.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="empty-state">
                        <i class="fas fa-building"></i>
                        <p>No hay departamentos registrados</p>
                        <button class="btn btn-primary" id="addFirstDeptBtn">
                            <i class="fas fa-plus"></i>
                            <span>Agregar primer departamento</span>
                        </button>
                    </td>
                </tr>
            `;
            
            const addFirstDeptBtn = document.getElementById('addFirstDeptBtn');
            if (addFirstDeptBtn) {
                addFirstDeptBtn.addEventListener('click', addNewDepartment);
            }
            
            return;
        }
        
        tbody.innerHTML = '';
        
        departments.forEach((dept, index) => {
            try {
                console.log(`Procesando departamento ${index} para tabla:`, dept);
                const deptNumber = dept.number;
                
                // Verificación estricta
                if (!deptNumber || !isValidDepartmentNumber(deptNumber)) {
                    console.warn('Departamento sin número válido saltado:', dept);
                    return;
                }
                
                const summary = getDepartmentSummary(deptNumber);
                console.log(`Resumen para departamento ${deptNumber}:`, summary);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>Departamento ${deptNumber}</strong>
                    </td>
                    <td>
                        <span class="badge badge-pending">
                            <i class="fas fa-clock"></i>
                            ${summary.pendingPackages || 0}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-success">
                            <i class="fas fa-check"></i>
                            ${summary.deliveredPackages || 0}
                        </span>
                    </td>
                    <td class="actions-cell">
                        <button class="btn btn-view" onclick="viewDepartment('${deptNumber}')" aria-label="Ver paquetes del departamento ${deptNumber}">
                            <i class="fas fa-eye"></i>
                            <span>Ver Paquetes</span>
                        </button>
                        <button class="btn btn-danger" onclick="deleteDepartment('${deptNumber}')" aria-label="Eliminar departamento ${deptNumber}">
                            <i class="fas fa-trash"></i>
                            <span>Eliminar</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
                console.log(`Fila agregada para departamento ${deptNumber}`);
            } catch (packageError) {
                console.error('Error al procesar departamento para tabla:', dept, packageError);
            }
        });
        
        console.log("=== TABLA CARGADA EXITOSAMENTE ===");
    } catch (error) {
        console.error('Error al cargar departamentos en tabla:', error);
        
        errorMessage.innerHTML = `
            <i class="fas fa-exclamation-circle"></i>
            <span>Error al cargar departamentos: ${error.message}</span>
        `;
        errorMessage.style.display = 'flex';
        
        tbody.innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center; color: var(--danger);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                    <p>Error al cargar los departamentos</p>
                </td>
            </tr>
        `;
    }
}

// Función para añadir un nuevo departamento - MEJORADA
function addNewDepartment() {
    try {
        const deptNumber = prompt('Ingrese el número del nuevo departamento:');
        
        if (!deptNumber) return;
        
        const cleanDeptNumber = String(deptNumber).trim();
        
        if (!isValidDepartmentNumber(cleanDeptNumber)) {
            showNotification('Por favor ingrese un número válido (entre 1 y 9999)', true);
            return;
        }
        
        const departments = getAllDepartments();
        const exists = departments.some(dept => dept.number === cleanDeptNumber);
        
        if (exists) {
            showNotification('Ya existe un departamento con ese número', true);
            return;
        }
        
        const newDept = { number: cleanDeptNumber };
        departments.push(newDept);
        
        localStorage.setItem('departments', JSON.stringify(departments));
        
        showNotification(`Departamento ${cleanDeptNumber} agregado correctamente`);
        
        loadDepartments();
    } catch (error) {
        console.error('Error al agregar departamento:', error);
        showNotification('Error al agregar departamento: ' + error.message, true);
    }
}

// Función para limpiar manualmente departamentos inválidos
function manualCleanDepartments() {
    if (confirm('¿Está seguro que desea limpiar todos los departamentos inválidos? Esta acción no se puede deshacer.')) {
        try {
            const before = JSON.parse(localStorage.getItem('departments') || '[]');
            const after = cleanInvalidDepartments();
            
            const removed = before.length - after.length;
            
            if (removed > 0) {
                showNotification(`Se limpiaron ${removed} departamentos inválidos`);
                loadDepartments();
            } else {
                showNotification('No se encontraron departamentos inválidos para limpiar');
            }
        } catch (error) {
            console.error('Error en limpieza manual:', error);
            showNotification('Error durante la limpieza: ' + error.message, true);
        }
    }
}

// Inicialización cuando se carga la página
document.addEventListener('DOMContentLoaded', () => {
    const authToken = localStorage.getItem('authToken');
    const isLoggedIn = localStorage.getItem('isLoggedIn');
    
    if (!authToken || !isLoggedIn) {
        window.location.href = 'login.html';
        return;
    }
    
    // Cargar departamentos (esto automáticamente limpia los inválidos)
    loadDepartments();
    
    // Configurar botones principales
    const addDeptBtn = document.getElementById('addDeptBtn');
    if (addDeptBtn) {
        addDeptBtn.addEventListener('click', addNewDepartment);
    }
    
    const cleanDeptBtn = document.getElementById('cleanDeptBtn');
    if (cleanDeptBtn) {
        cleanDeptBtn.addEventListener('click', manualCleanDepartments);
    }
    
    // Configurar botones de la vista de paquetes
    const backToDeptBtn = document.getElementById('backToDeptBtn');
    if (backToDeptBtn) {
        backToDeptBtn.addEventListener('click', backToDepartments);
    }
    
    const addPackageBtn = document.getElementById('addPackageBtn');
    if (addPackageBtn) {
        addPackageBtn.addEventListener('click', () => {
            window.location.href = 'registerPackage.html';
        });
    }
});
</script>
</body>
</html>