<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Administración de Departamentos - Gestión de Paquetes</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
--primary: #f39c12;
--primary-dark: #e67e22;
--primary-light: #fef9c3;
--secondary: #2c3e50;
--accent: #e74c3c;
--accent-dark: #c0392b;
--accent-light: #fadbd8;
--success: #27ae60;
--success-light: #e8f5e9;
--danger: #e74c3c;
--danger-dark: #c0392b;
--danger-light: #ffebee;
--warning: #f39c12;
--warning-dark: #e67e22;
--warning-light: #fff8e1;
--light: #f8f9fa;
--dark: #212529;
--gray: #6c757d;
--gray-light: #e9ecef;
--gray-50: #f8f9fa;
--gray-100: #f1f5f9;
--gray-200: #e2e8f0;
--gray-300: #cbd5e1;
--gray-700: #334155;
--shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
--shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
--shadow-md: 0 10px 15px rgba(0, 0, 0, 0.1);
--radius-sm: 0.375rem;
--radius: 0.5rem;
--radius-md: 0.75rem;
--radius-lg: 1rem;
 }
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
 }
html, body {
height: 100%;
width: 100%;
overflow-x: hidden;
 }
body {
background-color: #f1cc90;
color: var(--dark);
display: flex;
min-height: 100vh;
 }
/* Sidebar styles */
.sidebar {
width: 250px;
background-color: #fff;
box-shadow: var(--shadow);
transition: all 0.3s ease;
z-index: 1000;
 }
.sidebar-header {
padding: 20px;
border-bottom: 1px solid var(--gray-light);
display: flex;
align-items: center;
justify-content: center;
 }
.logo {
font-size: 1.3rem;
font-weight: bold;
color: var(--primary);
display: flex;
align-items: center;
gap: 8px;
text-decoration: none;
 }
.logo img {
height: 40px;
width: auto;
object-fit: contain;
 }
.nav-menu {
list-style: none;
padding: 20px 0;
 }
.nav-item {
padding: 12px 20px;
display: flex;
align-items: center;
gap: 10px;
color: var(--gray);
font-weight: 500;
cursor: pointer;
transition: all 0.3s ease;
margin-bottom: 5px;
 }
.nav-item:hover {
background-color: rgba(243, 156, 18, 0.1);
color: var(--primary);
 }
.nav-item.active {
background-color: rgba(243, 156, 18, 0.15);
color: var(--primary);
border-left: 3px solid var(--primary);
 }
.nav-item i {
width: 20px;
text-align: center;
 }
/* Main content styles */
.main-content {
flex: 1;
padding: 20px;
background-color: #fbf5ee;
transition: all 0.3s ease;
 }
.header {
display: flex;
justify-content: space-between;
align-items: center;
padding: 15px 0;
margin-bottom: 30px;
 }
.page-title {
font-size: 1.5rem;
font-weight: 600;
color: var(--dark);
 }
.card {
background-color: #fff;
border-radius: 10px;
box-shadow: var(--shadow);
margin-bottom: 20px;
overflow: hidden;
 }
.card-header {
padding: 15px 20px;
border-bottom: 1px solid var(--gray-light);
font-weight: 600;
display: flex;
justify-content: space-between;
align-items: center;
 }
.card-body {
padding: 20px;
 }
.btn {
display: inline-flex;
align-items: center;
gap: 8px;
padding: 8px 16px;
border-radius: 6px;
font-weight: 500;
cursor: pointer;
transition: all 0.3s ease;
border: none;
font-size: 0.9rem;
text-decoration: none;
 }
.btn-primary {
background-color: var(--primary);
color: white;
 }
.btn-primary:hover {
background-color: var(--primary-dark);
transform: translateY(-2px);
box-shadow: var(--shadow-sm);
 }
.btn-accent {
background-color: var(--accent);
color: white;
 }
.btn-accent:hover {
background-color: var(--accent-dark);
transform: translateY(-2px);
box-shadow: var(--shadow-sm);
 }
.btn-success {
background-color: var(--success);
color: white;
 }
.btn-success:hover {
background-color: #145a32;
 }
.btn-danger {
background-color: var(--danger);
color: white;
 }
.btn-danger:hover {
background-color: var(--danger-dark);
 }
.btn-view {
background-color: var(--secondary);
color: white;
 }
.btn-view:hover {
background-color: #1a252f;
 }
.btn-outline {
background-color: transparent;
border: 1px solid var(--gray-300);
color: var(--gray-700);
 }
.btn-outline:hover {
background-color: var(--gray-50);
border-color: var(--gray-700);
 }
.table-container {
overflow-x: auto;
border-radius: var(--radius);
border: 1px solid var(--gray-200);
 }
table {
width: 100%;
border-collapse: collapse;
font-size: 0.9375rem;
 }
th, td {
padding: 1rem;
text-align: left;
border-bottom: 1px solid var(--gray-200);
 }
thead {
background-color: var(--gray-50);
 }
th {
font-weight: 600;
color: var(--gray-700);
text-transform: uppercase;
font-size: 0.75rem;
letter-spacing: 0.05em;
 }
tbody tr:hover {
background-color: var(--gray-50);
 }
tbody tr:last-child td {
border-bottom: none;
 }
.badge {
display: inline-block;
padding: 0.25rem 0.75rem;
border-radius: 9999px;
font-size: 0.75rem;
font-weight: 500;
display: inline-flex;
align-items: center;
gap: 5px;
 }
.badge-pending {
background-color: var(--warning-light);
color: var(--warning-dark);
 }
.badge-success {
background-color: var(--success-light);
color: var(--success);
 }
.actions-cell {
display: flex;
gap: 0.5rem;
justify-content: flex-start;
flex-wrap: wrap;
 }
.error-message {
background-color: var(--danger-light);
color: var(--danger);
padding: 15px;
border-radius: var(--radius);
margin-bottom: 20px;
display: flex;
align-items: center;
gap: 10px;
 }
.loading-spinner {
border: 3px solid var(--gray-200);
border-top: 3px solid var(--primary);
border-radius: 50%;
width: 30px;
height: 30px;
animation: spin 1s linear infinite;
 }
@keyframes spin {
 0% { transform: rotate(0deg); }
 100% { transform: rotate(360deg); }
 }
.empty-state {
text-align: center;
padding: 40px 20px;
color: var(--gray);
 }
.empty-state i {
font-size: 3rem;
margin-bottom: 15px;
color: var(--gray-300);
 }
.empty-state p {
margin-bottom: 20px;
 }
.notification {
position: fixed;
bottom: 20px;
right: 20px;
padding: 12px 20px;
border-radius: 6px;
background-color: var(--success-light);
color: var(--success);
display: flex;
align-items: center;
gap: 10px;
box-shadow: var(--shadow);
opacity: 0;
transform: translateY(10px);
transition: all 0.3s ease;
z-index: 1000;
max-width: 90%;
 }
.notification.show {
opacity: 1;
transform: translateY(0);
 }
.notification.error {
background-color: var(--danger-light);
color: var(--danger);
 }
/* Responsive styles */
@media (max-width: 768px) {
.sidebar {
width: 70px;
 }
.sidebar .logo span,
.sidebar .nav-item span {
display: none;
 }
.sidebar .nav-item {
justify-content: center;
padding: 15px 0;
 }
.sidebar .nav-item i {
margin-right: 0;
 }
.sidebar .sidebar-header {
padding: 15px 0;
 }
.sidebar .logo {
justify-content: center;
 }
.sidebar .logo img {
height: 34px;
 }
.main-content {
padding: 15px;
 }
.header {
flex-direction: column;
align-items: flex-start;
gap: 15px;
 }
.actions-cell {
flex-direction: column;
width: 100%;
 }
.actions-cell .btn {
width: 100%;
 }
.card-header {
flex-direction: column;
gap: 10px;
 }
.card-header button {
width: 100%;
 }
 }
@media (max-width: 576px) {
.main-content {
padding: 10px;
 }
.card {
border-radius: 8px;
 }
.card-header, .card-body {
padding: 15px;
 }
th, td {
padding: 10px 8px;
 }
 }
</style>
</head>
<body>
<!-- Sidebar / Menú Lateral -->
<div class="sidebar">
<div class="sidebar-header">
<a href="dashboard.html" class="logo">
<img src="./images/favicon1.svg" alt="Logo Encomiendas">
<span>PackTrack</span>
</a>
</div>
<ul class="nav-menu">
<li class="nav-item" onclick="window.location.href='dashboard.html'">
<i class="fas fa-th-large"></i>
<span>Dashboard</span>
</li>
<li class="nav-item" onclick="window.location.href='registerPackage.html'">
<i class="fas fa-plus-square"></i>
<span>Registrar Paquete</span>
</li>
<li class="nav-item" onclick="window.location.href='listPackages.html'">
<i class="fas fa-list"></i>
<span>Lista de Paquetes</span>
</li>
<li class="nav-item active" onclick="window.location.href='departaments.html'">
<i class="fas fa-building"></i>
<span>Departamentos</span>
</li>
<li class="nav-item" onclick="window.location.href='codigoqr.html'">
<i class="fas fa-qrcode"></i>
<span>Lector QR</span>
</li>
<li class="nav-item " onclick="window.location.href='notificacion.html'">
    <i class="fas fa-bell"></i>
    <span>Notificaciones</span>
</li>
<li class="nav-item" onclick="window.location.href='configuracion.html'">
<i class="fas fa-cog"></i>
<span>Configuración</span>
</li>
<li class="nav-item" onclick="logout()" style="margin-top: 50px; color: #e74c3c;">
<i class="fas fa-sign-out-alt"></i>
<span>Cerrar Sesión</span>
</li>
</ul>
</div>
<!-- Contenido Principal -->
<div class="main-content">
<div class="header">
<h1 class="page-title">Administración de Departamentos</h1>
</div>
<div class="card">
<div class="card-header">
<h2 style="font-size: 1.2rem; font-weight: 600;">Departamentos Registrados</h2>
<button class="btn btn-primary" id="addDeptBtn" aria-label="Agregar nuevo departamento">
<i class="fas fa-plus"></i>
<span>Agregar Departamento</span>
</button>
</div>
<div class="card-body">
<div id="errorMessage" class="error-message" style="display: none;">
<i class="fas fa-exclamation-circle"></i>
<span>Ha ocurrido un error al cargar los departamentos.</span>
</div>
<div class="table-container">
<table id="departmentsTable" aria-label="Lista de departamentos registrados">
<thead>
<tr>
<th scope="col">Número</th>
<th scope="col">Paquetes Pendientes</th>
<th scope="col">Paquetes Retirados</th>
<th scope="col">Acciones</th>
</tr>
</thead>
<tbody>
<tr>
<td colspan="4" style="text-align: center;">
<div class="loading-spinner" role="status"></div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<!-- Notificación -->
<div id="notification" class="notification">
<i class="fas fa-check-circle"></i>
<span id="notification-message">Operación completada con éxito</span>
</div>

<script>
// URLs del backend - Configurar según tu entorno
const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
    ? 'http://localhost:3000/api'  // Entorno de desarrollo
    : '/api';                     // Entorno de producción
    
const ENDPOINTS = {
    departments: `${API_URL}/departments`,
    department: (id) => `${API_URL}/departments/${id}`,
    packagesByDept: (deptId) => `${API_URL}/packages/department/${deptId}`,
    departmentSummary: (id) => `${API_URL}/departments/${id}/summary`
};

// Variable para activar modo de respaldo cuando el backend no está disponible
let fallbackMode = false;

// Función para realizar solicitudes a la API con control de errores y modo fallback
async function fetchAPI(url, options = {}) {
    try {
        // Si estamos en modo fallback, usar localStorage
        if (fallbackMode) {
            return await handleFallbackRequest(url, options);
        }
        
        // Configurar cabeceras de autenticación
        const token = localStorage.getItem('authToken');
        const headers = {
            'Content-Type': 'application/json',
            ...options.headers
        };
        
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        
        // Agregar un timeout para la solicitud
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 segundos de timeout
        
        const response = await fetch(url, {
            ...options,
            headers,
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        // Verificar si la respuesta es 401 (No autorizado)
        if (response.status === 401) {
            localStorage.removeItem('authToken');
            window.location.href = 'login.html';
            return null;
        }
        
        // Verificar si la respuesta es exitosa
        if (!response.ok) {
            throw new Error(`Error: ${response.status} - ${response.statusText}`);
        }
        
        // Devolver los datos como JSON
        return await response.json();
    } catch (error) {
        console.error('Error en la solicitud API:', error);
        
        // Si es un error de conexión, activar modo fallback
        if (error.name === 'TypeError' || error.name === 'AbortError' || error.message.includes('Failed to fetch')) {
            if (!fallbackMode) {
                fallbackMode = true;
                showNotification('El servidor no está disponible. Usando modo de respaldo local.', true);
                console.warn('Activando modo fallback para localStorage');
                
                // Intentar nuevamente con localStorage
                return await handleFallbackRequest(url, options);
            }
        }
        
        showNotification(`Error en la solicitud: ${error.message}`, true);
        return null;
    }
}

// Función para manejar solicitudes en modo fallback (localStorage)
async function handleFallbackRequest(url, options = {}) {
    console.log('Usando localStorage como respaldo para:', url);
    
    // Simular pequeño retraso para imitar una API
    await new Promise(resolve => setTimeout(resolve, 300));
    
    try {
        // Crear departamentos de ejemplo si no existen
        if (!localStorage.getItem('fallback_departments')) {
            initializeFallbackData();
        }
        
        // Determinar qué operación es basada en la URL y método
        if (url.includes('/departments') && !url.includes('/departments/')) {
            // Operaciones generales de departamentos
            if (options.method === 'POST') {
                // Crear nuevo departamento
                const newDept = JSON.parse(options.body);
                return createDepartmentInLocalStorage(newDept);
            } else {
                // Obtener todos los departamentos
                return getAllDepartmentsFromLocalStorage();
            }
        } else if (url.includes('/departments/') && url.includes('/summary')) {
            // Obtener resumen de departamento
            const deptId = url.split('/departments/')[1].split('/summary')[0];
            return getDepartmentSummaryFromLocalStorage(deptId);
        } else if (url.includes('/departments/')) {
            // Operaciones específicas de departamento
            const deptId = url.split('/departments/')[1];
            
            if (options.method === 'DELETE') {
                // Eliminar departamento
                return deleteDepartmentFromLocalStorage(deptId);
            } else if (options.method === 'PUT' || options.method === 'PATCH') {
                // Actualizar departamento
                const updateData = JSON.parse(options.body);
                return updateDepartmentInLocalStorage(deptId, updateData);
            } else {
                // Obtener un departamento
                return getDepartmentFromLocalStorage(deptId);
            }
        } else if (url.includes('/packages/department/')) {
            // Obtener paquetes por departamento
            const deptId = url.split('/packages/department/')[1];
            return getPackagesByDepartmentFromLocalStorage(deptId);
        }
        
        return null;
    } catch (error) {
        console.error('Error en modo fallback:', error);
        return null;
    }
}

// Inicializar datos de respaldo
function initializeFallbackData() {
    // Crear departamentos de prueba
    const departments = [
        { id: '101', number: '101' },
        { id: '102', number: '102' },
        { id: '103', number: '103' },
        { id: '201', number: '201' },
        { id: '202', number: '202' },
        { id: '301', number: '301' }
    ];
    localStorage.setItem('fallback_departments', JSON.stringify(departments));
    
    // Crear paquetes de prueba
    const packages = [];
    departments.forEach((dept, index) => {
        // Crear 2 paquetes por departamento
        for (let i = 0; i < 2; i++) {
            packages.push({
                id: `PKG-${dept.number}-${Date.now()}-${i}`,
                apartment_number: dept.number,
                sender: `Remitente Prueba ${index + 1} - ${i}`,
                delivery_date: new Date().toISOString(),
                status: i % 2 === 0 ? 'pendiente' : 'retirado',
                notes: `Paquete de prueba para departamento ${dept.number}`
            });
        }
    });
    
    localStorage.setItem('fallback_packages', JSON.stringify(packages));
    console.log('Datos de respaldo inicializados con', departments.length, 'departamentos y', packages.length, 'paquetes');
}

// Obtener todos los departamentos desde localStorage
function getAllDepartmentsFromLocalStorage() {
    try {
        const deptsString = localStorage.getItem('fallback_departments');
        return deptsString ? JSON.parse(deptsString) : [];
    } catch (error) {
        console.error('Error obteniendo departamentos de localStorage:', error);
        return [];
    }
}

// Obtener un departamento específico desde localStorage
function getDepartmentFromLocalStorage(deptId) {
    try {
        const departments = getAllDepartmentsFromLocalStorage();
        return departments.find(dept => dept.id === deptId || dept.number === deptId) || null;
    } catch (error) {
        console.error('Error obteniendo departamento de localStorage:', error);
        return null;
    }
}

// Crear departamento en localStorage
function createDepartmentInLocalStorage(newDept) {
    try {
        const departments = getAllDepartmentsFromLocalStorage();
        
        // Verificar si ya existe el número de departamento
        if (departments.some(dept => dept.number === newDept.number)) {
            throw new Error('Ya existe un departamento con ese número');
        }
        
        // Asignar un ID si no tiene
        if (!newDept.id) {
            newDept.id = newDept.number;
        }
        
        // Agregar el nuevo departamento
        departments.push(newDept);
        localStorage.setItem('fallback_departments', JSON.stringify(departments));
        
        return newDept;
    } catch (error) {
        console.error('Error creando departamento en localStorage:', error);
        throw error;
    }
}

// Actualizar departamento en localStorage
function updateDepartmentInLocalStorage(deptId, updateData) {
    try {
        const departments = getAllDepartmentsFromLocalStorage();
        const index = departments.findIndex(dept => dept.id === deptId || dept.number === deptId);
        
        if (index === -1) {
            throw new Error('Departamento no encontrado');
        }
        
        // Actualizar el departamento
        departments[index] = { ...departments[index], ...updateData };
        localStorage.setItem('fallback_departments', JSON.stringify(departments));
        
        return departments[index];
    } catch (error) {
        console.error('Error actualizando departamento en localStorage:', error);
        throw error;
    }
}

// Eliminar departamento de localStorage
function deleteDepartmentFromLocalStorage(deptId) {
    try {
        const departments = getAllDepartmentsFromLocalStorage();
        const filteredDepts = departments.filter(dept => dept.id !== deptId && dept.number !== deptId);
        
        // Si no cambió el tamaño, el departamento no existía
        if (filteredDepts.length === departments.length) {
            throw new Error('Departamento no encontrado');
        }
        
        localStorage.setItem('fallback_departments', JSON.stringify(filteredDepts));
        
        // También eliminamos los paquetes asociados
        const allPackages = JSON.parse(localStorage.getItem('fallback_packages') || '[]');
        const updatedPackages = allPackages.filter(pkg => pkg.apartment_number !== deptId);
        localStorage.setItem('fallback_packages', JSON.stringify(updatedPackages));
        
        return { success: true, message: 'Departamento eliminado correctamente' };
    } catch (error) {
        console.error('Error eliminando departamento de localStorage:', error);
        throw error;
    }
}

// Obtener paquetes por departamento desde localStorage
function getPackagesByDepartmentFromLocalStorage(deptId) {
    try {
        const packagesString = localStorage.getItem('fallback_packages');
        if (!packagesString) return [];
        
        const packages = JSON.parse(packagesString);
        return packages.filter(pkg => pkg.apartment_number === deptId);
    } catch (error) {
        console.error('Error obteniendo paquetes por departamento de localStorage:', error);
        return [];
    }
}

// Obtener resumen de departamento (conteo de paquetes) desde localStorage
function getDepartmentSummaryFromLocalStorage(deptId) {
    try {
        const packages = getPackagesByDepartmentFromLocalStorage(deptId);
        
        return {
            departmentId: deptId,
            totalPackages: packages.length,
            pendingPackages: packages.filter(pkg => pkg.status === 'pendiente').length,
            deliveredPackages: packages.filter(pkg => pkg.status === 'retirado' || pkg.status === 'entregado').length
        };
    } catch (error) {
        console.error('Error obteniendo resumen de departamento de localStorage:', error);
        return {
            departmentId: deptId,
            totalPackages: 0,
            pendingPackages: 0,
            deliveredPackages: 0
        };
    }
}

// Función para mostrar notificaciones
function showNotification(message, isError = false) {
    const notification = document.getElementById('notification');
    const notificationMessage = document.getElementById('notification-message');
    
    notificationMessage.textContent = message;
    notification.classList.toggle('error', isError);
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

// Función para cerrar sesión
async function logout() {
    try {
        // Solo intentar llamar a la API de logout si no estamos en modo fallback
        if (!fallbackMode) {
            await fetchAPI(`${API_URL}/auth/logout`, { 
                method: 'POST',
                // Añadir un tiempo de espera corto para evitar que se bloquee la UI
                signal: AbortSignal.timeout(3000)
            }).catch(err => console.warn('Error en logout API:', err));
        }
    } catch (error) {
        console.warn('Error al cerrar sesión en el servidor:', error);
    } finally {
        // Siempre limpiar localStorage y redirigir
        localStorage.removeItem('authToken');
        localStorage.removeItem('userName');
        localStorage.removeItem('userType');
        localStorage.removeItem('isLoggedIn');
        window.location.href = 'login.html';
    }
}

// Hacer la función de logout global para que funcione con el botón del sidebar
window.logout = logout;

// Función para obtener todos los departamentos
async function getAllDepartments() {
    try {
        const departments = await fetchAPI(ENDPOINTS.departments);
        return departments || [];
    } catch (error) {
        console.error('Error al obtener departamentos:', error);
        showNotification('Error al cargar departamentos', true);
        return [];
    }
}

// Función para obtener paquetes por departamento
async function getPackagesByDepartment(deptId) {
    try {
        const packages = await fetchAPI(ENDPOINTS.packagesByDept(deptId));
        return packages || [];
    } catch (error) {
        console.error(`Error al obtener paquetes del departamento ${deptId}:`, error);
        return [];
    }
}

// Función para obtener el resumen de un departamento
async function getDepartmentSummary(deptId) {
    try {
        const summary = await fetchAPI(ENDPOINTS.departmentSummary(deptId));
        return summary || { pendingPackages: 0, deliveredPackages: 0 };
    } catch (error) {
        console.error(`Error al obtener resumen del departamento ${deptId}:`, error);
        
        // Si el endpoint de resumen falla, calcular desde los paquetes
        const packages = await getPackagesByDepartment(deptId);
        return {
            pendingPackages: packages.filter(pkg => pkg.status === 'pendiente').length,
            deliveredPackages: packages.filter(pkg => pkg.status === 'retirado' || pkg.status === 'entregado').length
        };
    }
}

// Función para eliminar un departamento
async function deleteDepartment(deptId) {
    if (confirm(`¿Está seguro que desea eliminar el Departamento ${deptId}?`)) {
        try {
            const response = await fetchAPI(ENDPOINTS.department(deptId), {
                method: 'DELETE'
            });
            
            if (response) {
                showNotification(`Departamento ${deptId} eliminado correctamente`);
                await loadDepartments(); // Recargar la tabla
            }
        } catch (error) {
            console.error('Error al eliminar departamento:', error);
            showNotification(`Error al eliminar departamento: ${error.message}`, true);
        }
    }
}

// Función para ver paquetes de un departamento
function viewDepartment(deptId) {
    window.location.href = `listPackages.html?department=${deptId}`;
}

// Función para cargar departamentos en la tabla
async function loadDepartments() {
    const tbody = document.querySelector('#departmentsTable tbody');
    const errorMessage = document.getElementById('errorMessage');
    
    // Ocultar mensajes de error previos
    errorMessage.style.display = 'none';
    
    // Mostrar cargando
    tbody.innerHTML = `
        <tr>
            <td colspan="4" style="text-align: center;">
                <div class="loading-spinner" role="status"></div>
            </td>
        </tr>
    `;
    
    try {
        // Obtener todos los departamentos
        const departments = await getAllDepartments();
        
        // Verificar si hay departamentos
        if (!departments || departments.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="empty-state">
                        <i class="fas fa-building"></i>
                        <p>No hay departamentos registrados</p>
                        <button class="btn btn-primary" onclick="window.location.href='moredepartaments.html'">
                            <i class="fas fa-plus"></i>
                            <span>Agregar primer departamento</span>
                        </button>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Limpiar tabla
        tbody.innerHTML = '';
        
        // Procesar cada departamento
        for (const dept of departments) {
            try {
                // Obtener el número de departamento
                const deptNumber = dept.number || dept.id || dept;
                
                // Obtener resumen del departamento (paquetes pendientes y retirados)
                const summary = await getDepartmentSummary(deptNumber);
                
                // Crear la fila
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>Departamento ${deptNumber}</strong>
                    </td>
                    <td>
                        <span class="badge badge-pending">
                            <i class="fas fa-clock"></i>
                            ${summary.pendingPackages || 0}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-success">
                            <i class="fas fa-check"></i>
                            ${summary.deliveredPackages || 0}
                        </span>
                    </td>
                    <td class="actions-cell">
                        <button class="btn btn-view" onclick="viewDepartment('${deptNumber}')" aria-label="Ver paquetes del departamento ${deptNumber}">
                            <i class="fas fa-eye"></i>
                            <span>Ver Paquetes</span>
                        </button>
                        <button class="btn btn-danger" onclick="deleteDepartment('${deptNumber}')" aria-label="Eliminar departamento ${deptNumber}">
                            <i class="fas fa-trash"></i>
                            <span>Eliminar</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            } catch (packageError) {
                console.error('Error al procesar paquetes del departamento', dept, packageError);
                
                // Agregar fila con error para este departamento
                const deptNumber = dept.number || dept.id || dept;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>Departamento ${deptNumber}</td>
                    <td colspan="3" style="color: var(--danger);">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error al cargar información de paquetes
                    </td>
                `;
                tbody.appendChild(row);
            }
        }
    } catch (error) {
        console.error('Error al cargar departamentos:', error);
        
        // Mostrar mensaje de error
        errorMessage.innerHTML = `
            <i class="fas fa-exclamation-circle"></i>
            <span>Error al cargar departamentos: ${error.message}</span>
        `;
        errorMessage.style.display = 'flex';
        
        // Mostrar mensaje de error en la tabla
        tbody.innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center; color: var(--danger);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                    <p>Error al cargar los departamentos</p>
                </td>
            </tr>
        `;
    }
}

// Inicialización cuando se carga la página
document.addEventListener('DOMContentLoaded', async () => {
    // Verificar autenticación
    const authToken = localStorage.getItem('authToken');
    if (!authToken) {
        window.location.href = 'login.html';
        return;
    }
    
    try {
        // Intentar conexión con el backend
        try {
            // Verificar conectividad con una petición simple
            const connectionTest = await fetch(`${API_URL}/status`, { 
                method: 'GET',
                headers: { 'Authorization': `Bearer ${authToken}` },
                signal: AbortSignal.timeout(5000) // 5 segundos timeout
            });
            
            if (!connectionTest.ok) {
                throw new Error(`Backend no disponible: ${connectionTest.status}`);
            }
            
            console.log('Conexión con backend establecida');
        } catch (connectionError) {
            console.warn('Error conectando con el backend:', connectionError);
            fallbackMode = true;
            showNotification('No se pudo conectar con el servidor. Usando datos locales.', 'warning', 10000);
        }
        
        // Cargar departamentos
        await loadDepartments();
        
        // Configurar botón para agregar departamentos
        document.getElementById('addDeptBtn').addEventListener('click', function() {
            window.location.href = 'moredepartaments.html';
        });
    } catch (error) {
        console.error('Error al inicializar la página:', error);
        showNotification('Error al cargar la página. Usando modo de respaldo.', true);
        
        // Activar modo de respaldo en caso de error
        fallbackMode = true;
        
        // Intentar cargar en modo respaldo
        await loadDepartments();
    }
});
</script>
</body>
</html>