<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registrar Paquete - Gestión de Paquetes</title>
  <style>
    /* Reset básico */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #27ae60, #145a32);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px 15px 50px;
      color: #2c3e50;
    }

    header {
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 2rem;
      font-weight: 700;
      color: #fff;
      text-shadow: 0 0 8px rgba(0, 0, 0, 0.4);
      margin-bottom: 40px;
      user-select: none;
      max-width: 900px;
      width: 100%;
      padding: 0 20px;
    }

    header img {
      height: 60px;
      width: auto;
    }

    .logout-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #1e8449;
      border: none;
      color: white;
      padding: 10px 18px;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      user-select: none;
      z-index: 1000;
    }

    .logout-btn:hover {
      background-color: #145a32;
    }

    .container {
      background-color: #fff;
      max-width: 480px;
      width: 100%;
      border-radius: 15px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
      padding: 40px 35px;
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    .container h2 {
      font-weight: 700;
      color: #27ae60;
      text-align: center;
      font-size: 1.8rem;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    select, input[type="text"], input[type="date"], textarea {
      padding: 14px 18px;
      border-radius: 10px;
      border: 2px solid #ddd;
      font-size: 1rem;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      font-family: inherit;
      resize: vertical;
    }

    select:focus,
    input[type="text"]:focus,
    input[type="date"]:focus,
    textarea:focus {
      border-color: #27ae60;
      outline: none;
      box-shadow: 0 0 8px rgba(39, 174, 96, 0.5);
    }

    textarea {
      min-height: 70px;
    }

    button {
      background-color: #27ae60;
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      padding: 16px 0;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(39, 174, 96, 0.4);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
    }

    button:hover {
      background-color: #1e8449;
      box-shadow: 0 8px 20px rgba(30, 132, 73, 0.6);
    }

    .link {
      text-align: center;
      margin-top: 10px;
      font-size: 0.95rem;
      color: #555;
    }

    .link a {
      color: #27ae60;
      font-weight: 600;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .link a:hover {
      color: #1e8449;
      text-decoration: underline;
    }

    /* QR Code Styles */
    .qr-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 15px;
      gap: 10px;
    }

    #qrCode {
      padding: 10px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 12px;
      display: none;
    }

    .qr-buttons {
      display: flex;
      gap: 12px;
      width: 100%;
    }

    .qr-buttons button {
      flex: 1;
      padding: 12px 0;
      font-size: 0.95rem;
    }

    .qr-buttons button.secondary {
      background-color: #7f8c8d;
    }

    .qr-buttons button.secondary:hover {
      background-color: #636e72;
    }

    .qr-buttons button.print {
      background-color: #2980b9;
    }

    .qr-buttons button.print:hover {
      background-color: #2069a0;
    }

    .qr-info {
      font-size: 0.9rem;
      color: #555;
      text-align: center;
      margin-top: 8px;
    }

    /* Responsive */
    @media (max-width: 520px) {
      .container {
        padding: 30px 25px;
      }

      header {
        font-size: 1.6rem;
        padding: 0 10px;
      }
    }
  </style>

<style>
    /* Estilos base para móviles primero */
    .container {
        width: 95%;
        margin: 20px auto;
        padding: 15px;
    }

    /* Para tablets */
    @media (min-width: 768px) {
        .container {
            width: 80%;
            padding: 25px;
        }
    }

    /* Para escritorios */
    @media (min-width: 1024px) {
        .container {
            width: 60%;
            max-width: 800px;
        }
    }

    /* Ajustes para inputs en móviles */
    input, select, textarea {
        width: 100%;
        box-sizing: border-box;
    }
  </style>
</head>
<body>
  <header>
    <img src="./images/ENCOMIENDA.png" alt="Logo Paquete" />
    Registrar Paquete
  </header>

  <button class="logout-btn">Cerrar Sesión</button>

  <div class="container">
    <h2>Registrar Encomienda</h2>
    <form id="packageForm">
      <select id="apartment_number" required>
        <option value="">-- Selecciona Departamento --</option>
      </select>

      <input type="text" id="sender" placeholder="Remitente" required />

      <input type="date" id="delivery_date" required />

      <select id="status" required>
        <option value="">-- Selecciona Estado --</option>
        <option value="pendiente">Pendiente</option>
        <option value="entregado">Entregado</option>
        <option value="retirado">Retirado</option>
      </select>

      <div class="qr-container">
        <button type="button" id="generateQrBtn">Generar Código QR</button>
        <div id="qrCode"></div>
        <input type="text" id="qr_code" placeholder="Código QR (generado automáticamente)" readonly />
        <div class="qr-buttons" id="qrButtons" style="display: none;">
          <button type="button" class="print" id="printQrBtn">Imprimir QR</button>
          <button type="button" class="secondary" id="downloadQrBtn">Descargar QR</button>
        </div>
        <div class="qr-info">El código QR contiene la información del paquete y facilita su seguimiento</div>
      </div>

      <textarea id="notes" rows="3" placeholder="Notas (opcional)"></textarea>

      <button type="submit">Registrar</button>
    </form>
    <div class="link">
      <a href="listPackages.html">Ver paquetes</a>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Verificar autenticación
      if (!localStorage.getItem('authToken')) {
        window.location.href = 'login.html';
        return;
      }

      // Botón generar QR
      document.getElementById('generateQrBtn').addEventListener('click', async function() {
        const apartment = document.getElementById('apartment_number').value;
        const sender = document.getElementById('sender').value;

        if (!apartment || !sender) {
          alert('Complete departamento y remitente');
          return;
        }

        try {
          const response = await fetch('/api/generate-qr', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('authToken')}`
            },
            body: JSON.stringify({ apartment_number: apartment, sender: sender })
          });

          const data = await response.json();

          if (response.ok) {
            document.getElementById('qrCode').innerHTML =
              `<img src="${data.qr_code}" alt="Código QR" style="max-width:200px;">`;
            document.getElementById('qrButtons').style.display = 'flex';
            document.getElementById('qr_code').value = data.qr_code;
            document.getElementById('qrCode').style.display = 'block';
          } else {
            throw new Error(data.error || 'Error al generar QR');
          }
        } catch (error) {
          console.error('Error:', error);
          alert(error.message);
        }
      });

      // Botón logout
      document.querySelector('.logout-btn').addEventListener('click', () => {
        localStorage.removeItem('authToken');
        window.location.href = 'login.html';
      });

      // Botón imprimir QR
      document.getElementById('printQrBtn').addEventListener('click', () => {
        const qrImg = document.querySelector('#qrCode img');
        if (qrImg) {
          const printWindow = window.open('', '_blank');
          printWindow.document.write(`<img src="${qrImg.src}" style="width: 300px;">`);
          printWindow.document.close();
          printWindow.focus();
          printWindow.print();
        }
      });

      // Botón descargar QR
      document.getElementById('downloadQrBtn').addEventListener('click', () => {
        const qrImg = document.querySelector('#qrCode img');
        if (qrImg) {
          const a = document.createElement('a');
          a.href = qrImg.src;
          a.download = 'codigo_qr.png';
          a.click();
        }
      });
    });
// Crear una ventana de impresión
const printButton = document.getElementById('printQR');
const qrCodeDiv = document.getElementById('qrDisplay');
const qrCodeInput = document.getElementById('qr_code');
const downloadQrBtn = document.getElementById('downloadQR');

printButton.addEventListener('click', () => {
  const apartmentNumber = document.getElementById('apartment_number').value;
  const sender = document.getElementById('sender').value;
  const deliveryDate = document.getElementById('delivery_date').value;

  const printWindow = window.open('', '', 'width=600,height=600');
  printWindow.document.write(`
    <html>
      <head>
        <title>QR Paquete - Depto ${apartmentNumber}</title>
        <style>
          body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
          .qr-print { margin: 20px auto; }
          .details { margin: 15px 0; line-height: 1.5; }

          .container {
              width: 95%;
              margin: 20px auto;
              padding: 15px;
          }
          @media (min-width: 768px) {
              .container {
                  width: 80%;
                  padding: 25px;
              }
          }
          @media (min-width: 1024px) {
              .container {
                  width: 60%;
                  max-width: 800px;
              }
          }
          input, select, textarea {
              width: 100%;
              box-sizing: border-box;
          }
        </style>
      </head>
      <body>
        <h2>Paquete para Departamento ${apartmentNumber}</h2>
        <div class="qr-print">
          ${qrCodeDiv.innerHTML}
        </div>
        <div class="details">
          <p><strong>Remitente:</strong> ${sender}</p>
          <p><strong>Fecha:</strong> ${deliveryDate}</p>
          <p><strong>Código:</strong> ${qrCodeInput.value}</p>
        </div>
      </body>
    </html>
  `);
  printWindow.document.close();
  setTimeout(() => {
    printWindow.print();
    printWindow.close();
  }, 500);
});

downloadQrBtn.addEventListener('click', () => {
  const canvas = qrCodeDiv.querySelector('canvas');
  if (!canvas) return;
  const imgData = canvas.toDataURL('image/png');
  const downloadLink = document.createElement('a');
  const apartmentNumber = document.getElementById('apartment_number').value;

  downloadLink.href = imgData;
  downloadLink.download = `QR-Paquete-Depto-${apartmentNumber}.png`;
  document.body.appendChild(downloadLink);
  downloadLink.click();
  document.body.removeChild(downloadLink);
});
async function cargarDepartamentos() {
  try {
    // Intenta obtener departamentos de la API
    let departamentos = [];
    try {
      const response = await fetch('/api/departamentos');
      if (!response.ok) {
        throw new Error('Error en respuesta del servidor');
      }
      departamentos = await response.json();
    } catch (apiError) {
      console.warn('Error al conectar con API. Usando datos locales:', apiError);
      // Si hay un error, usa datos de ejemplo
      departamentos = [
        { numero: 101, piso: 1 },
        { numero: 102, piso: 1 },
        { numero: 103, piso: 1 },
        { numero: 201, piso: 2 },
        { numero: 202, piso: 2 },
        { numero: 203, piso: 2 },
        { numero: 301, piso: 3 },
        { numero: 302, piso: 3 },
        { numero: 303, piso: 3 },
        { numero: 401, piso: 4 },
        { numero: 402, piso: 4 },
        { numero: 403, piso: 4 }
      ];
    }

    const select = document.getElementById('apartment_number');
    // Limpiar opciones existentes (por si se recarga)
    select.innerHTML = '<option value="">-- Selecciona Departamento --</option>';
    
    // Ordenar por número
    departamentos.sort((a, b) => a.numero - b.numero);

    // Agrupar por piso si existe esa propiedad
    const tienePisos = departamentos.some(d => d.piso !== undefined);
    
    if (tienePisos) {
      // Agrupar por pisos
      const pisos = {};
      departamentos.forEach(depto => {
        const piso = depto.piso || 'Otro';
        if (!pisos[piso]) pisos[piso] = [];
        pisos[piso].push(depto);
      });
      
      // Crear los grupos con optgroup
      Object.keys(pisos).sort((a, b) => a - b).forEach(piso => {
        const group = document.createElement('optgroup');
        group.label = `Piso ${piso}`;
        
        pisos[piso].forEach(depto => {
          const option = document.createElement('option');
          option.value = depto.numero;
          option.textContent = `Departamento ${depto.numero}`;
          group.appendChild(option);
        });
        
        select.appendChild(group);
      });
    } else {
      // Formato simple sin agrupar
      departamentos.forEach(depto => {
        const option = document.createElement('option');
        option.value = depto.numero;
        option.textContent = `Departamento ${depto.numero}`;
        select.appendChild(option);
      });
    }
    
    console.log('Departamentos cargados:', departamentos.length);
  } catch (error) {
    console.error('Error en cargarDepartamentos:', error);
    alert('Error al cargar los departamentos. Se han cargado datos de ejemplo.');
    
    // Cargar datos de respaldo en caso de cualquier error
    const select = document.getElementById('apartment_number');
    select.innerHTML = '<option value="">-- Selecciona Departamento --</option>';
    
    // Datos básicos de respaldo
    for (let i = 1; i <= 4; i++) {
      for (let j = 1; j <= 5; j++) {
        const num = i * 100 + j;
        const option = document.createElement('option');
        option.value = num;
        option.textContent = `Departamento ${num}`;
        select.appendChild(option);
      }
    }
  }
}

function logout() {
  localStorage.removeItem('authToken');
  window.location.href = 'login.html';
}

document.getElementById('packageForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  // Si no hay código QR generado, preguntar si desea continuar
  if (!document.getElementById('qr_code').value) {
    if (!confirm('No has generado un código QR para este paquete. ¿Deseas continuar sin código QR?')) {
      return;
    }
  }
  
  const body = {
    apartment_number: document.getElementById('apartment_number').value,
    sender: document.getElementById('sender').value.trim(),
    delivery_date: document.getElementById('delivery_date').value,
    status: document.getElementById('status').value,
    qr_code: document.getElementById('qr_code').value.trim(),
    notes: document.getElementById('notes').value.trim(),
  };

  try {
    // Primero intentamos con la API
    let registroExitoso = false;
    
    try {
      const response = await fetch('/api/packages', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('authToken')}`
        },
        body: JSON.stringify(body)
      });

      if (response.ok) {
        registroExitoso = true;
      } else {
        const result = await response.json();
        throw new Error(result.error || "Error al registrar paquete");
      }
    } catch (apiError) {
      console.warn('Error al conectar con API de paquetes:', apiError);
      
      // Si estamos en modo desarrollo o pruebas, simulamos éxito
      if (window.location.hostname === 'localhost' || 
          window.location.hostname === '127.0.0.1' ||
          confirm('No se pudo conectar con el servidor. ¿Deseas simular el registro para pruebas?')) {
        
        // Simular registro exitoso para pruebas
        console.log('Simulando registro exitoso. Datos del paquete:', body);
        
        // Guardar en localStorage para pruebas
        try {
          const paquetesGuardados = JSON.parse(localStorage.getItem('paquetesPrueba') || '[]');
          body.id = Date.now(); // Simular ID
          body.created_at = new Date().toISOString();
          paquetesGuardados.push(body);
          localStorage.setItem('paquetesPrueba', JSON.stringify(paquetesGuardados));
          console.log('Paquete guardado localmente para pruebas');
          registroExitoso = true;
        } catch (localError) {
          console.error('Error al guardar localmente:', localError);
          throw new Error('No se pudo conectar con el servidor ni guardar localmente');
        }
      } else {
        throw new Error('No se pudo conectar con el servidor. Intente más tarde.');
      }
    }
    
    if (registroExitoso) {
      alert('¡Paquete registrado exitosamente!');
      
      // En modo local, redirigir a la lista o recargar
      if (window.location.href.includes('listPackages.html')) {
        window.location.reload();
      } else {
        window.location.href = 'listPackages.html';
      }
    }
  } catch (error) {
    alert(error.message);
  }
});
  </script>

<script>
document.getElementById('generateQR').addEventListener('click', async function() {
    const apartment = document.getElementById('apartment_number').value;
    const sender = document.getElementById('sender').value;
    
    if (!apartment || !sender) {
        alert('Por favor complete los campos de departamento y remitente');
        return;
    }
    
    try {
        const response = await fetch('/api/generate-qr', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                apartment_number: apartment,
                sender: sender
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('qrImage').src = data.qr_code;
            document.getElementById('qrCodeText').textContent = data.qr_content;
            document.getElementById('qrDisplay').style.display = 'block';
            document.getElementById('qr_code').value = data.qr_content;
        } else {
            alert('Error al generar QR: ' + (data.error || ''));
        }
    } catch (error) {
        alert('Error de conexión: ' + error.message);
    }
});
</script>

</body>

</html>