<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Sistema de gestión de paquetes y encomiendas para edificios">
  <title>Registrar Paquete - Gestión de Paquetes</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Cargar QRCode de forma prioritaria -->
  <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
  
  <style>
    :root {
        --primary: #27ae60;
        --primary-dark: #145a32;
        --primary-light: #2ecc71;
        --secondary: #2c3e50;
        --accent: #3498db;
        --light: #f8f9fa;
        --dark: #212529;
        --gray: #6c757d;
        --gray-light: #e9ecef;
        --danger: #e74c3c;
        --warning: #f39c12;
        --info: #145a32;
        --success: #27ae60;
    }
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
        background-color: #a7f0b4;
        color: var(--dark);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .container {
        display: flex;
        min-height: 100vh;
        width: 100%;
    }
    
    .sidebar {
        width: 250px;
        background-color: #fff;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        z-index: 1000;
    }
    
    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid var(--gray-light);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .logo {
        font-size: 1.3rem;
        font-weight: bold;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }
    
    .logo img {
        height: 40px;
        width: auto;
        object-fit: contain;
    }
    
    .nav-menu {
        list-style: none;
        padding: 20px 0;
    }
    
    .nav-item {
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--gray);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 5px;
    }
    
    .nav-item:hover {
        background-color: rgba(46, 204, 113, 0.1);
        color: var(--primary);
    }
    
    .nav-item.active {
        background-color: rgba(46, 204, 113, 0.15);
        color: var(--primary);
        border-left: 3px solid var(--primary);
    }
    
    .nav-item i {
        width: 20px;
        text-align: center;
    }
    
    .main-content {
        flex: 1;
        padding: 20px;
        background-color: #e6fcea;
        transition: all 0.3s ease;
    }
    
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        margin-bottom: 30px;
    }
    
    .page-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--dark);
    }
    
    .user-profile {
        display: flex;
        align-items: center;
        gap: 10px;
        position: relative;
        cursor: pointer;
    }
    
    .notification {
        position: relative;
        margin-right: 20px;
        cursor: pointer;
    }
    
    .notification-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: var(--danger);
        color: white;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: bold;
    }
    
    .avatar {
        width: 40px;
        height: 40px;
        background-color: var(--primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: bold;
    }
    
    .user-info span {
        display: block;
    }
    
    .user-info .name {
        font-weight: 600;
    }
    
    .user-info .role {
        font-size: 0.8rem;
        color: var(--gray);
    }
    
    .card {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
        overflow: hidden;
    }
    
    .card-header {
        padding: 15px 20px;
        border-bottom: 1px solid var(--gray-light);
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .card-body {
        padding: 20px;
    }
    
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 15px;
        border-radius: 5px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        text-decoration: none;
    }
    
    .btn-primary {
        background-color: var(--primary);
        color: white;
    }
    
    .btn-primary:hover {
        background-color: var(--primary-dark);
    }
    
    .btn-secondary {
        background-color: var(--info);
        color: white;
    }
    
    .btn-secondary:hover {
        background-color: #145a32;
    }
    
    .btn-light {
        background-color: var(--gray-light);
        color: var(--gray);
    }
    
    .btn-light:hover {
        background-color: #dee2e6;
    }
    
    .btn-danger {
        background-color: var(--danger);
        color: white;
    }
    
    .btn-danger:hover {
        background-color: #c0392b;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--secondary);
    }
    
    .form-input {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid var(--gray-light);
        border-radius: 5px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2);
    }
    
    select.form-input {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23555' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 15px center;
        padding-right: 40px;
    }
    
    .form-input::placeholder {
        color: #adb5bd;
    }
    
    textarea.form-input {
        min-height: 100px;
        resize: vertical;
    }
    
    .form-error {
        display: none;
        color: var(--danger);
        font-size: 0.85rem;
        margin-top: 5px;
    }
    
    .invalid .form-input {
        border-color: var(--danger);
    }
    
    .invalid .form-error {
        display: block;
    }
    
    .qr-container {
        background-color: var(--light);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid var(--gray-light);
    }
    
    #qrCode {
        background-color: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin: 15px auto;
        display: none;
        max-width: 220px;
        text-align: center;
    }
    
    #qrCode.show {
        display: block;
    }
    
    .qr-buttons {
        display: none;
        gap: 10px;
        margin-top: 15px;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .qr-buttons.show {
        display: flex;
    }
    
    .qr-info {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 15px;
        padding: 10px;
        border-radius: 5px;
        background-color: rgba(52, 152, 219, 0.1);
        color: var(--gray);
        font-size: 0.9rem;
    }
    
    .qr-info i {
        color: var(--info);
    }
    
    .qr-loading {
        text-align: center;
        padding: 20px;
        color: var(--gray);
        font-style: italic;
    }
    
    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: white;
        border-radius: 5px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        padding: 15px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 1000;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease;
    }
    
    .toast.show {
        transform: translateY(0);
        opacity: 1;
    }
    
    .toast-success {
        border-left: 4px solid var(--success);
    }
    
    .toast-error {
        border-left: 4px solid var(--danger);
    }
    
    .toast-warning {
        border-left: 4px solid var(--warning);
    }
    
    .toast-info {
        border-left: 4px solid var(--info);
    }
    
    .toast-icon {
        font-size: 1.5rem;
    }
    
    .toast-success .toast-icon {
        color: var(--success);
    }
    
    .toast-error .toast-icon {
        color: var(--danger);
    }
    
    .toast-warning .toast-icon {
        color: var(--warning);
    }
    
    .toast-info .toast-icon {
        color: var(--info);
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    
    .loading-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    .spinner {
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 5px solid white;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .dropdown-menu {
        position: absolute;
        top: 100%;
        right: 0;
        background-color: #fff;
        border-radius: 5px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        width: 200px;
        padding: 10px 0;
        margin-top: 10px;
        display: none;
        z-index: 100;
    }
    
    .dropdown-menu.show {
        display: block;
    }
    
    .dropdown-item {
        padding: 10px 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9rem;
        color: var(--dark);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .dropdown-item:hover {
        background-color: var(--light);
    }
    
    .dropdown-item.logout {
        color: var(--danger);
        border-top: 1px solid var(--gray-light);
        margin-top: 5px;
        padding-top: 10px;
    }

    .code-preview {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 5px;
        padding: 10px;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        color: #495057;
        margin-top: 10px;
        display: none;
        max-height: 150px;
        overflow-y: auto;
    }
    
    .code-preview.show {
        display: block;
    }
    
    @media (max-width: 992px) {
        .main-content {
            padding: 15px;
        }
    }
    
    @media (max-width: 768px) {
        .sidebar {
            width: 70px;
        }
        
        .sidebar .logo span, 
        .sidebar .nav-item span {
            display: none;
        }
        
        .sidebar .nav-item {
            justify-content: center;
            padding: 15px 0;
        }
        
        .sidebar .nav-item i {
            margin-right: 0;
        }
        
        .sidebar .sidebar-header {
            padding: 15px 0;
        }
        
        .sidebar .logo {
            justify-content: center;
        }
        
        .header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .user-profile {
            align-self: flex-end;
            margin-top: 15px;
        }
        
        .qr-buttons {
            flex-direction: column;
        }
    }
    
    @media (max-width: 576px) {
        .main-content {
            padding: 10px;
        }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar / Menú Lateral -->
    <div class="sidebar">
        <div class="sidebar-header">
            <a href="#" class="logo">
              <img src="./images/favicon1.svg" alt="Logo Encomiendas">
                <span>PackTrack</span>
            </a>
        </div>
        <ul class="nav-menu">
            <li class="nav-item" onclick="navigateTo('dashboard.html')">
                <i class="fas fa-th-large"></i>
                <span>Dashboard</span>
            </li>
            <li class="nav-item active">
                <i class="fas fa-plus-square"></i>
                <span>Registrar Paquete</span>
            </li>
            <li class="nav-item" onclick="navigateTo('listPackages.html')">
                <i class="fas fa-list"></i>
                <span>Lista de Paquetes</span>
            </li>
            <li class="nav-item" onclick="navigateTo('departaments.html')">
                <i class="fas fa-building"></i>
                <span>Departamentos</span>
            </li>
            <li class="nav-item" onclick="navigateTo('codigoqr.html')">
                <i class="fas fa-qrcode"></i>
                <span>Lector QR</span>
            </li>
            <li class="nav-item " onclick="window.location.href='notificaciones.html'">
              <i class="fas fa-bell"></i>
              <span>Notificaciones</span>
          </li>
            
            <li class="nav-item" onclick="window.location.href='configuracion.html'">
              <i class="fas fa-cog"></i>
              <span>Configuración</span>
          </li>
            <li class="nav-item" onclick="navigateTo('login.html')" style="margin-top: 50px; color: #e74c3c;">
                <i class="fas fa-sign-out-alt"></i>
                <span>Cerrar Sesión</span>
            </li>
        </ul>
    </div>

    <!-- Contenido Principal -->
    <div class="main-content">
        <!-- Cabecera -->
        <div class="header">
            <h1 class="page-title">Registrar Paquete</h1>
            <div class="user-profile" id="userProfileDropdown">
                <div class="notification">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationCount">3</span>
                </div>
                <div class="avatar" id="userAvatar">A</div>
                <div class="user-info">
                    <span class="name" id="userName">Administrador</span>
                    <span class="role" id="userRole">Admin</span>
                </div>
                <i class="fas fa-chevron-down"></i>
                
                <!-- Menú desplegable de usuario -->
                <div class="dropdown-menu" id="userDropdown">
                    <div class="dropdown-item">
                        <i class="fas fa-user"></i>
                        <span>Mi Perfil</span>
                    </div>
                    <div class="dropdown-item">
                        <i class="fas fa-cog"></i>
                        <span>Configuración</span>
                    </div>
                    <div class="dropdown-item logout" onclick="navigateTo('login.html')">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Cerrar Sesión</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulario de Registro de Paquete -->
        <div class="card">
            <div class="card-header">
                Formulario de Registro de Paquete
            </div>
            <div class="card-body">
                <form id="packageForm" novalidate>
                    <div class="form-group">
                        <label for="apartment_number"><i class="fas fa-building"></i> Departamento</label>
                        <select id="apartment_number" class="form-input" required>
                            <option value="" disabled selected>Seleccione un departamento</option>
                            
                        </select>
                        <div class="form-error">Por favor seleccione un departamento</div>
                    </div>

                    <div class="form-group">
                        <label for="sender"><i class="fas fa-user"></i> Remitente</label>
                        <input type="text" id="sender" class="form-input" placeholder="Nombre de quien envía" required>
                        <span class="form-error">Ingresa el nombre del remitente</span>
                    </div>

                    <div class="form-group">
                        <label for="recipient"><i class="fas fa-user-tag"></i> Destinatario (Opcional)</label>
                        <input type="text" id="recipient" class="form-input" placeholder="Nombre del destinatario">
                    </div>

                    <div class="form-group">
                        <label for="delivery_date"><i class="fas fa-calendar-alt"></i> Fecha de entrega</label>
                        <input type="date" id="delivery_date" class="form-input" required>
                        <span class="form-error">Selecciona una fecha válida</span>
                    </div>

                    <div class="form-group">
                        <label for="status"><i class="fas fa-tag"></i> Estado</label>
                        <select id="status" class="form-input" required>
                            <option value="">-- Selecciona Estado --</option>
                            <option value="pendiente" selected>Pendiente</option>
                            <option value="entregado">Entregado</option>
                            <option value="retirado">Retirado</option>
                        </select>
                        <span class="form-error">Selecciona un estado</span>
                    </div>

                    <div class="form-group">
                        <label for="description"><i class="fas fa-box"></i> Descripción del Paquete (Opcional)</label>
                        <input type="text" id="description" class="form-input" placeholder="Ej: Sobre, Caja pequeña, Medicamentos">
                    </div>

                    <div class="qr-container">
                        <button type="button" id="generateQrBtn" class="btn btn-secondary">
                            <i class="fas fa-qrcode"></i> Generar Código QR
                        </button>
                        
                        <div id="qrCode">
                            <!-- El QR se generará aquí -->
                        </div>
                        
                        <div class="form-group" style="margin-top: 15px;">
                            <input type="text" id="qr_code" class="form-input" placeholder="Código QR (generado automáticamente)" readonly>
                        </div>
                        
                        <div id="codePreview" class="code-preview">
                            <strong>Vista previa del contenido QR:</strong>
                            <div id="codeContent"></div>
                        </div>
                        
                        <div class="qr-buttons" id="qrButtons">
                            <button type="button" class="btn btn-primary" id="printQrBtn">
                                <i class="fas fa-print"></i> Imprimir QR
                            </button>
                            <button type="button" class="btn btn-light" id="downloadQrBtn">
                                <i class="fas fa-download"></i> Descargar QR
                            </button>
                        </div>
                        
                        <div class="qr-info">
                            <i class="fas fa-info-circle"></i> 
                            <span>El código QR contiene la información del paquete y facilita su seguimiento. El mismo código se usará como ID del paquete.</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="notes"><i class="fas fa-sticky-note"></i> Notas (opcional)</label>
                        <textarea id="notes" class="form-input" rows="3" placeholder="Agrega observaciones o detalles adicionales"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Registrar Paquete
                    </button>
                </form>
            </div>
        </div>

  <!-- Toast notifications -->
  <div id="toastSuccess" class="toast toast-success">
    <div class="toast-icon">
      <i class="fas fa-check-circle"></i>
    </div>
    <div class="toast-message">¡Paquete registrado exitosamente!</div>
  </div>

  <div id="toastError" class="toast toast-error">
    <div class="toast-icon">
      <i class="fas fa-exclamation-circle"></i>
    </div>
    <div class="toast-message" id="errorMessage">Ha ocurrido un error.</div>
  </div>

  <div id="toastWarning" class="toast toast-warning">
    <div class="toast-icon">
      <i class="fas fa-exclamation-triangle"></i>
    </div>
    <div class="toast-message" id="warningMessage">Advertencia</div>
  </div>

  <div id="toastInfo" class="toast toast-info">
    <div class="toast-icon">
      <i class="fas fa-info-circle"></i>
    </div>
    <div class="toast-message" id="infoMessage">Información</div>
  </div>

  <!-- Loading overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
  </div>

  <script>
    console.log('=== SISTEMA DE REGISTRO DE PAQUETES ===');
    console.log('Inicializando sistema...');
    
    // Variables globales
    let currentPackageId = null;
    let qrCodeInstance = null;

    // Verificar QRCode inmediatamente
    function isQRCodeReady() {
        const available = (typeof QRCode !== 'undefined' && 
                          QRCode && 
                          typeof QRCode.toCanvas === 'function');
        console.log(available ? 'QRCode disponible' : 'QRCode no disponible');
        return available;
    }

    // Función simplificada para mostrar toast
    function showToast(type, message) {
        console.log(`Toast ${type}: ${message}`);
        
        const toastId = `toast${type.charAt(0).toUpperCase() + type.slice(1)}`;
        const toastElement = document.getElementById(toastId);
        
        if (toastElement) {
            const messageElement = toastElement.querySelector('.toast-message');
            if (messageElement) {
                messageElement.textContent = message;
            }
            
            toastElement.classList.add('show');
            
            setTimeout(() => {
                toastElement.classList.remove('show');
            }, 4000);
        } else {
            console.warn('Toast element not found:', toastId);
            alert(`${type.toUpperCase()}: ${message}`);
        }
    }
    
    // Función de navegación
    function navigateTo(page) {
        console.log('Navegando a:', page);
        window.location.href = page;
    }
    
    // Función para generar ID único
    function generatePackageId(departmentNumber) {
        const timestamp = Date.now();
        const randomSuffix = Math.random().toString(36).substring(2, 5).toUpperCase();
        return `PKG-${departmentNumber}-${timestamp}-${randomSuffix}`;
    }
    
    // Función para formatear fecha
    function formatDate(dateString) {
        try {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('es-ES', options);
        } catch (error) {
            console.error('Error al formatear fecha:', error);
            return dateString;
        }
    }
    
    // Función para obtener departamentos
    function getAllDepartments() {
        try {
            const departmentsString = localStorage.getItem('departments');
            if (!departmentsString) return [];
            
            const departments = JSON.parse(departmentsString);
            if (Array.isArray(departments)) {
                return departments.map(dept => ({
                    number: dept.number || dept.id || dept
                })).filter(dept => dept.number);
            }
            return [];
        } catch (error) {
            console.error('Error al obtener departamentos:', error);
            return [];
        }
    }
    
    // Función para cargar departamentos
    function loadDepartments() {
        console.log('Cargando departamentos...');
        
        const departmentSelect = document.getElementById('apartment_number');
        if (!departmentSelect) {
            console.error('Selector de departamentos no encontrado');
            return;
        }
        
        const departments = getAllDepartments();
        console.log('Departamentos encontrados:', departments.length);
        
        // Limpiar opciones existentes excepto la primera
        while (departmentSelect.options.length > 1) {
            departmentSelect.remove(1);
        }
        
        // Agregar departamentos
        departments.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept.number;
            option.textContent = `Departamento ${dept.number}`;
            departmentSelect.appendChild(option);
        });
        
        // Agregar opción para nuevo departamento
        const newOption = document.createElement('option');
        newOption.value = "new";
        newOption.textContent = "+ Agregar nuevo departamento";
        departmentSelect.appendChild(newOption);
        
        console.log('Departamentos cargados');
    }

    // Función principal para generar QR
    function generateQRCode() {
        console.log('=== INICIANDO GENERACIÓN DE QR ===');
        
        // Verificar librería QRCode
        if (!isQRCodeReady()) {
            console.error('QRCode no está disponible');
            showToast('error', 'Error: La librería de códigos QR no está disponible. Recarga la página.');
            return;
        }
        
        // Obtener elementos
        const departmentSelect = document.getElementById('apartment_number');
        const senderInput = document.getElementById('sender');
        const dateInput = document.getElementById('delivery_date');
        const qrCodeDiv = document.getElementById('qrCode');
        const qrCodeInput = document.getElementById('qr_code');
        const qrButtons = document.getElementById('qrButtons');
        const codePreview = document.getElementById('codePreview');
        const codeContent = document.getElementById('codeContent');
        
        // Verificar elementos críticos
        if (!departmentSelect || !senderInput || !dateInput || !qrCodeDiv) {
            console.error('Elementos faltantes en el DOM');
            showToast('error', 'Error: Faltan elementos en la página');
            return;
        }
        
        console.log('Elementos DOM verificados');
        
        // Validar campos
        if (!departmentSelect.value || departmentSelect.value === 'new') {
            showToast('warning', 'Por favor selecciona un departamento válido');
            departmentSelect.focus();
            return;
        }
        
        if (!senderInput.value.trim()) {
            showToast('warning', 'Por favor ingresa el nombre del remitente');
            senderInput.focus();
            return;
        }
        
        if (!dateInput.value) {
            showToast('warning', 'Por favor selecciona una fecha de entrega');
            dateInput.focus();
            return;
        }
        
        console.log('Validaciones pasadas');
        
        // Generar ID del paquete
        currentPackageId = generatePackageId(departmentSelect.value);
        qrCodeInput.value = currentPackageId;
        
        console.log('ID generado:', currentPackageId);
        
        // Crear datos del QR
        const qrData = {
            id: currentPackageId,
            apartment_number: departmentSelect.value,
            sender: senderInput.value.trim(),
            delivery_date: dateInput.value,
            description: document.getElementById('description').value.trim(),
            status: document.getElementById('status').value || 'pendiente',
            generated: new Date().toISOString(),
            type: 'package_registration',
            building: 'PackTrack System'
        };
        
        const qrText = JSON.stringify(qrData);
        console.log('Contenido QR creado:', qrText.length, 'caracteres');
        
        // Mostrar preview
        if (codeContent && codePreview) {
            codeContent.textContent = qrText;
            codePreview.classList.add('show');
        }
        
        // Mostrar indicador de carga
        qrCodeDiv.innerHTML = '<div class="qr-loading">Generando código QR...</div>';
        qrCodeDiv.classList.add('show');
        
        // Generar QR
        setTimeout(() => {
            try {
                console.log('Creando QR visual...');
                
                // Limpiar contenedor
                qrCodeDiv.innerHTML = '';
                
                // Crear QR
                QRCode.toCanvas(qrText, {
                    width: 200,
                    height: 200,
                    color: {
                        dark: '#000000',
                        light: '#ffffff'
                    },
                    errorCorrectionLevel: 'H'
                }, function (error, canvas) {
                    if (error) {
                        console.error('Error generando QR:', error);
                        qrCodeDiv.innerHTML = `
                            <div style="color: red; text-align: center; padding: 20px;">
                                Error al generar QR<br>
                                <small>${error.message}</small>
                            </div>
                        `;
                        showToast('error', 'Error al generar código QR: ' + error.message);
                    } else {
                        console.log('QR generado exitosamente');
                        
                        // Añadir canvas al contenedor
                        qrCodeDiv.appendChild(canvas);
                        qrCodeDiv.classList.add('show');
                        
                        // Mostrar botones
                        if (qrButtons) {
                            qrButtons.classList.add('show');
                        }
                        
                        showToast('success', `Código QR generado correctamente! ID: ${currentPackageId}`);
                        console.log('Proceso completado exitosamente');
                    }
                });
                
            } catch (error) {
                console.error('Error crítico:', error);
                qrCodeDiv.innerHTML = `
                    <div style="color: red; text-align: center; padding: 20px;">
                        Error crítico<br>
                        <small>${error.message}</small>
                    </div>
                `;
                showToast('error', 'Error crítico al generar QR');
            }
        }, 300);
    }
    
    // Función para imprimir QR
    function printQRCode() {
        if (!currentPackageId) {
            showToast('warning', 'Primero debes generar un código QR');
            return;
        }
        
        const qrCodeDiv = document.getElementById('qrCode');
        const canvas = qrCodeDiv.querySelector('canvas');
        
        if (!canvas) {
            showToast('error', 'No se encontró el código QR para imprimir');
            return;
        }
        
        const printWindow = window.open('', '_blank');
        
        const departmentSelect = document.getElementById('apartment_number');
        const senderInput = document.getElementById('sender');
        const dateInput = document.getElementById('delivery_date');
        
        const printContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Código QR - ${currentPackageId}</title>
                <style>
                    body { 
                        font-family: Arial, sans-serif;
                        text-align: center; 
                        margin: 20px;
                    }
                    .qr-print { 
                        margin: 20px auto;
                        padding: 20px;
                        border: 2px solid #27ae60;
                        border-radius: 10px;
                        max-width: 400px;
                    }
                    .details { 
                        margin: 20px 0; 
                        text-align: left;
                        background: #f9f9f9;
                        padding: 15px;
                        border-radius: 8px;
                    }
                    h1 { color: #27ae60; }
                    .package-id {
                        font-family: monospace;
                        background: #e8f5e9;
                        padding: 5px;
                        border-radius: 3px;
                        font-weight: bold;
                    }
                </style>
            </head>
            <body>
                <h1>Código QR del Paquete</h1>
                <div class="qr-print">
                    <img src="${canvas.toDataURL()}" alt="Código QR" style="max-width: 100%;">
                </div>
                <div class="details">
                    <h3>Información del Paquete</h3>
                    <p><strong>ID:</strong> <span class="package-id">${currentPackageId}</span></p>
                    <p><strong>Departamento:</strong> ${departmentSelect.value}</p>
                    <p><strong>Remitente:</strong> ${senderInput.value}</p>
                    <p><strong>Fecha:</strong> ${formatDate(dateInput.value)}</p>
                    <p><strong>Generado el:</strong> ${new Date().toLocaleString('es-ES')}</p>
                </div>
            </body>
            </html>
        `;
        
        printWindow.document.write(printContent);
        printWindow.document.close();
        
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 500);
        
                                showToast('info', 'Preparando impresión...');
    }
    
    // Función para descargar QR
    function downloadQRCode() {
        if (!currentPackageId) {
            showToast('warning', 'Primero debes generar un código QR');
            return;
        }
        
        const qrCodeDiv = document.getElementById('qrCode');
        const canvas = qrCodeDiv.querySelector('canvas');
        
        if (!canvas) {
            showToast('error', 'No se encontró el código QR para descargar');
            return;
        }
        
        try {
            const imgData = canvas.toDataURL('image/png');
            const downloadLink = document.createElement('a');
            
            downloadLink.href = imgData;
            downloadLink.download = `QR_${currentPackageId}.png`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            showToast('success', 'Código QR descargado exitosamente');
        } catch (error) {
            console.error('Error al descargar:', error);
            showToast('error', 'Error al descargar el código QR');
        }
    }

    // Función para validar campo
    function validateField(field) {
        const parent = field.closest('.form-group');
        if (!parent) return true;
        
        if (field.hasAttribute('required') && !field.value.trim()) {
            parent.classList.add('invalid');
            return false;
        } else {
            parent.classList.remove('invalid');
            return true;
        }
    }

    // Función para validar formulario
    function validateForm() {
        const form = document.getElementById('packageForm');
        if (!form) return true;
        
        let isValid = true;
        const requiredInputs = form.querySelectorAll('.form-input[required]');
        
        requiredInputs.forEach(input => {
            if (!validateField(input)) {
                isValid = false;
            }
        });
        
        return isValid;
    }

    // Función para manejar envío del formulario
    function handleFormSubmit(e) {
        e.preventDefault();
        console.log('=== ENVIANDO FORMULARIO ===');
        
        if (!validateForm()) {
            showToast('warning', 'Por favor completa todos los campos requeridos');
            return;
        }

        if (!currentPackageId) {
            const confirm = window.confirm('No has generado un código QR. ¿Deseas continuar sin QR?');
            if (!confirm) return;
            
            const deptValue = document.getElementById('apartment_number').value;
            currentPackageId = generatePackageId(deptValue);
        }
        
        // Mostrar loading
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.classList.add('active');
        }
        
        try {
            const packageData = {
                id: currentPackageId,
                apartment_number: document.getElementById('apartment_number').value,
                sender: document.getElementById('sender').value.trim(),
                recipient: document.getElementById('recipient').value.trim(),
                delivery_date: document.getElementById('delivery_date').value,
                status: document.getElementById('status').value || 'pendiente',
                description: document.getElementById('description').value.trim(),
                qr_code: currentPackageId,
                notes: document.getElementById('notes').value.trim(),
                created_at: new Date().toISOString()
            };
            
            console.log('Guardando paquete:', packageData);
            
            // Guardar en localStorage
            const existingPackages = JSON.parse(localStorage.getItem('paquetesPrueba')) || [];
            existingPackages.push(packageData);
            localStorage.setItem('paquetesPrueba', JSON.stringify(existingPackages));
            
            // Actualizar contador
            const pendingCount = existingPackages.filter(pkg => pkg.status === 'pendiente').length;
            localStorage.setItem('pendingPackagesCount', pendingCount.toString());
            
            console.log('Paquete guardado exitosamente');
            showToast('success', `¡Paquete registrado exitosamente! ID: ${packageData.id}`);
            
            setTimeout(() => {
                window.location.href = 'listPackages.html';
            }, 2000);
            
        } catch (error) {
            console.error('Error al guardar:', error);
            showToast('error', 'Error al registrar el paquete: ' + error.message);
        } finally {
            // Ocultar loading
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.classList.remove('active');
            }
        }
    }

    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== INICIANDO APLICACIÓN ===');
        
        try {
            // Verificar QRCode
            if (isQRCodeReady()) {
                console.log('QRCode listo desde el inicio');
            } else {
                console.warn('QRCode no disponible al inicio');
                showToast('warning', 'Cargando sistema de códigos QR...');
            }
            
            // Cargar departamentos
            loadDepartments();
            
            // Configurar fecha actual
            const dateInput = document.getElementById('delivery_date');
            if (dateInput) {
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
                console.log('Fecha establecida:', today);
            }
            
            // Event listeners
            const generateBtn = document.getElementById('generateQrBtn');
            if (generateBtn) {
                generateBtn.addEventListener('click', generateQRCode);
                console.log('Botón QR configurado');
            }
            
            const printBtn = document.getElementById('printQrBtn');
            if (printBtn) {
                printBtn.addEventListener('click', printQRCode);
            }
            
            const downloadBtn = document.getElementById('downloadQrBtn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', downloadQRCode);
            }
            
            const packageForm = document.getElementById('packageForm');
            if (packageForm) {
                packageForm.addEventListener('submit', handleFormSubmit);
                console.log('Formulario configurado');
            }
            
            // Validación en tiempo real
            const inputs = document.querySelectorAll('.form-input');
            inputs.forEach(input => {
                input.addEventListener('blur', (e) => validateField(e.target));
                input.addEventListener('input', (e) => {
                    if (e.target.closest('.form-group').classList.contains('invalid')) {
                        validateField(e.target);
                    }
                });
            });
            
            // Manejar selección de departamento
            const deptSelect = document.getElementById('apartment_number');
            if (deptSelect) {
                deptSelect.addEventListener('change', function() {
                    if (this.value === 'new') {
                        const newDept = prompt('Ingrese el número del nuevo departamento:');
                        if (newDept && !isNaN(newDept)) {
                            const deptNumber = newDept.toString();
                            
                            // Verificar si ya existe
                            const departments = getAllDepartments();
                            const exists = departments.some(dept => dept.number === deptNumber);
                            
                            if (exists) {
                                showToast('warning', 'Este departamento ya existe');
                                this.value = '';
                                return;
                            }
                            
                            // Añadir nuevo departamento
                            departments.push({ number: deptNumber });
                            localStorage.setItem('departments', JSON.stringify(departments));
                            
                            // Crear opción
                            const option = document.createElement('option');
                            option.value = deptNumber;
                            option.textContent = `Departamento ${deptNumber}`;
                            
                            // Insertar antes de la opción 'Agregar nuevo'
                            const newIndex = this.options.length - 1;
                            this.insertBefore(option, this.options[newIndex]);
                            
                            // Seleccionar el nuevo departamento
                            this.value = deptNumber;
                            showToast('success', `Departamento ${deptNumber} agregado`);
                        } else {
                            this.value = '';
                            showToast('warning', 'Número de departamento inválido');
                        }
                    }
                });
            }
            
            // Dropdown de usuario
            const userProfileDropdown = document.getElementById('userProfileDropdown');
            const userDropdown = document.getElementById('userDropdown');
            
            if (userProfileDropdown && userDropdown) {
                userProfileDropdown.addEventListener('click', function(e) {
                    userDropdown.classList.toggle('show');
                    e.stopPropagation();
                });
                
                document.addEventListener('click', function(e) {
                    if (!userProfileDropdown.contains(e.target)) {
                        userDropdown.classList.remove('show');
                    }
                });
            }
            
            console.log('Aplicación inicializada correctamente');
            showToast('success', 'Sistema de registro listo!');
            
        } catch (error) {
            console.error('Error al inicializar:', error);
            showToast('error', 'Error al inicializar: ' + error.message);
        }
    });

    // Verificación final de QRCode después de un delay
    setTimeout(() => {
        if (isQRCodeReady()) {
            console.log('Verificación final: QRCode OK');
        } else {
            console.error('QRCode sigue sin estar disponible');
            showToast('error', 'Problema con la librería QR. Recarga la página.');
        }
    }, 2000);
  </script>
</body>
</html>