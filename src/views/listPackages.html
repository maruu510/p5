<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Paquetes - Gestión de Paquetes</title>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
        }

        :root {
            --primary: #27ae60;
            --primary-dark: #1e8449;
            --text: #2c3e50;
            --background: #f8fafc;
            --white: #ffffff;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-700: #334155;
        }

        body {
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.25rem;
            position: relative;
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 28rem;
            width: 90%;
        }

        header {
            width: 100%;
            max-width: 64rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--white);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        header img {
            height: 3rem;
            width: auto;
        }

        header h1 {
            font-size: 1.5rem;
            color: var(--text);
            font-weight: 600;
        }

        .btn {
            background-color: var(--primary);
            color: var(--white);
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background-color: var(--primary-dark);
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .logout-btn {
            position: absolute;
            top: 1.25rem;
            right: 1.25rem;
        }

        .container {
            background-color: var(--white);
            max-width: 64rem;
            width: 100%;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        .container-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .loading-spinner {
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .table-container {
            overflow-x: auto;
            margin: 0 -1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            min-width: 40rem;
        }

        thead {
            background-color: var(--gray-100);
        }

        th {
            font-weight: 600;
            text-align: left;
            color: var(--gray-700);
        }

        th, td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        tbody tr:hover {
            background-color: var(--gray-100);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: capitalize;
        }

        .status-pendiente {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-retirado {
            background-color: #dcfce7;
            color: #166534;
        }

        .error-message {
            background-color: #fee2e2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 640px) {
            .container {
                padding: 1rem;
            }

            .container-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .logout-btn {
                position: static;
                margin-top: 1rem;
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <header>
        <img src="./images/ENCOMIENDA.png" alt="Logo de Gestión de Paquetes">
        <h1>Lista de Paquetes</h1>
    </header>

    <button class="btn logout-btn" onclick="logout()" id="logoutBtn">
        <span>Cerrar Sesión</span>
    </button>

    <div class="container">
        <div class="container-header">
            <h2>Paquetes Registrados</h2>
            <a href="registerPackage.html" class="btn">Registrar Nuevo Paquete</a>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;">
            Ha ocurrido un error al cargar los paquetes
        </div>

        <div class="table-container">
            <table id="packagesTable" aria-label="Lista de paquetes registrados">
                <thead>
                    <tr>
                        <th scope="col">ID</th>
                        <th scope="col">Departamento</th>
                        <th scope="col">Remitente</th>
                        <th scope="col">Fecha Entrega</th>
                        <th scope="col">Estado</th>
                        <th scope="col">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="6" style="text-align: center;">
                            <div class="loading-spinner"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="confirmModal" class="overlay" style="display: none;">
        <div class="modal">
            <h3>Confirmar actualización</h3>
            <p style="margin: 1rem 0;">¿Está seguro que desea marcar este paquete como retirado?</p>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn" style="background-color: var(--gray-700);" onclick="closeModal()">Cancelar</button>
                <button class="btn" id="confirmButton">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        let currentPackageId = null;

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = 'login.html';
            } else {
                loadPackages();
            }
        });

        function logout() {
            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn.disabled = true;
            localStorage.removeItem('authToken');
            window.location.href = 'login.html';
        }

        async function loadPackages() {
            const errorMessage = document.getElementById('errorMessage');
            const tbody = document.querySelector('#packagesTable tbody');
            
            try {
                const response = await fetch('/api/packages', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (!response.ok) throw new Error('Error al cargar los paquetes');

                const packages = await response.json();
                errorMessage.style.display = 'none';
                
                tbody.innerHTML = packages.map(pkg => `
                    <tr>
                        <td>${pkg.id}</td>
                        <td>${pkg.apartment_number}</td>
                        <td>${pkg.sender}</td>
                        <td>${new Date(pkg.delivery_date).toLocaleDateString('es-ES')}</td>
                        <td>
                            <span class="status-badge status-${pkg.status.toLowerCase()}">
                                ${pkg.status}
                            </span>
                        </td>
                        <td>
                            ${pkg.status === 'pendiente'
                                ? `<button class="btn" onclick="showConfirmModal(${pkg.id})" aria-label="Marcar paquete ${pkg.id} como retirado">
                                    Marcar Retirado
                                   </button>`
                                : ''}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error:', error);
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Ha ocurrido un error al cargar los paquetes';
            }
        }

        function showConfirmModal(packageId) {
            currentPackageId = packageId;
            document.getElementById('confirmModal').style.display = 'flex';
            document.getElementById('confirmButton').onclick = () => updateStatus(packageId);
        }

        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
            currentPackageId = null;
        }

        async function updateStatus(id) {
            const confirmButton = document.getElementById('confirmButton');
            confirmButton.disabled = true;
            
            try {
                const response = await fetch(`/api/packages/${id}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ status: 'retirado' })
                });

                if (!response.ok) throw new Error('Error al actualizar el estado');

                await loadPackages();
                closeModal();
            } catch (error) {
                console.error('Error:', error);
                alert('Ha ocurrido un error al actualizar el estado del paquete');
            } finally {
                confirmButton.disabled = false;
            }
        }

        // Cerrar modal con Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>