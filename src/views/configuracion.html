<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Configuración del sistema de gestión de paquetes y encomiendas">
  <title>Configuración - Gestión de Paquetes</title>
  <!-- Core Utilities -->
<script src="./js/utils/utils.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
        --primary: #0c4d29;
        --primary-dark: #103520;
        --primary-light: #0c341d;
        --secondary: #2c3e50;
        --accent: #3498db;
        --light: #f8f9fa;
        --dark: #212529;
        --gray: #6c757d;
        --gray-light: #e9ecef;
        --danger: #e74c3c;
        --warning: #f39c12;
        --info: #3498db;
        --success: #27ae60;
    }
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
        background-color: #f5f7fb;
        color: var(--dark);
        min-height: 100vh;
    }
    
    .container {
        display: flex;
        min-height: 100vh;
        width: 100%;
    }
    
    .sidebar {
        width: 250px;
        background-color: #fff;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        z-index: 1000;
    }
    
    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid var(--gray-light);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .logo {
        font-size: 1.3rem;
        font-weight: bold;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }
    
    .logo img {
        height: 36px;
        width: auto;
        object-fit: contain;
    }
    
    .nav-menu {
        list-style: none;
        padding: 20px 0;
    }
    
    .nav-item {
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--gray);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 5px;
    }
    
    .nav-item:hover {
        background-color: rgba(46, 204, 113, 0.1);
        color: var(--primary);
    }
    
    .nav-item.active {
        background-color: rgba(46, 204, 113, 0.15);
        color: var(--primary);
        border-left: 3px solid var(--primary);
    }
    
    .nav-item i {
        width: 20px;
        text-align: center;
    }
    
    .main-content {
        flex: 1;
        padding: 20px;
        background-color: #ddf8e3ea;
        transition: all 0.3s ease;
    }
    
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        margin-bottom: 30px;
    }
    
    .page-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--dark);
    }
    
    .user-profile {
        display: flex;
        align-items: center;
        gap: 10px;
        position: relative;
        cursor: pointer;
    }
    
    .avatar {
        width: 40px;
        height: 40px;
        background-color: var(--primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: bold;
    }
    
    .user-info span {
        display: block;
    }
    
    .user-info .name {
        font-weight: 600;
    }
    
    .user-info .role {
        font-size: 0.8rem;
        color: var(--gray);
    }
    
    .card {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
        overflow: hidden;
    }
    
    .card-header {
        padding: 15px 20px;
        border-bottom: 1px solid var(--gray-light);
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .card-body {
        padding: 20px;
    }
    
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 15px;
        border-radius: 5px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        text-decoration: none;
    }
    
    .btn-primary {
        background-color: var(--primary);
        color: white;
    }
    
    .btn-primary:hover {
        background-color: var(--primary-dark);
    }
    
    .btn-secondary {
        background-color: var(--info);
        color: white;
    }
    
    .btn-secondary:hover {
        background-color: #2980b9;
    }
    
    .btn-light {
        background-color: var(--gray-light);
        color: var(--gray);
    }
    
    .btn-light:hover {
        background-color: #dee2e6;
    }
    
    .btn-danger {
        background-color: var(--danger);
        color: white;
    }
    
    .btn-danger:hover {
        background-color: #c0392b;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--secondary);
    }
    
    .form-input {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid var(--gray-light);
        border-radius: 5px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2);
    }
    
    .form-input::placeholder {
        color: #adb5bd;
    }
    
    .form-error {
        display: none;
        color: var(--danger);
        font-size: 0.85rem;
        margin-top: 5px;
    }
    
    .invalid .form-input {
        border-color: var(--danger);
    }
    
    .invalid .form-error {
        display: block;
    }
    
    .tabs {
        display: flex;
        border-bottom: 1px solid var(--gray-light);
        margin-bottom: 20px;
        overflow-x: auto;
    }
    
    .tab {
        padding: 10px 20px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        font-weight: 500;
        transition: all 0.3s ease;
        white-space: nowrap;
    }
    
    .tab:hover {
        color: var(--primary);
    }
    
    .tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .profile-section {
        display: flex;
        margin-bottom: 30px;
        gap: 30px;
    }
    
    .profile-image {
        flex: 0 0 150px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }
    
    .profile-avatar {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background-color: var(--primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        margin-bottom: 10px;
    }
    
    .profile-details {
        flex: 1;
    }
    
    .upload-btn {
        margin-top: 10px;
        font-size: 0.9rem;
    }
    
    .table-container {
        overflow-x: auto;
        margin-bottom: 20px;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .data-table th,
    .data-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid var(--gray-light);
    }
    
    .data-table th {
        background-color: var(--light);
        font-weight: 600;
        color: var(--secondary);
    }
    
    .data-table tbody tr:hover {
        background-color: rgba(246, 248, 250, 0.8);
    }
    
    .badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        display: inline-block;
    }
    
    .badge-primary {
        background-color: rgba(39, 174, 96, 0.2);
        color: var(--primary-dark);
    }
    
    .badge-danger {
        background-color: rgba(231, 76, 60, 0.2);
        color: #c0392b;
    }
    
    .badge-warning {
        background-color: rgba(243, 156, 18, 0.2);
        color: #d68910;
    }
    
    .badge-info {
        background-color: rgba(52, 152, 219, 0.2);
        color: #2980b9;
    }
    
    .action-buttons {
        display: flex;
        gap: 5px;
    }
    
    .btn-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
    }
    
    .btn-view {
        background-color: var(--info);
    }
    
    .btn-edit {
        background-color: var(--warning);
    }
    
    .btn-delete {
        background-color: var(--danger);
    }
    
    .btn-login {
        background-color: var(--success);
    }
    
    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: white;
        border-radius: 5px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        padding: 15px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 1000;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease;
    }
    
    .toast.show {
        transform: translateY(0);
        opacity: 1;
    }
    
    .toast-success {
        border-left: 4px solid var(--success);
    }
    
    .toast-error {
        border-left: 4px solid var(--danger);
    }
    
    .toast-icon {
        font-size: 1.5rem;
    }
    
    .toast-success .toast-icon {
        color: var(--success);
    }
    
    .toast-error .toast-icon {
        color: var(--danger);
    }
    
    /* Estilos para los modales */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1050;
        align-items: center;
        justify-content: center;
        overflow-y: auto;
        padding: 30px 0;
    }
    
    .modal.show {
        display: flex;
    }
    
    .modal-dialog {
        width: 100%;
        max-width: 500px;
        margin: auto;
        pointer-events: none;
    }
    
    .modal-dialog.large {
        max-width: 700px;
    }
    
    .modal-content {
        position: relative;
        display: flex;
        flex-direction: column;
        width: 100%;
        pointer-events: auto;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        outline: 0;
    }
    
    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px 20px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .modal-title {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
    }
    
    .close-button {
        background: transparent;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0;
        color: #6c757d;
        line-height: 1;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        padding: 15px 20px;
        border-top: 1px solid #e9ecef;
    }

    /* Estilos para mostrar credenciales */
    .credentials-display {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
    }

    .credentials-title {
        font-weight: 600;
        color: var(--primary);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .credential-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
    }

    .credential-item:last-child {
        border-bottom: none;
    }

    .credential-label {
        font-weight: 500;
        color: var(--secondary);
    }

    .credential-value {
        font-family: 'Courier New', monospace;
        background-color: white;
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        font-size: 0.9rem;
    }

    /* Estilos específicos para reclamos */
    .complaint-filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: center;
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter-group select {
        padding: 8px 12px;
        border: 1px solid var(--gray-light);
        border-radius: 5px;
        font-size: 0.9rem;
    }

    .complaint-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .summary-card {
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        color: white;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
    }

    .summary-card.pending {
        background: linear-gradient(135deg, var(--warning), #e67e22);
    }

    .summary-card.processing {
        background: linear-gradient(135deg, var(--info), #2980b9);
    }

    .summary-card.resolved {
        background: linear-gradient(135deg, var(--success), #229954);
    }

    .summary-number {
        font-size: 2rem;
        font-weight: bold;
        display: block;
    }

    .summary-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .complaint-details {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }

    .complaint-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-bottom: 15px;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
    }

    .complaint-description {
        background-color: white;
        border: 1px solid #e9ecef;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
    }

    .response-section {
        margin-top: 20px;
    }

    .response-history {
        max-height: 300px;
        overflow-y: auto;
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
    }

    .response-item {
        background-color: white;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
        border-left: 3px solid var(--primary);
    }

    .response-item:last-child {
        margin-bottom: 0;
    }

    .response-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-size: 0.9rem;
    }

    .response-author {
        font-weight: 600;
        color: var(--primary);
    }

    .response-date {
        color: var(--gray);
        font-size: 0.8rem;
    }

    .priority-high {
        color: var(--danger);
        font-weight: bold;
    }

    .priority-medium {
        color: var(--warning);
        font-weight: bold;
    }

    .priority-low {
        color: var(--success);
        font-weight: bold;
    }
    
    @media (max-width: 992px) {
        .main-content {
            padding: 15px;
        }
        
        .profile-section {
            flex-direction: column;
            align-items: center;
        }
        
        .profile-details {
            width: 100%;
        }

        .complaint-filters {
            flex-direction: column;
            align-items: stretch;
        }

        .filter-group {
            justify-content: space-between;
        }
    }
    
    @media (max-width: 768px) {
        .sidebar {
            width: 70px;
        }
        
        .sidebar .logo span, 
        .sidebar .nav-item span {
            display: none;
        }
        
        .sidebar .nav-item {
            justify-content: center;
            padding: 15px 0;
        }
        
        .sidebar .nav-item i {
            margin-right: 0;
        }
        
        .sidebar .sidebar-header {
            padding: 15px 0;
        }
        
        .sidebar .logo {
            justify-content: center;
        }
        
        .header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .user-profile {
            align-self: flex-end;
            margin-top: 15px;
        }
        
        .tabs {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 5px;
        }

        .complaint-summary {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 576px) {
        .main-content {
            padding: 10px;
        }

        .complaint-summary {
            grid-template-columns: 1fr;
        }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar / Menú Lateral -->
    <div class="sidebar">
        <div class="sidebar-header">
            <a href="dashboard.html" class="logo">
                <img src="./images/favicon1.svg" alt="Logo Encomiendas">
                <span>PackTrack</span>
            </a>
        </div>
        <ul class="nav-menu">
            <li class="nav-item" onclick="window.location.href='dashboard.html'">
                <i class="fas fa-th-large"></i>
                <span>Dashboard</span>
            </li>
            <li class="nav-item" onclick="window.location.href='registerPackage.html'">
                <i class="fas fa-plus-square"></i>
                <span>Registrar Paquete</span>
            </li>
            <li class="nav-item" onclick="window.location.href='listPackages.html'">
                <i class="fas fa-list"></i>
                <span>Lista de Paquetes</span>
            </li>
            <li class="nav-item" onclick="window.location.href='departaments.html'">
                <i class="fas fa-building"></i>
                <span>Departamentos</span>
            </li>
            <li class="nav-item" onclick="window.location.href='codigoqr.html'">
                <i class="fas fa-qrcode"></i>
                <span>Lector QR</span>
            </li>
            <li class="nav-item " onclick="window.location.href='notificaciones.html'">
              <i class="fas fa-bell"></i>
              <span>Notificaciones</span>
          </li>
            <li class="nav-item active" onclick="window.location.href='configuracion.html'">
                <i class="fas fa-cog"></i>
                <span>Configuración</span>
            </li>
            <li class="nav-item" onclick="cerrarSesion()" style="margin-top: 50px; color: #e74c3c;">
                <i class="fas fa-sign-out-alt"></i>
                <span>Cerrar Sesión</span>
            </li>
        </ul>
    </div>

    <!-- Contenido Principal -->
    <div class="main-content">
        <!-- Cabecera -->
        <div class="header">
            <h1 class="page-title">Configuración</h1>
            <div class="user-profile" id="userProfileDropdown">
                <div class="avatar" id="userAvatar">A</div>
                <div class="user-info">
                    <span class="name" id="userName">Administrador</span>
                    <span class="role" id="userRole">Admin</span>
                </div>
            </div>
        </div>

        <!-- Pestañas -->
        <div class="tabs">
            <div class="tab active" data-tab="profile">Perfil de Administrador</div>
            <div class="tab" data-tab="residents">Gestión de Residentes</div>
            <div class="tab" data-tab="complaints">Gestión de Reclamos</div>
            <div class="tab" data-tab="system">Configuración del Sistema</div>
        </div>

        <!-- Contenido de Perfil -->
        <div class="tab-content active" id="profile-tab">
            <div class="card">
                <div class="card-header">
                    Perfil de Administrador
                    <button class="btn btn-primary" id="saveProfileBtn">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
                <div class="card-body">
                    <div class="profile-section">
                        <div class="profile-image">
                            <div class="profile-avatar" id="profileAvatarPreview">A</div>
                            <label for="profilePictureInput" class="btn btn-light upload-btn">
                                <i class="fas fa-upload"></i> Cambiar foto
                            </label>
                            <input type="file" id="profilePictureInput" accept="image/*" style="display: none;" />
                        </div>
                        <div class="profile-details">
                            <form id="profileForm">
                                <div class="form-group">
                                    <label for="adminName"><i class="fas fa-user"></i> Nombre completo</label>
                                    <input type="text" id="adminName" class="form-input" placeholder="Nombre del administrador" required value="Administrador">
                                </div>
                                
                                <div class="form-group">
                                    <label for="adminEmail"><i class="fas fa-envelope"></i> Correo electrónico</label>
                                    <input type="email" id="adminEmail" class="form-input" placeholder="Email del administrador" required value="admin@edificio.com">
                                </div>
                                
                                <div class="form-group">
                                    <label for="adminPhone"><i class="fas fa-phone"></i> Teléfono</label>
                                    <input type="tel" id="adminPhone" class="form-input" placeholder="Teléfono de contacto" value="+56 9 1234 5678">
                                </div> 
                                
                                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e9ecef;">
                                
                                <h3 style="margin-bottom: 15px; color: var(--secondary);">Cambiar Contraseña</h3>
                                
                                <div class="form-group">
                                    <label for="currentPassword"><i class="fas fa-lock"></i> Contraseña actual</label>
                                    <input type="password" id="currentPassword" class="form-input" placeholder="Ingresa tu contraseña actual para confirmar cambios">
                                </div>
                                
                                <div class="form-group">
                                    <label for="newPassword"><i class="fas fa-key"></i> Nueva contraseña (opcional)</label>
                                    <input type="password" id="newPassword" class="form-input" placeholder="Deja en blanco para mantener la actual">
                                </div>
                                
                                <div class="form-group">
                                    <label for="confirmPassword"><i class="fas fa-check"></i> Confirmar nueva contraseña</label>
                                    <input type="password" id="confirmPassword" class="form-input" placeholder="Confirma la nueva contraseña">
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenido de Residentes -->
        <div class="tab-content" id="residents-tab">
            <div class="card">
                <div class="card-header">
                    Gestión de Residentes
                    <button class="btn btn-primary" id="addResidentBtn">
                        <i class="fas fa-user-plus"></i> Añadir Residente
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="data-table" id="residentsTable">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Departamento</th>
                                    <th>Email</th>
                                    <th>Teléfono</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="residentsTableBody">
                                <!-- El contenido se cargará dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenido de Gestión de Reclamos -->
        <div class="tab-content" id="complaints-tab">
            <div class="card">
                <div class="card-header">
                    Gestión de Reclamos
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" id="refreshComplaintsBtn">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Resumen de reclamos -->
                    <div class="complaint-summary">
                        <div class="summary-card">
                            <span class="summary-number" id="totalComplaints">0</span>
                            <span class="summary-label">Total Reclamos</span>
                        </div>
                        <div class="summary-card pending">
                            <span class="summary-number" id="pendingComplaints">0</span>
                            <span class="summary-label">Pendientes</span>
                        </div>
                        <div class="summary-card processing">
                            <span class="summary-number" id="processingComplaints">0</span>
                            <span class="summary-label">En Proceso</span>
                        </div>
                        <div class="summary-card resolved">
                            <span class="summary-number" id="resolvedComplaints">0</span>
                            <span class="summary-label">Resueltos</span>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="complaint-filters">
                        <div class="filter-group">
                            <label for="statusFilter">Estado:</label>
                            <select id="statusFilter" onchange="filterComplaints()">
                                <option value="">Todos</option>
                                <option value="pending">Pendientes</option>
                                <option value="processing">En Proceso</option>
                                <option value="resolved">Resueltos</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="categoryFilter">Categoría:</label>
                            <select id="categoryFilter" onchange="filterComplaints()">
                                <option value="">Todas</option>
                                <option value="maintenance">Mantenimiento</option>
                                <option value="noise">Ruidos</option>
                                <option value="security">Seguridad</option>
                                <option value="services">Servicios</option>
                                <option value="packages">Paquetes</option>
                                <option value="common_areas">Áreas Comunes</option>
                                <option value="other">Otros</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="priorityFilter">Prioridad:</label>
                            <select id="priorityFilter" onchange="filterComplaints()">
                                <option value="">Todas</option>
                                <option value="high">Alta</option>
                                <option value="medium">Media</option>
                                <option value="low">Baja</option>
                            </select>
                        </div>
                    </div>

                    <!-- Tabla de reclamos -->
                    <div class="table-container">
                        <table class="data-table" id="complaintsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Residente</th>
                                    <th>Categoría</th>
                                    <th>Asunto</th>
                                    <th>Prioridad</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="complaintsTableBody">
                                <!-- El contenido se cargará dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenido de configuración del sistema -->
        <div class="tab-content" id="system-tab">
            <div class="card">
                <div class="card-header">
                    Configuración del Sistema
                    <button class="btn btn-primary" id="saveSystemSettingsBtn">
                        <i class="fas fa-save"></i> Guardar Configuración
                    </button>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="buildingName"><i class="fas fa-building"></i> Nombre del Edificio/Condominio</label>
                        <input type="text" id="buildingName" class="form-input" placeholder="Ej: Edificio Las Flores" value="Edificio Las Flores">
                    </div>
                    
                    <div class="form-group">
                        <label for="buildingAddress"><i class="fas fa-map-marker-alt"></i> Dirección</label>
                        <input type="text" id="buildingAddress" class="form-input" placeholder="Dirección completa" value="Av. Principal 123, Santiago">
                    </div>
                    
                    <div class="form-group">
                        <label for="buildingPhone"><i class="fas fa-phone"></i> Teléfono de Conserjería</label>
                        <input type="tel" id="buildingPhone" class="form-input" placeholder="+56 2 2345 6789" value="+56 2 2345 6789">
                    </div>
                    
                    <div class="form-group">
                        <label for="buildingEmail"><i class="fas fa-envelope"></i> Email de Contacto</label>
                        <input type="email" id="buildingEmail" class="form-input" placeholder="admin@edificio.cl" value="admin@edificio.cl">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-envelope"></i> Notificaciones por Email</label>
                        <div style="margin-top: 10px;">
                            <input type="checkbox" id="notifyNewPackage" checked>
                            <label for="notifyNewPackage" style="display: inline;">Notificar cuando llegue un nuevo paquete</label>
                        </div>
                        <div style="margin-top: 10px;">
                            <input type="checkbox" id="notifyPackageDelivery" checked>
                            <label for="notifyPackageDelivery" style="display: inline;">Notificar cuando se entregue un paquete</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="retentionDays"><i class="fas fa-calendar-alt"></i> Días de retención de paquetes</label>
                        <select id="retentionDays" class="form-input">
                            <option value="7">7 días</option>
                            <option value="14" selected>14 días</option>
                            <option value="30">30 días</option>
                            <option value="60">60 días</option>
                        </select>
                        <small style="display: block; margin-top: 5px; color: var(--gray);">Después de este período, se enviará un recordatorio al residente.</small>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-database"></i> Respaldo de Datos</label>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-secondary" id="exportDataBtn">
                                <i class="fas fa-file-export"></i> Exportar Datos
                            </button>
                            <button class="btn btn-light" id="importDataBtn" style="margin-left: 10px;">
                                <i class="fas fa-file-import"></i> Importar Datos
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>

  <!-- Modal para Añadir/Editar Residente -->
  <div id="residentModal" class="modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="residentModalTitle">Añadir Nuevo Residente</h3>
          <button type="button" class="close-button" id="closeResidentModal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <form id="residentForm">
            <input type="hidden" id="residentId">
            
            <div class="form-group">
              <label for="residentFirstName"><i class="fas fa-user"></i> Nombre</label>
              <input type="text" id="residentFirstName" class="form-input" placeholder="Nombre" required>
            </div>
            
            <div class="form-group">
              <label for="residentLastName"><i class="fas fa-user"></i> Apellidos</label>
              <input type="text" id="residentLastName" class="form-input" placeholder="Apellidos" required>
            </div>
            
            <div class="form-group">
              <label for="residentApartment"><i class="fas fa-building"></i> Número de departamento</label>
              <input type="text" id="residentApartment" class="form-input" placeholder="Ej: 101" required>
            </div>
            
            <div class="form-group">
              <label for="residentEmail"><i class="fas fa-envelope"></i> Correo electrónico</label>
              <input type="email" id="residentEmail" class="form-input" placeholder="correo@ejemplo.com" required>
            </div>
            
            <div class="form-group">
              <label for="residentPhone"><i class="fas fa-phone"></i> Teléfono</label>
              <input type="tel" id="residentPhone" class="form-input" placeholder="+56 9 XXXX XXXX">
            </div>
            
            <div class="form-group">
              <label for="residentStatus"><i class="fas fa-toggle-on"></i> Estado</label>
              <select id="residentStatus" class="form-input" required>
                <option value="active">Activo</option>
                <option value="inactive">Inactivo</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="residentPassword"><i class="fas fa-key"></i> Contraseña (opcional)</label>
              <input type="password" id="residentPassword" class="form-input" placeholder="Dejar vacío para generar automáticamente">
              <small style="display: block; margin-top: 5px; color: var(--gray);">Si no se especifica, se generará automáticamente basada en el email y departamento.</small>
            </div>
          </form>
          
          <!-- Mostrar credenciales generadas -->
          <div id="credentialsDisplay" class="credentials-display" style="display: none;">
            <div class="credentials-title">
              <i class="fas fa-key"></i>
              Credenciales de Acceso Generadas
            </div>
            <div class="credential-item">
              <span class="credential-label">Usuario/Email:</span>
              <span class="credential-value" id="generatedUsername">-</span>
            </div>
            <div class="credential-item">
              <span class="credential-label">Contraseña:</span>
              <span class="credential-value" id="generatedPassword">-</span>
            </div>
            <div class="credential-item">
              <span class="credential-label">Panel de Acceso:</span>
              <span class="credential-value">/resident/dashboard_resident.html</span>
            </div>
            <small style="color: var(--warning); margin-top: 10px; display: block;">
              <i class="fas fa-exclamation-triangle"></i>
              Asegúrate de comunicar estas credenciales al residente de forma segura.
            </small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" id="cancelResidentBtn">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button type="button" class="btn btn-primary" id="saveResidentBtn">
            <i class="fas fa-save"></i> Guardar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para mostrar credenciales de login -->
  <div id="loginCredentialsModal" class="modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Credenciales de Acceso</h3>
          <button type="button" class="close-button" onclick="closeLoginCredentialsModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="credentials-display">
            <div class="credentials-title">
              <i class="fas fa-user-lock"></i>
              Datos para Acceso al Panel de Residente
            </div>
            <div class="credential-item">
              <span class="credential-label">Nombre:</span>
              <span class="credential-value" id="loginModalName">-</span>
            </div>
            <div class="credential-item">
              <span class="credential-label">Departamento:</span>
              <span class="credential-value" id="loginModalDepartment">-</span>
            </div>
            <div class="credential-item">
              <span class="credential-label">Usuario/Email:</span>
              <span class="credential-value" id="loginModalUsername">-</span>
            </div>
            <div class="credential-item">
              <span class="credential-label">Contraseña:</span>
              <span class="credential-value" id="loginModalPassword">-</span>
            </div>
            <div class="credential-item">
              <span class="credential-label">URL de Acceso:</span>
              <span class="credential-value">
                <a href="/resident/dashboard_resident.html" target="_blank" style="color: var(--primary);">
                  /resident/dashboard_resident.html
                </a>
              </span>
            </div>
          </div>
          <div style="margin-top: 15px; padding: 10px; background-color: #e8f5e8; border-radius: 5px; border-left: 4px solid var(--success);">
            <strong>Instrucciones:</strong>
            <ul style="margin: 5px 0 0 20px; color: var(--secondary);">
              <li>El residente debe usar estas credenciales para ingresar</li>
              <li>Puede cambiar su contraseña desde su panel</li>
              <li>El usuario siempre será su email registrado</li>
            </ul>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="testResidentLogin()">
            <i class="fas fa-sign-in-alt"></i> Probar Login
          </button>
          <button type="button" class="btn btn-primary" onclick="closeLoginCredentialsModal()">
            <i class="fas fa-check"></i> Entendido
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Ver/Responder Reclamo -->
  <div id="complaintModal" class="modal">
    <div class="modal-dialog large">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="complaintModalTitle">Detalle del Reclamo</h3>
          <button type="button" class="close-button" onclick="closeComplaintModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="complaint-details">
            <div class="complaint-meta">
              <div class="meta-item">
                <i class="fas fa-hashtag"></i>
                <span><strong>ID:</strong> <span id="modalComplaintId">-</span></span>
              </div>
              <div class="meta-item">
                <i class="fas fa-user"></i>
                <span><strong>Residente:</strong> <span id="modalComplaintResident">-</span></span>
              </div>
              <div class="meta-item">
                <i class="fas fa-building"></i>
                <span><strong>Departamento:</strong> <span id="modalComplaintDepartment">-</span></span>
              </div>
              <div class="meta-item">
                <i class="fas fa-calendar"></i>
                <span><strong>Fecha:</strong> <span id="modalComplaintDate">-</span></span>
              </div>
              <div class="meta-item">
                <i class="fas fa-tag"></i>
                <span><strong>Categoría:</strong> <span id="modalComplaintCategory">-</span></span>
              </div>
              <div class="meta-item">
                <i class="fas fa-exclamation-triangle"></i>
                <span><strong>Prioridad:</strong> <span id="modalComplaintPriority">-</span></span>
              </div>
            </div>
            
            <div class="form-group">
              <label><strong>Asunto:</strong></label>
              <div id="modalComplaintSubject" style="padding: 10px; background-color: white; border-radius: 5px; border: 1px solid #e9ecef;">-</div>
            </div>
            
            <div class="form-group">
              <label><strong>Descripción:</strong></label>
              <div class="complaint-description" id="modalComplaintDescription">-</div>
            </div>
            
            <div class="form-group">
              <label for="modalComplaintStatus"><strong>Estado:</strong></label>
              <select id="modalComplaintStatus" class="form-input">
                <option value="pending">Pendiente</option>
                <option value="processing">En Proceso</option>
                <option value="resolved">Resuelto</option>
              </select>
            </div>
          </div>

          <div class="response-section">
            <h4 style="margin-bottom: 15px; color: var(--secondary);">
              <i class="fas fa-comments"></i> Historial de Respuestas
            </h4>
            
            <div class="response-history" id="responseHistory">
              <!-- Las respuestas se cargarán dinámicamente -->
            </div>
            
            <div class="form-group">
              <label for="newResponse"><strong>Nueva Respuesta:</strong></label>
              <textarea id="newResponse" class="form-input" rows="4" placeholder="Escribe tu respuesta aquí..."></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" onclick="closeComplaintModal()">
            <i class="fas fa-times"></i> Cerrar
          </button>
          <button type="button" class="btn btn-primary" onclick="saveComplaintResponse()">
            <i class="fas fa-reply"></i> Responder
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast notifications -->
  <div id="toastSuccess" class="toast toast-success">
    <div class="toast-icon">
      <i class="fas fa-check-circle"></i>
    </div>
    <div class="toast-message">Cambios guardados correctamente</div>
  </div>

  <div id="toastError" class="toast toast-error">
    <div class="toast-icon">
      <i class="fas fa-exclamation-circle"></i>
    </div>
    <div class="toast-message" id="errorMessage">Ha ocurrido un error.</div>
  </div>

  <script>
    // Variables globales
    let residents = [];
    let complaints = [];
    let currentComplaint = null;
    
    // Verificar autenticación al cargar la página
    function checkAuth() {
      const token = localStorage.getItem('authToken');
      if (!token) {
        window.location.href = 'login.html';
        return false;
      }
      return true;
    }
    
    // Función para cerrar sesión
    function cerrarSesion() {
      localStorage.removeItem('authToken');
      window.location.href = 'login.html';
    }

    // Función para cambiar entre pestañas
    function setupTabs() {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Cambiar la pestaña activa
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // Mostrar el contenido correspondiente
          const tabContents = document.querySelectorAll('.tab-content');
          tabContents.forEach(content => content.classList.remove('active'));
          
          const tabId = tab.getAttribute('data-tab');
          document.getElementById(`${tabId}-tab`).classList.add('active');
          
          // Si es la pestaña de reclamos, cargar datos
          if (tabId === 'complaints') {
            loadComplaints();
          }
        });
      });
    }
    
    // Función para mostrar mensajes toast
    function showToast(type, message) {
      const toastElement = type === 'success' ? document.getElementById('toastSuccess') : document.getElementById('toastError');
      
      if (toastElement) {
        if (type === 'error' && document.getElementById('errorMessage')) {
          document.getElementById('errorMessage').textContent = message;
        } else if (type === 'success' && toastElement.querySelector('.toast-message')) {
          toastElement.querySelector('.toast-message').textContent = message;
        }
        
        toastElement.classList.add('show');
        
        setTimeout(() => {
          toastElement.classList.remove('show');
        }, 3000);
      }
    }
    
    // Función para guardar el perfil
    function saveProfile() {
      const name = document.getElementById('adminName').value.trim();
      const email = document.getElementById('adminEmail').value.trim();
      const phone = document.getElementById('adminPhone').value.trim();
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      if (!name || !email) {
        showToast('error', 'Por favor, completa los campos obligatorios');
        return;
      }
      
      if (!currentPassword) {
        showToast('error', 'Debes ingresar tu contraseña actual para confirmar los cambios');
        return;
      }
      
      // Validar contraseñas si se quiere cambiar
      if (newPassword) {
        if (newPassword !== confirmPassword) {
          showToast('error', 'Las contraseñas no coinciden');
          return;
        }
        
        if (newPassword.length < 6) {
          showToast('error', 'La nueva contraseña debe tener al menos 6 caracteres');
          return;
        }
      }
      
      // Obtener usuario actual
      try {
        const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
        
        // Actualizar datos del usuario
        currentUser.username = name;
        currentUser.email = email;
        currentUser.phone = phone;
        
        // Guardar en localStorage
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        // Actualizar interfaz
        document.getElementById('userName').textContent = name;
        document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
        document.getElementById('profileAvatarPreview').textContent = name.charAt(0).toUpperCase();
        
        // Limpiar campos sensibles
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        
        showToast('success', 'Perfil actualizado correctamente');
      } catch (error) {
        console.error('Error al guardar perfil:', error);
        showToast('error', 'Error al guardar el perfil');
      }
    }
    
    // Funciones para manejar la imagen de perfil
    function setupProfilePicture() {
      const profilePictureInput = document.getElementById('profilePictureInput');
      
      profilePictureInput.addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
          const reader = new FileReader();
          
          reader.onload = function(e) {
            // Guardar en localStorage (convertido a string)
            localStorage.setItem('profilePicture', e.target.result);
            
            // Actualizar la vista previa
            const profileAvatar = document.getElementById('profileAvatarPreview');
            profileAvatar.innerHTML = '';
            profileAvatar.style.backgroundImage = `url(${e.target.result})`;
            profileAvatar.style.backgroundSize = 'cover';
            profileAvatar.style.backgroundPosition = 'center';
            
            // Actualizar avatar en el header también
            const userAvatar = document.getElementById('userAvatar');
            userAvatar.innerHTML = '';
            userAvatar.style.backgroundImage = `url(${e.target.result})`;
            userAvatar.style.backgroundSize = 'cover';
            userAvatar.style.backgroundPosition = 'center';
            
            showToast('success', 'Imagen de perfil actualizada');
          };
          
          reader.readAsDataURL(e.target.files[0]);
        }
      });
      
      // Verificar si ya hay una imagen guardada
      const savedPicture = localStorage.getItem('profilePicture');
      if (savedPicture) {
        const profileAvatar = document.getElementById('profileAvatarPreview');
        profileAvatar.innerHTML = '';
        profileAvatar.style.backgroundImage = `url(${savedPicture})`;
        profileAvatar.style.backgroundSize = 'cover';
        profileAvatar.style.backgroundPosition = 'center';
        
        const userAvatar = document.getElementById('userAvatar');
        userAvatar.innerHTML = '';
        userAvatar.style.backgroundImage = `url(${savedPicture})`;
        userAvatar.style.backgroundSize = 'cover';
        userAvatar.style.backgroundPosition = 'center';
      }
    }
    
    // Función para cargar los datos del usuario al iniciar
    function loadUserData() {
      try {
        const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
        
        if (currentUser.username) {
          document.getElementById('adminName').value = currentUser.username;
          document.getElementById('userName').textContent = currentUser.username;
          document.getElementById('userAvatar').textContent = currentUser.username.charAt(0).toUpperCase();
          document.getElementById('profileAvatarPreview').textContent = currentUser.username.charAt(0).toUpperCase();
        }
        
        if (currentUser.email) {
          document.getElementById('adminEmail').value = currentUser.email;
        }
        
        if (currentUser.phone) {
          document.getElementById('adminPhone').value = currentUser.phone;
        }
        
        if (currentUser.role) {
          document.getElementById('userRole').textContent = currentUser.role === 'admin' ? 'Administrador' : 'Usuario';
        }
      } catch (error) {
        console.error('Error al cargar datos del usuario:', error);
      }
    }
    
    // ======= FUNCIONALIDAD DE GESTIÓN DE RESIDENTES =======
    
    // Función para generar un ID único
    function generateUniqueId() {
      return Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
    }
    
    // Función para generar contraseña automática
    function generatePassword(email, apartment) {
      // Usar primera parte del email + número de departamento
      const emailPart = email.split('@')[0].toLowerCase();
      return emailPart + apartment;
    }
    
    // Función para actualizar la lista de usuarios para login
    function updateUsersList(residentsArray) {
      try {
        // Crear lista de usuarios para el sistema de login
        const users = residentsArray.map(resident => ({
          id: resident.id,
          username: resident.email, // Email como username
          email: resident.email,
          password: resident.password || btoa(generatePassword(resident.email, resident.apartment)), // Encriptar en base64
          role: 'resident',
          name: resident.name.split(' ')[0] || resident.name, // Primer nombre
          lastname: resident.name.split(' ').slice(1).join(' ') || '', // Resto como apellidos
          department: resident.apartment,
          phone: resident.phone,
          active: resident.status === 'active'
        }));
        
        // Guardar en localStorage para el sistema de login
        localStorage.setItem('users', JSON.stringify(users));
        
        console.log('Lista de usuarios actualizada:', users);
      } catch (error) {
        console.error('Error al actualizar lista de usuarios:', error);
      }
    }
    
    // Función para inicializar datos de configuración del edificio
    function initializeBuildingConfig() {
      try {
        const existingConfig = localStorage.getItem('edificioConfig');
        if (!existingConfig) {
          const defaultConfig = {
            nombreEdificio: 'Edificio Las Flores',
            direccion: 'Av. Principal 123, Santiago',
            telefono: '+56 2 2345 6789',
            email: 'admin@edificio.cl',
            horarioAtencion: 'Lunes a Viernes: 9:00 - 18:00'
          };
          localStorage.setItem('edificioConfig', JSON.stringify(defaultConfig));
        }
      } catch (error) {
        console.error('Error al inicializar configuración del edificio:', error);
      }
    }
    
    // Función para cargar residentes desde localStorage
    function loadResidents() {
      try {
        // Intentar cargar desde localStorage
        const savedResidents = localStorage.getItem('residents');
        if (savedResidents) {
          residents = JSON.parse(savedResidents);
        } else {
          // Datos de ejemplo si no hay datos guardados
          residents = [
            {
              id: generateUniqueId(),
              name: 'Juan Pérez',
              apartment: '101',
              email: 'juan.perez@example.com',
              phone: '+56 9 8765 4321',
              status: 'active',
              password: btoa(generatePassword('juan.perez@example.com', '101'))
            },
            {
              id: generateUniqueId(),
              name: 'María González',
              apartment: '202',
              email: 'maria.gonzalez@example.com',
              phone: '+56 9 1122 3344',
              status: 'active',
              password: btoa(generatePassword('maria.gonzalez@example.com', '202'))
            }
          ];
          // Guardar los datos de ejemplo
          saveResidentsToStorage();
        }
        
        // Actualizar lista de usuarios para login
        updateUsersList(residents);
        
        // Actualizar la tabla con los datos cargados
        updateResidentsTable();
      } catch (error) {
        console.error('Error al cargar residentes:', error);
        showToast('error', 'Error al cargar la lista de residentes');
      }
    }
    
    // Función para guardar residentes en localStorage
    function saveResidentsToStorage() {
      try {
        localStorage.setItem('residents', JSON.stringify(residents));
        // También actualizar lista de usuarios para login
        updateUsersList(residents);
      } catch (error) {
        console.error('Error al guardar residentes:', error);
        showToast('error', 'Error al guardar los cambios');
      }
    }
    
    // Función para actualizar la tabla de residentes
    function updateResidentsTable() {
      const tableBody = document.getElementById('residentsTableBody');
      if (!tableBody) return;
      
      // Limpiar tabla
      tableBody.innerHTML = '';
      
      // Si no hay residentes, mostrar mensaje
      if (residents.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="6" style="text-align: center; padding: 30px;">
            <i class="fas fa-users" style="font-size: 3rem; color: #ddd; margin-bottom: 10px; display: block;"></i>
            <p>No hay residentes registrados</p>
          </td>
        `;
        tableBody.appendChild(row);
        return;
      }
      
      // Agregar residentes a la tabla
      residents.forEach(resident => {
        const row = document.createElement('tr');
        row.dataset.id = resident.id;
        
        row.innerHTML = `
          <td>${resident.name}</td>
          <td>${resident.apartment}</td>
          <td>${resident.email}</td>
          <td>${resident.phone || '-'}</td>
          <td><span class="badge badge-${resident.status === 'active' ? 'primary' : 'danger'}">${resident.status === 'active' ? 'Activo' : 'Inactivo'}</span></td>
          <td class="action-buttons">
            <button class="btn-icon btn-login" data-id="${resident.id}" title="Ver credenciales de login">
              <i class="fas fa-sign-in-alt"></i>
            </button>
            <button class="btn-icon btn-view" data-id="${resident.id}" title="Ver detalles">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn-icon btn-edit" data-id="${resident.id}" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-icon btn-delete" data-id="${resident.id}" title="Eliminar">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Configurar eventos para los botones
      setupTableActions();
    }
    
    // Función para configurar eventos de los botones de la tabla
    function setupTableActions() {
      // Configurar botones de login
      document.querySelectorAll('.btn-login').forEach(btn => {
        btn.addEventListener('click', function() {
          const residentId = this.getAttribute('data-id');
          showLoginCredentials(residentId);
        });
      });
      
      // Configurar botones de ver
      document.querySelectorAll('.btn-view').forEach(btn => {
        btn.addEventListener('click', function() {
          const residentId = this.getAttribute('data-id');
          viewResident(residentId);
        });
      });
      
      // Configurar botones de editar
      document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', function() {
          const residentId = this.getAttribute('data-id');
          editResident(residentId);
        });
      });
      
      // Configurar botones de eliminar
      document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', function() {
          const residentId = this.getAttribute('data-id');
          deleteResident(residentId);
        });
      });
    }
    
    // Función para mostrar credenciales de login
    function showLoginCredentials(residentId) {
      const resident = residents.find(r => r.id === residentId);
      if (!resident) {
        showToast('error', 'No se encontró el residente');
        return;
      }
      
      // Decodificar contraseña
      const password = resident.password ? atob(resident.password) : generatePassword(resident.email, resident.apartment);
      
      // Rellenar modal con credenciales
      document.getElementById('loginModalName').textContent = resident.name;
      document.getElementById('loginModalDepartment').textContent = resident.apartment;
      document.getElementById('loginModalUsername').textContent = resident.email;
      document.getElementById('loginModalPassword').textContent = password;
      
      // Mostrar modal
      document.getElementById('loginCredentialsModal').classList.add('show');
    }
    
    // Función para cerrar modal de credenciales
    function closeLoginCredentialsModal() {
      document.getElementById('loginCredentialsModal').classList.remove('show');
    }
    
    // Función para probar login del residente
    function testResidentLogin() {
      const username = document.getElementById('loginModalUsername').textContent;
      const password = document.getElementById('loginModalPassword').textContent;
      
      // Simular login automático
      // Esto normalmente se haría en login.html, pero lo simulamos aquí para pruebas
      const resident = residents.find(r => r.email === username);
      if (resident) {
        // Establecer datos de autenticación para el residente
        localStorage.setItem('authToken', 'resident-token-' + Date.now());
        localStorage.setItem('userType', 'resident');
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('userName', resident.name);
        localStorage.setItem('currentResident', JSON.stringify({
          id: resident.id,
          name: resident.name.split(' ')[0],
          lastname: resident.name.split(' ').slice(1).join(' ') || '',
          email: resident.email,
          phone: resident.phone,
          department: resident.apartment
        }));
        
        // Abrir panel de residente en nueva pestaña
        window.open('/resident/dashboard_resident.html', '_blank');
        
        showToast('success', 'Abriendo panel de residente...');
        closeLoginCredentialsModal();
      } else {
        showToast('error', 'Error al realizar login de prueba');
      }
    }
    
    // Función para ver detalles de un residente
    function viewResident(residentId) {
      const resident = residents.find(r => r.id === residentId);
      if (!resident) {
        showToast('error', 'No se encontró el residente');
        return;
      }
      
      // Mostrar detalles del residente en una alerta
      alert(`
        Detalles del Residente:
        
        Nombre: ${resident.name}
        Departamento: ${resident.apartment}
        Email: ${resident.email}
        Teléfono: ${resident.phone || 'No especificado'}
        Estado: ${resident.status === 'active' ? 'Activo' : 'Inactivo'}
        Usuario: ${resident.email}
        Acceso: Panel de Residente (/resident/dashboard_resident.html)
      `);
    }
    
    // Función para abrir modal para editar residente
    function editResident(residentId) {
      const resident = residents.find(r => r.id === residentId);
      if (!resident) {
        showToast('error', 'No se encontró el residente');
        return;
      }
      
      // Separar nombre y apellidos
      const nameParts = resident.name.split(' ');
      const firstName = nameParts[0] || '';
      const lastName = nameParts.slice(1).join(' ') || '';
      
      // Rellenar el formulario con los datos
      document.getElementById('residentId').value = resident.id;
      document.getElementById('residentFirstName').value = firstName;
      document.getElementById('residentLastName').value = lastName;
      document.getElementById('residentApartment').value = resident.apartment;
      document.getElementById('residentEmail').value = resident.email;
      document.getElementById('residentPhone').value = resident.phone || '';
      document.getElementById('residentStatus').value = resident.status;
      document.getElementById('residentPassword').value = ''; // No mostrar contraseña actual
      
      // Cambiar título del modal
      document.getElementById('residentModalTitle').textContent = 'Editar Residente';
      
      // Ocultar credenciales generadas
      document.getElementById('credentialsDisplay').style.display = 'none';
      
      // Mostrar modal
      openResidentModal();
    }
    
    // Función para eliminar un residente
    function deleteResident(residentId) {
      const resident = residents.find(r => r.id === residentId);
      if (!resident) {
        showToast('error', 'No se encontró el residente');
        return;
      }
      
      // Pedir confirmación
      const confirmDelete = confirm(`¿Está seguro que desea eliminar al residente ${resident.name}?\n\nEsto también eliminará su acceso al panel de residente.`);
      if (!confirmDelete) return;
      
      // Eliminar residente
      residents = residents.filter(r => r.id !== residentId);
      
      // Guardar cambios
      saveResidentsToStorage();
      
      // Actualizar tabla
      updateResidentsTable();
      
      // Mostrar mensaje
      showToast('success', 'Residente eliminado correctamente');
    }
    
    // Función para abrir modal para añadir un nuevo residente
    function openAddResidentModal() {
      // Limpiar formulario
      document.getElementById('residentForm').reset();
      document.getElementById('residentId').value = '';
      
      // Cambiar título
      document.getElementById('residentModalTitle').textContent = 'Añadir Nuevo Residente';
      
      // Ocultar credenciales generadas
      document.getElementById('credentialsDisplay').style.display = 'none';
      
      // Mostrar modal
      openResidentModal();
    }
    
    // Función para abrir el modal
    function openResidentModal() {
      document.getElementById('residentModal').classList.add('show');
    }
    
    // Función para cerrar el modal
    function closeResidentModal() {
      document.getElementById('residentModal').classList.remove('show');
    }
    
    // Función principal para guardar residente
    function saveResident() {
      // Obtener datos del formulario
      const id = document.getElementById('residentId').value;
      const firstName = document.getElementById('residentFirstName').value.trim();
      const lastName = document.getElementById('residentLastName').value.trim();
      const apartment = document.getElementById('residentApartment').value.trim();
      const email = document.getElementById('residentEmail').value.trim();
      const phone = document.getElementById('residentPhone').value.trim();
      const status = document.getElementById('residentStatus').value;
      const customPassword = document.getElementById('residentPassword').value.trim();
      
      // Validar campos obligatorios
      if (!firstName || !apartment || !email) {
        showToast('error', 'Por favor, completa los campos obligatorios (Nombre, Departamento, Email)');
        return;
      }
      
      // Validar formato de email
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showToast('error', 'Por favor, ingresa un email válido');
        return;
      }
      
      // Verificar si el email ya existe (solo para nuevos residentes o si cambió el email)
      const existingResident = residents.find(r => r.email === email && r.id !== id);
      if (existingResident) {
        showToast('error', 'Ya existe un residente con este email');
        return;
      }
      
      // Verificar si el departamento ya existe (solo para nuevos residentes o si cambió el departamento)
      const existingApartment = residents.find(r => r.apartment === apartment && r.id !== id);
      if (existingApartment) {
        showToast('error', 'Ya existe un residente en este departamento');
        return;
      }
      
      // Generar contraseña
      const password = customPassword || generatePassword(email, apartment);
      const fullName = lastName ? `${firstName} ${lastName}` : firstName;
      
      // Crear objeto residente
      const resident = {
        id: id || generateUniqueId(),
        name: fullName,
        apartment,
        email,
        phone,
        status,
        password: btoa(password), // Encriptar contraseña en base64
        created_at: new Date().toISOString()
      };
      
      // Verificar si es edición o nuevo
      if (id) {
        // Edición: actualizar residente existente
        const index = residents.findIndex(r => r.id === id);
        if (index !== -1) {
          // Preservar contraseña existente si no se especificó una nueva
          if (!customPassword) {
            resident.password = residents[index].password;
          }
          residents[index] = resident;
          showToast('success', 'Residente actualizado correctamente');
        } else {
          showToast('error', 'No se encontró el residente a editar');
          return;
        }
      } else {
        // Nuevo: agregar a la lista
        residents.push(resident);
        
        // Mostrar credenciales generadas
        showGeneratedCredentials(email, password);
        
        // Verificar si es necesario crear o actualizar el departamento
        updateDepartmentList(apartment);
        
        showToast('success', 'Residente añadido correctamente. Revisa las credenciales generadas.');
      }
      
      // Guardar cambios en residentes
      saveResidentsToStorage();
      
      // Actualizar tabla
      updateResidentsTable();
      
      // No cerrar modal automáticamente para nuevos residentes (para que vean las credenciales)
      if (id) {
        closeResidentModal();
      }
    }
    
    // Función para mostrar credenciales generadas
    function showGeneratedCredentials(email, password) {
      document.getElementById('generatedUsername').textContent = email;
      document.getElementById('generatedPassword').textContent = password;
      document.getElementById('credentialsDisplay').style.display = 'block';
    }
    
    // Función para actualizar la lista de departamentos
    function updateDepartmentList(apartmentNumber) {
      try {
        // Obtener departamentos existentes
        const departments = JSON.parse(localStorage.getItem('departments')) || [];
        
        // Verificar si ya existe el departamento
        if (!departments.includes(apartmentNumber)) {
          departments.push(apartmentNumber);
          departments.sort(); // Ordenar alfabéticamente
          localStorage.setItem('departments', JSON.stringify(departments));
          console.log(`Departamento ${apartmentNumber} añadido automáticamente`);
        }
      } catch (error) {
        console.error('Error al actualizar lista de departamentos:', error);
      }
    }

    // ======= FUNCIONALIDAD DE GESTIÓN DE RECLAMOS =======

    // Función para inicializar reclamos con datos de ejemplo
    function initializeComplaints() {
      const savedComplaints = localStorage.getItem('complaints');
      if (!savedComplaints) {
        complaints = [
          {
            id: 'REC001',
            residentId: residents.length > 0 ? residents[0].id : 'temp1',
            residentName: residents.length > 0 ? residents[0].name : 'Juan Pérez',
            department: residents.length > 0 ? residents[0].apartment : '101',
            category: 'maintenance',
            subject: 'Goteras en el baño',
            description: 'Hay goteras en el techo del baño que están ocasionando problemas de humedad. El problema se presenta principalmente durante las lluvias.',
            priority: 'high',
            status: 'pending',
            createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(), // Hace 2 días
            responses: [
              {
                id: 'resp1',
                author: 'Residente',
                message: 'El problema se ha agravado desde ayer. Por favor, necesito una solución urgente.',
                timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString()
              }
            ]
          },
          {
            id: 'REC002',
            residentId: residents.length > 1 ? residents[1].id : 'temp2',
            residentName: residents.length > 1 ? residents[1].name : 'María González',
            department: residents.length > 1 ? residents[1].apartment : '202',
            category: 'noise',
            subject: 'Ruidos molestos en horas de descanso',
            description: 'El departamento de arriba hace ruidos excesivos durante las noches, especialmente después de las 22:00 hrs.',
            priority: 'medium',
            status: 'processing',
            createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(), // Hace 5 días
            responses: [
              {
                id: 'resp2',
                author: 'Administración',
                message: 'Hemos contactado a los residentes del departamento superior para conversar sobre el tema.',
                timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString()
              },
              {
                id: 'resp3',
                author: 'Residente',
                message: 'Gracias por la gestión. Esperaré a ver si mejora la situación.',
                timestamp: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString()
              }
            ]
          },
          {
            id: 'REC003',
            residentId: residents.length > 0 ? residents[0].id : 'temp1',
            residentName: residents.length > 0 ? residents[0].name : 'Juan Pérez',
            department: residents.length > 0 ? residents[0].apartment : '101',
            category: 'security',
            subject: 'Problema con cerradura principal',
            description: 'La cerradura del acceso principal del edificio no está funcionando correctamente con mi llave.',
            priority: 'low',
            status: 'resolved',
            createdAt: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(), // Hace 10 días
            responses: [
              {
                id: 'resp4',
                author: 'Administración',
                message: 'Hemos solicitado al cerrajero que revise y ajuste la cerradura.',
                timestamp: new Date(Date.now() - 8 * 24 * 60 * 60 * 1000).toISOString()
              },
              {
                id: 'resp5',
                author: 'Administración',
                message: 'Problema resuelto. La cerradura ha sido reparada y todas las llaves funcionan correctamente.',
                timestamp: new Date(Date.now() - 6 * 24 * 60 * 60 * 1000).toISOString()
              }
            ]
          }
        ];
        localStorage.setItem('complaints', JSON.stringify(complaints));
      } else {
        complaints = JSON.parse(savedComplaints);
      }
    }

    // Función para cargar reclamos
    function loadComplaints() {
      initializeComplaints();
      updateComplaintsSummary();
      updateComplaintsTable();
    }

    // Función para actualizar el resumen de reclamos
    function updateComplaintsSummary() {
      const total = complaints.length;
      const pending = complaints.filter(c => c.status === 'pending').length;
      const processing = complaints.filter(c => c.status === 'processing').length;
      const resolved = complaints.filter(c => c.status === 'resolved').length;

      document.getElementById('totalComplaints').textContent = total;
      document.getElementById('pendingComplaints').textContent = pending;
      document.getElementById('processingComplaints').textContent = processing;
      document.getElementById('resolvedComplaints').textContent = resolved;
    }

    // Función para obtener el nombre de la categoría
    function getCategoryName(category) {
      const categories = {
        'maintenance': 'Mantenimiento',
        'noise': 'Ruidos',
        'security': 'Seguridad',
        'services': 'Servicios',
        'packages': 'Paquetes',
        'common_areas': 'Áreas Comunes',
        'other': 'Otros'
      };
      return categories[category] || category;
    }

    // Función para obtener el nombre del estado
    function getStatusName(status) {
      const statuses = {
        'pending': 'Pendiente',
        'processing': 'En Proceso',
        'resolved': 'Resuelto'
      };
      return statuses[status] || status;
    }

    // Función para obtener el nombre de la prioridad
    function getPriorityName(priority) {
      const priorities = {
        'high': 'Alta',
        'medium': 'Media',
        'low': 'Baja'
      };
      return priorities[priority] || priority;
    }

    // Función para actualizar la tabla de reclamos
    function updateComplaintsTable() {
      const tableBody = document.getElementById('complaintsTableBody');
      if (!tableBody) return;

      // Limpiar tabla
      tableBody.innerHTML = '';

      // Obtener filtros activos
      const statusFilter = document.getElementById('statusFilter').value;
      const categoryFilter = document.getElementById('categoryFilter').value;
      const priorityFilter = document.getElementById('priorityFilter').value;

      // Filtrar reclamos
      let filteredComplaints = complaints.filter(complaint => {
        return (!statusFilter || complaint.status === statusFilter) &&
               (!categoryFilter || complaint.category === categoryFilter) &&
               (!priorityFilter || complaint.priority === priorityFilter);
      });

      // Si no hay reclamos, mostrar mensaje
      if (filteredComplaints.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="8" style="text-align: center; padding: 30px;">
            <i class="fas fa-comments" style="font-size: 3rem; color: #ddd; margin-bottom: 10px; display: block;"></i>
            <p>No hay reclamos que coincidan con los filtros seleccionados</p>
          </td>
        `;
        tableBody.appendChild(row);
        return;
      }

      // Agregar reclamos a la tabla
      filteredComplaints.forEach(complaint => {
        const row = document.createElement('tr');
        row.dataset.id = complaint.id;

        const date = new Date(complaint.createdAt).toLocaleDateString('es-CL');
        const statusBadge = `badge-${complaint.status === 'pending' ? 'warning' : complaint.status === 'processing' ? 'info' : 'primary'}`;
        const priorityClass = `priority-${complaint.priority}`;

        row.innerHTML = `
          <td>${complaint.id}</td>
          <td>${complaint.residentName}<br><small style="color: #666;">Depto. ${complaint.department}</small></td>
          <td>${getCategoryName(complaint.category)}</td>
          <td>${complaint.subject}</td>
          <td><span class="${priorityClass}">${getPriorityName(complaint.priority)}</span></td>
          <td><span class="badge ${statusBadge}">${getStatusName(complaint.status)}</span></td>
          <td>${date}</td>
          <td class="action-buttons">
            <button class="btn-icon btn-view" onclick="viewComplaint('${complaint.id}')" title="Ver detalles">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn-icon btn-edit" onclick="respondToComplaint('${complaint.id}')" title="Responder">
              <i class="fas fa-reply"></i>
            </button>
          </td>
        `;

        tableBody.appendChild(row);
      });
    }

    // Función para filtrar reclamos
    function filterComplaints() {
      updateComplaintsTable();
    }

    // Función para ver detalle de un reclamo
    function viewComplaint(complaintId) {
      const complaint = complaints.find(c => c.id === complaintId);
      if (!complaint) {
        showToast('error', 'No se encontró el reclamo');
        return;
      }

      // Mostrar información del reclamo en un alert
      const date = new Date(complaint.createdAt).toLocaleDateString('es-CL');
      alert(`
        Detalle del Reclamo ${complaint.id}:
        
        Residente: ${complaint.residentName} - Depto. ${complaint.department}
        Categoría: ${getCategoryName(complaint.category)}
        Prioridad: ${getPriorityName(complaint.priority)}
        Estado: ${getStatusName(complaint.status)}
        Fecha: ${date}
        
        Asunto: ${complaint.subject}
        
        Descripción: ${complaint.description}
        
        Respuestas: ${complaint.responses.length}
      `);
    }

    // Función para responder a un reclamo
    function respondToComplaint(complaintId) {
      const complaint = complaints.find(c => c.id === complaintId);
      if (!complaint) {
        showToast('error', 'No se encontró el reclamo');
        return;
      }

      currentComplaint = complaint;

      // Llenar datos del modal
      document.getElementById('modalComplaintId').textContent = complaint.id;
      document.getElementById('modalComplaintResident').textContent = complaint.residentName;
      document.getElementById('modalComplaintDepartment').textContent = complaint.department;
      document.getElementById('modalComplaintDate').textContent = new Date(complaint.createdAt).toLocaleDateString('es-CL');
      document.getElementById('modalComplaintCategory').textContent = getCategoryName(complaint.category);
      document.getElementById('modalComplaintPriority').textContent = getPriorityName(complaint.priority);
      document.getElementById('modalComplaintSubject').textContent = complaint.subject;
      document.getElementById('modalComplaintDescription').textContent = complaint.description;
      document.getElementById('modalComplaintStatus').value = complaint.status;

      // Llenar historial de respuestas
      const responseHistory = document.getElementById('responseHistory');
      responseHistory.innerHTML = '';

      if (complaint.responses.length === 0) {
        responseHistory.innerHTML = '<p style="text-align: center; color: #666;">No hay respuestas aún.</p>';
      } else {
        complaint.responses.forEach(response => {
          const responseDiv = document.createElement('div');
          responseDiv.className = 'response-item';
          responseDiv.innerHTML = `
            <div class="response-header">
              <span class="response-author">${response.author}</span>
              <span class="response-date">${new Date(response.timestamp).toLocaleString('es-CL')}</span>
            </div>
            <div>${response.message}</div>
          `;
          responseHistory.appendChild(responseDiv);
        });
      }

      // Limpiar campo de nueva respuesta
      document.getElementById('newResponse').value = '';

      // Mostrar modal
      document.getElementById('complaintModal').classList.add('show');
    }

    // Función para cerrar modal de reclamo
    function closeComplaintModal() {
      document.getElementById('complaintModal').classList.remove('show');
      currentComplaint = null;
    }

    // Función para guardar respuesta del reclamo
    function saveComplaintResponse() {
      if (!currentComplaint) {
        showToast('error', 'No hay reclamo seleccionado');
        return;
      }

      const newResponse = document.getElementById('newResponse').value.trim();
      const newStatus = document.getElementById('modalComplaintStatus').value;

      if (!newResponse && newStatus === currentComplaint.status) {
        showToast('error', 'Debes escribir una respuesta o cambiar el estado');
        return;
      }

      // Actualizar estado si cambió
      if (newStatus !== currentComplaint.status) {
        currentComplaint.status = newStatus;
      }

      // Agregar nueva respuesta si hay texto
      if (newResponse) {
        const response = {
          id: generateUniqueId(),
          author: 'Administración',
          message: newResponse,
          timestamp: new Date().toISOString()
        };
        currentComplaint.responses.push(response);
      }

      // Actualizar fecha de última modificación
      currentComplaint.updatedAt = new Date().toISOString();

      // Guardar en localStorage
      localStorage.setItem('complaints', JSON.stringify(complaints));

      // Actualizar interfaz
      updateComplaintsSummary();
      updateComplaintsTable();

      // Cerrar modal
      closeComplaintModal();

      showToast('success', 'Respuesta enviada correctamente');
    }

    // Función para actualizar reclamos (refrescar)
    function refreshComplaints() {
      loadComplaints();
      showToast('success', 'Reclamos actualizados');
    }
    
    // ======= CONFIGURACIÓN DEL SISTEMA =======
    
    // Función para cargar configuración del sistema
    function loadSystemSettings() {
      try {
        const settings = JSON.parse(localStorage.getItem('systemSettings')) || {};
        const buildingConfig = JSON.parse(localStorage.getItem('edificioConfig')) || {};
        
        // Cargar datos en el formulario desde ambas fuentes
        if (settings.buildingName || buildingConfig.nombreEdificio) {
          document.getElementById('buildingName').value = settings.buildingName || buildingConfig.nombreEdificio;
        }
        
        if (settings.buildingAddress || buildingConfig.direccion) {
          document.getElementById('buildingAddress').value = settings.buildingAddress || buildingConfig.direccion;
        }
        
        if (settings.buildingPhone || buildingConfig.telefono) {
          document.getElementById('buildingPhone').value = settings.buildingPhone || buildingConfig.telefono;
        }
        
        if (settings.buildingEmail || buildingConfig.email) {
          document.getElementById('buildingEmail').value = settings.buildingEmail || buildingConfig.email;
        }
        
        if (settings.notifyNewPackage !== undefined) {
          document.getElementById('notifyNewPackage').checked = settings.notifyNewPackage;
        }
        
        if (settings.notifyPackageDelivery !== undefined) {
          document.getElementById('notifyPackageDelivery').checked = settings.notifyPackageDelivery;
        }
        
        if (settings.retentionDays) {
          document.getElementById('retentionDays').value = settings.retentionDays;
        }
      } catch (error) {
        console.error('Error al cargar configuración del sistema:', error);
      }
    }
    
    // Función para guardar configuración del sistema
    function saveSystemSettings() {
      try {
        const settings = {
          buildingName: document.getElementById('buildingName').value.trim(),
          buildingAddress: document.getElementById('buildingAddress').value.trim(),
          buildingPhone: document.getElementById('buildingPhone').value.trim(),
          buildingEmail: document.getElementById('buildingEmail').value.trim(),
          notifyNewPackage: document.getElementById('notifyNewPackage').checked,
          notifyPackageDelivery: document.getElementById('notifyPackageDelivery').checked,
          retentionDays: document.getElementById('retentionDays').value
        };
        
        // Guardar en localStorage (configuración del sistema)
        localStorage.setItem('systemSettings', JSON.stringify(settings));
        
        // También actualizar configuración del edificio para compatibilidad
        const buildingConfig = {
          nombreEdificio: settings.buildingName,
          direccion: settings.buildingAddress,
          telefono: settings.buildingPhone,
          email: settings.buildingEmail,
          horarioAtencion: 'Lunes a Viernes: 9:00 - 18:00'
        };
        localStorage.setItem('edificioConfig', JSON.stringify(buildingConfig));
        
        showToast('success', 'Configuración guardada correctamente');
      } catch (error) {
        console.error('Error al guardar configuración:', error);
        showToast('error', 'Error al guardar la configuración');
      }
    }
    
    // Función para exportar datos
    function exportData() {
      try {
        // Recopilar todos los datos importantes
        const exportData = {
          residents: residents,
          users: JSON.parse(localStorage.getItem('users')) || [],
          departments: JSON.parse(localStorage.getItem('departments')) || [],
          packages: JSON.parse(localStorage.getItem('paquetesPrueba')) || [],
          complaints: complaints,
          systemSettings: JSON.parse(localStorage.getItem('systemSettings')) || {},
          buildingConfig: JSON.parse(localStorage.getItem('edificioConfig')) || {},
          exportDate: new Date().toISOString(),
          version: '1.0'
        };
        
        // Convertir a cadena JSON
        const jsonData = JSON.stringify(exportData, null, 2);
        
        // Crear un blob con los datos
        const blob = new Blob([jsonData], { type: 'application/json' });
        
        // Crear URL para descargar
        const url = URL.createObjectURL(blob);
        
        // Crear enlace para descargar
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_encomiendas_${new Date().toISOString().split('T')[0]}.json`;
        
        // Simular clic en el enlace para iniciar descarga
        document.body.appendChild(a);
        a.click();
        
        // Limpiar
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('success', 'Datos exportados correctamente');
      } catch (error) {
        console.error('Error al exportar datos:', error);
        showToast('error', 'Error al exportar los datos');
      }
    }
    
    // Función para importar datos
    function importData() {
      // Crear un input de tipo file oculto
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'application/json';
      
      // Agregar evento change
      fileInput.addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
          const file = e.target.files[0];
          const reader = new FileReader();
          
          reader.onload = function(e) {
            try {
              const data = JSON.parse(e.target.result);
              
              // Verificar si tiene la estructura esperada
              if (!data.residents && !data.users) {
                throw new Error('El archivo no tiene el formato correcto');
              }
              
              // Preguntar al usuario si está seguro
              const confirmImport = confirm('¿Está seguro que desea importar estos datos? Se sobrescribirán los datos actuales.');
              if (!confirmImport) return;
              
              // Importar datos
              if (data.residents) {
                localStorage.setItem('residents', JSON.stringify(data.residents));
                residents = data.residents;
              }
              
              if (data.users) {
                localStorage.setItem('users', JSON.stringify(data.users));
              }
              
              if (data.departments) {
                localStorage.setItem('departments', JSON.stringify(data.departments));
              }
              
              if (data.packages) {
                localStorage.setItem('paquetesPrueba', JSON.stringify(data.packages));
              }
              
              if (data.complaints) {
                localStorage.setItem('complaints', JSON.stringify(data.complaints));
                complaints = data.complaints;
              }
              
              if (data.systemSettings) {
                localStorage.setItem('systemSettings', JSON.stringify(data.systemSettings));
              }
              
              if (data.buildingConfig) {
                localStorage.setItem('edificioConfig', JSON.stringify(data.buildingConfig));
              }
              
              // Recargar datos
              updateResidentsTable();
              updateUsersList(residents);
              loadSystemSettings();
              loadComplaints();
              
              showToast('success', 'Datos importados correctamente');
              
              // Sugerir recargar la página
              setTimeout(() => {
                if (confirm('Se recomienda recargar la página para ver todos los cambios. ¿Desea hacerlo ahora?')) {
                  window.location.reload();
                }
              }, 1000);
              
            } catch (error) {
              console.error('Error al procesar el archivo:', error);
              showToast('error', 'Error al importar los datos: ' + error.message);
            }
          };
          
          reader.readAsText(file);
        }
      });
      
      // Simular clic para abrir el diálogo
      document.body.appendChild(fileInput);
      fileInput.click();
      document.body.removeChild(fileInput);
    }
    
    // Inicializar la aplicación
    document.addEventListener('DOMContentLoaded', function() {
      // Verificar autenticación
      if (!checkAuth()) return;
      
      // Inicializar configuración del edificio
      initializeBuildingConfig();
      
      // Configurar pestañas
      setupTabs();
      
      // Cargar datos del usuario
      loadUserData();
      
      // Configurar imagen de perfil
      setupProfilePicture();
      
      // Cargar residentes
      loadResidents();
      
      // Cargar configuración del sistema
      loadSystemSettings();
      
      // Configurar eventos para el perfil
      document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);
      
      // Configurar eventos para residentes
      document.getElementById('addResidentBtn').addEventListener('click', openAddResidentModal);
      document.getElementById('closeResidentModal').addEventListener('click', closeResidentModal);
      document.getElementById('cancelResidentBtn').addEventListener('click', closeResidentModal);
      document.getElementById('saveResidentBtn').addEventListener('click', saveResident);
      
      // Configurar eventos para cerrar modal con clic fuera
      document.getElementById('residentModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeResidentModal();
        }
      });
      
      // Configurar eventos para cerrar modal de credenciales con clic fuera
      document.getElementById('loginCredentialsModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeLoginCredentialsModal();
        }
      });

      // Configurar eventos para cerrar modal de reclamos con clic fuera
      document.getElementById('complaintModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeComplaintModal();
        }
      });
      
      // Configurar eventos para reclamos
      document.getElementById('refreshComplaintsBtn').addEventListener('click', refreshComplaints);
      
      // Configurar eventos para configuración del sistema
      document.getElementById('saveSystemSettingsBtn').addEventListener('click', saveSystemSettings);
      document.getElementById('exportDataBtn').addEventListener('click', exportData);
      document.getElementById('importDataBtn').addEventListener('click', importData);
    });
    
    // Hacer funciones globales disponibles
    window.showLoginCredentials = showLoginCredentials;
    window.closeLoginCredentialsModal = closeLoginCredentialsModal;
    window.testResidentLogin = testResidentLogin;
    window.viewComplaint = viewComplaint;
    window.respondToComplaint = respondToComplaint;
    window.closeComplaintModal = closeComplaintModal;
    window.saveComplaintResponse = saveComplaintResponse;
    window.filterComplaints = filterComplaints;
  </script>
</body> 
</html>